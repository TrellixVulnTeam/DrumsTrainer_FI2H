{"ast":null,"code":"// abc_abstract_engraver.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nvar AbsoluteElement = require('./abc_absolute_element');\n\nvar BeamElem = require('./abc_beam_element');\n\nvar BraceElem = require('./abc_brace_element');\n\nvar createClef = require('./abc_create_clef');\n\nvar createKeySignature = require('./abc_create_key_signature');\n\nvar createTimeSignature = require('./abc_create_time_signature');\n\nvar Decoration = require('./abc_decoration');\n\nvar EndingElem = require('./abc_ending_element');\n\nvar glyphs = require('./abc_glyphs');\n\nvar RelativeElement = require('./abc_relative_element');\n\nvar spacing = require('./abc_spacing');\n\nvar StaffGroupElement = require('./abc_staff_group_element');\n\nvar TempoElement = require('./abc_tempo_element');\n\nvar TieElem = require('./abc_tie_element');\n\nvar TripletElem = require('./abc_triplet_element');\n\nvar VoiceElement = require('./abc_voice_element');\n\nvar parseCommon = require('../parse/abc_common');\n\nvar AbstractEngraver;\n\n(function () {\n  \"use strict\";\n\n  var getDuration = function (elem) {\n    var d = 0;\n\n    if (elem.duration) {\n      d = elem.duration;\n    }\n\n    return d;\n  };\n\n  var hint = false;\n  var chartable = {\n    rest: {\n      0: \"rests.whole\",\n      1: \"rests.half\",\n      2: \"rests.quarter\",\n      3: \"rests.8th\",\n      4: \"rests.16th\",\n      5: \"rests.32nd\",\n      6: \"rests.64th\",\n      7: \"rests.128th\",\n      \"multi\": \"rests.multimeasure\"\n    },\n    note: {\n      \"-1\": \"noteheads.dbl\",\n      0: \"noteheads.whole\",\n      1: \"noteheads.half\",\n      2: \"noteheads.quarter\",\n      3: \"noteheads.quarter\",\n      4: \"noteheads.quarter\",\n      5: \"noteheads.quarter\",\n      6: \"noteheads.quarter\",\n      7: \"noteheads.quarter\",\n      'nostem': \"noteheads.quarter\"\n    },\n    rhythm: {\n      \"-1\": \"noteheads.slash.whole\",\n      0: \"noteheads.slash.whole\",\n      1: \"noteheads.slash.whole\",\n      2: \"noteheads.slash.quarter\",\n      3: \"noteheads.slash.quarter\",\n      4: \"noteheads.slash.quarter\",\n      5: \"noteheads.slash.quarter\",\n      6: \"noteheads.slash.quarter\",\n      7: \"noteheads.slash.quarter\",\n      nostem: \"noteheads.slash.nostem\"\n    },\n    x: {\n      \"-1\": \"noteheads.indeterminate\",\n      0: \"noteheads.indeterminate\",\n      1: \"noteheads.indeterminate\",\n      2: \"noteheads.indeterminate\",\n      3: \"noteheads.indeterminate\",\n      4: \"noteheads.indeterminate\",\n      5: \"noteheads.indeterminate\",\n      6: \"noteheads.indeterminate\",\n      7: \"noteheads.indeterminate\",\n      nostem: \"noteheads.indeterminate\"\n    },\n    harmonic: {\n      \"-1\": \"noteheads.harmonic.quarter\",\n      0: \"noteheads.harmonic.quarter\",\n      1: \"noteheads.harmonic.quarter\",\n      2: \"noteheads.harmonic.quarter\",\n      3: \"noteheads.harmonic.quarter\",\n      4: \"noteheads.harmonic.quarter\",\n      5: \"noteheads.harmonic.quarter\",\n      6: \"noteheads.harmonic.quarter\",\n      7: \"noteheads.harmonic.quarter\",\n      nostem: \"noteheads.harmonic.quarter\"\n    },\n    uflags: {\n      3: \"flags.u8th\",\n      4: \"flags.u16th\",\n      5: \"flags.u32nd\",\n      6: \"flags.u64th\"\n    },\n    dflags: {\n      3: \"flags.d8th\",\n      4: \"flags.d16th\",\n      5: \"flags.d32nd\",\n      6: \"flags.d64th\"\n    }\n  };\n\n  AbstractEngraver = function (renderer, tuneNumber, options) {\n    this.decoration = new Decoration();\n    this.renderer = renderer;\n    this.tuneNumber = tuneNumber;\n    this.isBagpipes = options.bagpipes;\n    this.flatBeams = options.flatbeams;\n    this.reset();\n  };\n\n  AbstractEngraver.prototype.reset = function () {\n    this.slurs = {};\n    this.ties = [];\n    this.voiceScale = 1;\n    this.slursbyvoice = {};\n    this.tiesbyvoice = {};\n    this.endingsbyvoice = {};\n    this.scaleByVoice = {};\n    this.tripletmultiplier = 1;\n    this.abcline = undefined;\n    this.accidentalSlot = undefined;\n    this.accidentalshiftx = undefined;\n    this.dotshiftx = undefined;\n    this.hasVocals = false;\n    this.minY = undefined;\n    this.partstartelem = undefined;\n    this.startlimitelem = undefined;\n    this.stemdir = undefined;\n  };\n\n  AbstractEngraver.prototype.setStemHeight = function (heightInPixels) {\n    this.stemHeight = heightInPixels / spacing.STEP;\n  };\n\n  AbstractEngraver.prototype.getCurrentVoiceId = function (s, v) {\n    return \"s\" + s + \"v\" + v;\n  };\n\n  AbstractEngraver.prototype.pushCrossLineElems = function (s, v) {\n    this.slursbyvoice[this.getCurrentVoiceId(s, v)] = this.slurs;\n    this.tiesbyvoice[this.getCurrentVoiceId(s, v)] = this.ties;\n    this.endingsbyvoice[this.getCurrentVoiceId(s, v)] = this.partstartelem;\n    this.scaleByVoice[this.getCurrentVoiceId(s, v)] = this.voiceScale;\n  };\n\n  AbstractEngraver.prototype.popCrossLineElems = function (s, v) {\n    this.slurs = this.slursbyvoice[this.getCurrentVoiceId(s, v)] || {};\n    this.ties = this.tiesbyvoice[this.getCurrentVoiceId(s, v)] || [];\n    this.partstartelem = this.endingsbyvoice[this.getCurrentVoiceId(s, v)];\n    this.voiceScale = this.scaleByVoice[this.getCurrentVoiceId(s, v)];\n    if (this.voiceScale === undefined) this.voiceScale = 1;\n  };\n\n  AbstractEngraver.prototype.containsLyrics = function (staves) {\n    for (var i = 0; i < staves.length; i++) {\n      for (var j = 0; j < staves[i].voices.length; j++) {\n        for (var k = 0; k < staves[i].voices[j].length; k++) {\n          var el = staves[i].voices[j][k];\n\n          if (el.lyric) {\n            // We just want to see if there are vocals below the music to know where to put the dynamics.\n            if (!el.positioning || el.positioning.vocalPosition === 'below') this.hasVocals = true;\n            return;\n          }\n        }\n      }\n    }\n  };\n\n  AbstractEngraver.prototype.createABCLine = function (staffs, tempo) {\n    this.minY = 2; // PER: This will be the lowest that any note reaches. It will be used to set the dynamics row.\n    // See if there are any lyrics on this line.\n\n    this.containsLyrics(staffs);\n    var staffgroup = new StaffGroupElement();\n    this.tempoSet = false;\n\n    for (var s = 0; s < staffs.length; s++) {\n      if (hint) this.restoreState();\n      hint = false;\n      this.createABCStaff(staffgroup, staffs[s], tempo, s);\n    }\n\n    return staffgroup;\n  };\n\n  AbstractEngraver.prototype.createABCStaff = function (staffgroup, abcstaff, tempo, s) {\n    // If the tempo is passed in, then the first element should get the tempo attached to it.\n    for (var v = 0; v < abcstaff.voices.length; v++) {\n      var voice = new VoiceElement(v, abcstaff.voices.length);\n\n      if (v === 0) {\n        voice.barfrom = abcstaff.connectBarLines === \"start\" || abcstaff.connectBarLines === \"continue\";\n        voice.barto = abcstaff.connectBarLines === \"continue\" || abcstaff.connectBarLines === \"end\";\n      } else {\n        voice.duplicate = true; // bar lines and other duplicate info need not be created\n      }\n\n      if (abcstaff.title && abcstaff.title[v]) voice.header = abcstaff.title[v];\n      var clef = createClef(abcstaff.clef, this.tuneNumber);\n\n      if (clef) {\n        if (v === 0 && abcstaff.barNumber) {\n          this.addMeasureNumber(abcstaff.barNumber, clef);\n        }\n\n        voice.addChild(clef);\n      }\n\n      var keySig = createKeySignature(abcstaff.key, this.tuneNumber);\n\n      if (keySig) {\n        voice.addChild(keySig);\n        this.startlimitelem = keySig; // limit ties here\n      }\n\n      if (abcstaff.meter) {\n        if (abcstaff.meter.type === 'specified') {\n          this.measureLength = abcstaff.meter.value[0].num / abcstaff.meter.value[0].den;\n        } else this.measureLength = 1;\n\n        var ts = createTimeSignature(abcstaff.meter, this.tuneNumber);\n        voice.addChild(ts);\n        this.startlimitelem = ts; // limit ties here\n      }\n\n      if (voice.duplicate) voice.children = []; // we shouldn't reprint the above if we're reusing the same staff. We just created them to get the right spacing.\n\n      var staffLines = abcstaff.clef.stafflines || abcstaff.clef.stafflines === 0 ? abcstaff.clef.stafflines : 5;\n      staffgroup.addVoice(voice, s, staffLines);\n      var isSingleLineStaff = staffLines === 1;\n      this.createABCVoice(abcstaff.voices[v], tempo, s, v, isSingleLineStaff, voice);\n      staffgroup.setStaffLimits(voice); //Tony: Here I am following what staves need to be surrounded by the brace, by incrementing the length of the brace class.\n      //So basically this keeps incrementing the number of staff surrounded by the brace until it sees \"end\".\n      //This then gets processed in abc_staff_group_element.js, so that it will have the correct top and bottom coordinates for the brace.\n\n      if (abcstaff.brace === \"start\") {\n        staffgroup.brace = new BraceElem(1, true);\n      } else if (abcstaff.brace === \"end\" && staffgroup.brace) {\n        staffgroup.brace.increaseStavesIncluded();\n      } else if (abcstaff.brace === \"continue\" && staffgroup.brace) {\n        staffgroup.brace.increaseStavesIncluded();\n      }\n    }\n  };\n\n  function getBeamGroup(abcline, pos) {\n    // If there are notes beamed together, they are handled as a group, so find all of them here.\n    var elem = abcline[pos];\n    if (elem.el_type !== 'note' || !elem.startBeam || elem.endBeam) return {\n      count: 1,\n      elem: elem\n    };\n    var group = [];\n\n    while (pos < abcline.length && abcline[pos].el_type === 'note') {\n      group.push(abcline[pos]);\n      if (abcline[pos].endBeam) break;\n      pos++;\n    }\n\n    return {\n      count: group.length,\n      elem: group\n    };\n  }\n\n  AbstractEngraver.prototype.createABCVoice = function (abcline, tempo, s, v, isSingleLineStaff, voice) {\n    this.popCrossLineElems(s, v);\n    this.stemdir = this.isBagpipes ? \"down\" : null;\n    this.abcline = abcline;\n\n    if (this.partstartelem) {\n      this.partstartelem = new EndingElem(\"\", null, null);\n      voice.addOther(this.partstartelem);\n    }\n\n    var voiceNumber = voice.voicetotal < 2 ? -1 : voice.voicenumber;\n\n    for (var slur in this.slurs) {\n      if (this.slurs.hasOwnProperty(slur)) {\n        // this is already a slur element, but it was created for the last line, so recreate it.\n        this.slurs[slur] = new TieElem({\n          force: this.slurs[slur].force,\n          voiceNumber: voiceNumber,\n          stemDir: this.slurs[slur].stemDir\n        });\n        if (hint) this.slurs[slur].setHint();\n        voice.addOther(this.slurs[slur]);\n      }\n    }\n\n    for (var i = 0; i < this.ties.length; i++) {\n      // this is already a tie element, but it was created for the last line, so recreate it.\n      this.ties[i] = new TieElem({\n        force: this.ties[i].force,\n        stemDir: this.ties[i].stemDir,\n        voiceNumber: voiceNumber\n      });\n      if (hint) this.ties[i].setHint();\n      voice.addOther(this.ties[i]);\n    }\n\n    for (var j = 0; j < this.abcline.length; j++) {\n      setAveragePitch(this.abcline[j]);\n      this.minY = Math.min(this.abcline[j].minpitch, this.minY);\n    }\n\n    var isFirstStaff = s === 0;\n    var pos = 0;\n\n    while (pos < this.abcline.length) {\n      var ret = getBeamGroup(this.abcline, pos);\n      var abselems = this.createABCElement(isFirstStaff, isSingleLineStaff, voice, ret.elem);\n\n      if (abselems) {\n        for (i = 0; i < abselems.length; i++) {\n          if (!this.tempoSet && tempo && !tempo.suppress) {\n            this.tempoSet = true;\n            var tempoElement = new AbsoluteElement(ret.elem, 0, 0, \"tempo\", this.tuneNumber, {});\n            tempoElement.addChild(new TempoElement(tempo, this.tuneNumber, createNoteHead));\n            voice.addChild(tempoElement);\n          }\n\n          voice.addChild(abselems[i]);\n        }\n      }\n\n      pos += ret.count;\n    }\n\n    this.pushCrossLineElems(s, v);\n  };\n\n  AbstractEngraver.prototype.saveState = function () {\n    this.tiesSave = parseCommon.cloneArray(this.ties);\n    this.slursSave = parseCommon.cloneHashOfHash(this.slurs);\n    this.slursbyvoiceSave = parseCommon.cloneHashOfHash(this.slursbyvoice);\n    this.tiesbyvoiceSave = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoice);\n  };\n\n  AbstractEngraver.prototype.restoreState = function () {\n    this.ties = parseCommon.cloneArray(this.tiesSave);\n    this.slurs = parseCommon.cloneHashOfHash(this.slursSave);\n    this.slursbyvoice = parseCommon.cloneHashOfHash(this.slursbyvoiceSave);\n    this.tiesbyvoice = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoiceSave);\n  }; // function writeMeasureWidth(voice) {\n  // \tvar width = 0;\n  // \tfor (var i = voice.children.length-1; i >= 0; i--) {\n  // \t\tvar elem = voice.children[i];\n  // \t\tif (elem.abcelem.el_type === 'bar')\n  // \t\t\tbreak;\n  // \t\twidth += elem.w;\n  // \t}\n  // \treturn new RelativeElement(width.toFixed(2), -70, 0, undefined, {type:\"debug\"});\n  // }\n  // return an array of AbsoluteElement\n\n\n  AbstractEngraver.prototype.createABCElement = function (isFirstStaff, isSingleLineStaff, voice, elem) {\n    var elemset = [];\n\n    switch (elem.el_type) {\n      case undefined:\n        // it is undefined if we were passed an array in - an array means a set of notes that should be beamed together.\n        elemset = this.createBeam(isSingleLineStaff, voice, elem);\n        break;\n\n      case \"note\":\n        elemset[0] = this.createNote(elem, false, isSingleLineStaff, voice);\n\n        if (this.triplet && this.triplet.isClosed()) {\n          voice.addOther(this.triplet);\n          this.triplet = null;\n          this.tripletmultiplier = 1;\n        }\n\n        break;\n\n      case \"bar\":\n        elemset[0] = this.createBarLine(voice, elem, isFirstStaff);\n        if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true; //\t  elemset[0].addChild(writeMeasureWidth(voice));\n\n        break;\n\n      case \"meter\":\n        elemset[0] = createTimeSignature(elem, this.tuneNumber);\n        this.startlimitelem = elemset[0]; // limit ties here\n\n        if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"clef\":\n        elemset[0] = createClef(elem, this.tuneNumber);\n        if (!elemset[0]) return null;\n        if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"key\":\n        var absKey = createKeySignature(elem, this.tuneNumber);\n\n        if (absKey) {\n          elemset[0] = absKey;\n          this.startlimitelem = elemset[0]; // limit ties here\n        }\n\n        if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"stem\":\n        this.stemdir = elem.direction;\n        break;\n\n      case \"part\":\n        var abselem = new AbsoluteElement(elem, 0, 0, 'part', this.tuneNumber);\n        var dim = this.renderer.getTextSize(elem.title, 'partsfont', \"part\");\n        abselem.addChild(new RelativeElement(elem.title, 0, 0, undefined, {\n          type: \"part\",\n          height: dim.height / spacing.STEP\n        }));\n        elemset[0] = abselem;\n        break;\n\n      case \"tempo\":\n        var abselem3 = new AbsoluteElement(elem, 0, 0, 'tempo', this.tuneNumber);\n        abselem3.addChild(new TempoElement(elem, this.tuneNumber, createNoteHead));\n        elemset[0] = abselem3;\n        break;\n\n      case \"style\":\n        if (elem.head === \"normal\") delete this.style;else this.style = elem.head;\n        break;\n\n      case \"hint\":\n        hint = true;\n        this.saveState();\n        break;\n\n      case \"midi\":\n        // This has no effect on the visible music, so just skip it.\n        break;\n\n      case \"scale\":\n        this.voiceScale = elem.size;\n        break;\n\n      default:\n        var abselem2 = new AbsoluteElement(elem, 0, 0, 'unsupported', this.tuneNumber);\n        abselem2.addChild(new RelativeElement(\"element type \" + elem.el_type, 0, 0, undefined, {\n          type: \"debug\"\n        }));\n        elemset[0] = abselem2;\n    }\n\n    return elemset;\n  };\n\n  function setAveragePitch(elem) {\n    if (elem.pitches) {\n      sortPitch(elem);\n      var sum = 0;\n\n      for (var p = 0; p < elem.pitches.length; p++) {\n        sum += elem.pitches[p].verticalPos;\n      }\n\n      elem.averagepitch = sum / elem.pitches.length;\n      elem.minpitch = elem.pitches[0].verticalPos;\n      elem.maxpitch = elem.pitches[elem.pitches.length - 1].verticalPos;\n    }\n  }\n\n  AbstractEngraver.prototype.calcBeamDir = function (isSingleLineStaff, voice, elems) {\n    if (this.stemdir) // If the user or voice is forcing the stem direction, we already know the answer.\n      return this.stemdir;\n    var beamelem = new BeamElem(this.stemHeight * this.voiceScale, this.stemdir, this.flatBeams);\n\n    for (var i = 0; i < elems.length; i++) {\n      beamelem.add({\n        abcelem: elems[i]\n      }); // This is a hack to call beam elem with just a minimum of processing: for our purposes, we don't need to construct the whole note.\n    }\n\n    var dir = beamelem.calcDir();\n    return dir ? \"up\" : \"down\";\n  };\n\n  AbstractEngraver.prototype.createBeam = function (isSingleLineStaff, voice, elems) {\n    var abselemset = [];\n    var dir = this.calcBeamDir(isSingleLineStaff, voice, elems);\n    var beamelem = new BeamElem(this.stemHeight * this.voiceScale, dir, this.flatBeams);\n    if (hint) beamelem.setHint();\n    var oldDir = this.stemdir;\n    this.stemdir = dir;\n\n    for (var i = 0; i < elems.length; i++) {\n      var elem = elems[i];\n      var abselem = this.createNote(elem, true, isSingleLineStaff, voice);\n      abselemset.push(abselem);\n      beamelem.add(abselem);\n\n      if (this.triplet && this.triplet.isClosed()) {\n        voice.addOther(this.triplet);\n        this.triplet = null;\n        this.tripletmultiplier = 1;\n      }\n    }\n\n    this.stemdir = oldDir;\n    voice.addBeam(beamelem);\n    return abselemset;\n  };\n\n  var sortPitch = function (elem) {\n    var sorted;\n\n    do {\n      sorted = true;\n\n      for (var p = 0; p < elem.pitches.length - 1; p++) {\n        if (elem.pitches[p].pitch > elem.pitches[p + 1].pitch) {\n          sorted = false;\n          var tmp = elem.pitches[p];\n          elem.pitches[p] = elem.pitches[p + 1];\n          elem.pitches[p + 1] = tmp;\n        }\n      }\n    } while (!sorted);\n  };\n\n  var ledgerLines = function (abselem, minPitch, maxPitch, isRest, symbolWidth, additionalLedgers, dir, dx, scale) {\n    for (var i = maxPitch; i > 11; i--) {\n      if (i % 2 === 0 && !isRest) {\n        abselem.addChild(new RelativeElement(null, dx, (symbolWidth + 4) * scale, i, {\n          type: \"ledger\"\n        }));\n      }\n    }\n\n    for (i = minPitch; i < 1; i++) {\n      if (i % 2 === 0 && !isRest) {\n        abselem.addChild(new RelativeElement(null, dx, (symbolWidth + 4) * scale, i, {\n          type: \"ledger\"\n        }));\n      }\n    }\n\n    for (i = 0; i < additionalLedgers.length; i++) {\n      // PER: draw additional ledgers\n      var ofs = symbolWidth;\n      if (dir === 'down') ofs = -ofs;\n      abselem.addChild(new RelativeElement(null, ofs + dx, (symbolWidth + 4) * scale, additionalLedgers[i], {\n        type: \"ledger\"\n      }));\n    }\n  };\n\n  AbstractEngraver.prototype.addGraceNotes = function (elem, voice, abselem, notehead, stemHeight, isBagpipes, roomtaken) {\n    var gracescale = 3 / 5;\n    var graceScaleStem = 3.5 / 5; // TODO-PER: empirically found constant.\n\n    var gracebeam = null;\n    var flag;\n\n    if (elem.gracenotes.length > 1) {\n      gracebeam = new BeamElem(stemHeight * graceScaleStem, \"grace\", isBagpipes);\n      if (hint) gracebeam.setHint();\n      gracebeam.mainNote = abselem; // this gives us a reference back to the note this is attached to so that the stems can be attached somewhere.\n    }\n\n    var graceoffsets = [];\n\n    for (i = elem.gracenotes.length - 1; i >= 0; i--) {\n      // figure out where to place each gracenote\n      roomtaken += 10;\n      graceoffsets[i] = roomtaken;\n\n      if (elem.gracenotes[i].accidental) {\n        roomtaken += 7;\n      }\n    }\n\n    var i;\n\n    for (i = 0; i < elem.gracenotes.length; i++) {\n      var gracepitch = elem.gracenotes[i].verticalPos;\n      flag = gracebeam ? null : chartable.uflags[isBagpipes ? 5 : 3];\n      var accidentalSlot = [];\n      var ret = createNoteHead(abselem, \"noteheads.quarter\", elem.gracenotes[i], \"up\", -graceoffsets[i], -graceoffsets[i], flag, 0, 0, gracescale * this.voiceScale, accidentalSlot, false);\n      ret.notehead.highestVert = ret.notehead.pitch + stemHeight * graceScaleStem;\n      var grace = ret.notehead;\n      this.addSlursAndTies(abselem, elem.gracenotes[i], grace, voice, \"up\", true);\n      abselem.addExtra(grace); // PER: added acciaccatura slash\n\n      if (elem.gracenotes[i].acciaccatura) {\n        var pos = elem.gracenotes[i].verticalPos + 7 * gracescale; // the same formula that determines the flag position.\n\n        var dAcciaccatura = gracebeam ? 5 : 6; // just an offset to make it line up correctly.\n\n        abselem.addRight(new RelativeElement(\"flags.ugrace\", -graceoffsets[i] + dAcciaccatura, 0, pos, {\n          scalex: gracescale,\n          scaley: gracescale\n        }));\n      }\n\n      if (gracebeam) {\n        // give the beam the necessary info\n        var graceDuration = elem.gracenotes[i].duration / 2;\n        if (isBagpipes) graceDuration /= 2;\n        var pseudoabselem = {\n          heads: [grace],\n          abcelem: {\n            averagepitch: gracepitch,\n            minpitch: gracepitch,\n            maxpitch: gracepitch,\n            duration: graceDuration\n          }\n        };\n        gracebeam.add(pseudoabselem);\n      } else {\n        // draw the stem\n        var p1 = gracepitch + 1 / 3 * gracescale;\n        var p2 = gracepitch + 7 * gracescale;\n        var dx = grace.dx + grace.w;\n        var width = -0.6;\n        abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\n          \"type\": \"stem\",\n          \"pitch2\": p2,\n          linewidth: width\n        }));\n      }\n\n      ledgerLines(abselem, gracepitch, gracepitch, false, glyphs.getSymbolWidth(\"noteheads.quarter\"), [], true, grace.dx - 1, 0.6);\n\n      if (i === 0 && !isBagpipes && !(elem.rest && (elem.rest.type === \"spacer\" || elem.rest.type === \"invisible\"))) {\n        // This is the overall slur that is under the grace notes.\n        var isTie = elem.gracenotes.length === 1 && grace.pitch === notehead.pitch;\n        voice.addOther(new TieElem({\n          anchor1: grace,\n          anchor2: notehead,\n          isGrace: true\n        }));\n      }\n    }\n\n    if (gracebeam) {\n      voice.addBeam(gracebeam);\n    }\n\n    return roomtaken;\n  };\n\n  function addRestToAbsElement(abselem, elem, duration, dot, isMultiVoice, stemdir, isSingleLineStaff, durlog, voiceScale) {\n    var c;\n    var restpitch = 7;\n    var noteHead;\n    var roomTaken;\n    var roomTakenRight;\n\n    if (isMultiVoice) {\n      if (stemdir === \"down\") restpitch = 3;\n      if (stemdir === \"up\") restpitch = 11;\n    } // There is special placement for the percussion staff. If there is one staff line, then move the rest position.\n\n\n    if (isSingleLineStaff) {\n      // The half and whole rests are attached to different lines normally, so we need to tweak their position to get them to both be attached to the same one.\n      if (duration < 0.5) restpitch = 7;else if (duration < 1) restpitch = 7; // half rest\n      else restpitch = 5; // whole rest\n    }\n\n    switch (elem.rest.type) {\n      case \"whole\":\n        c = chartable.rest[0];\n        elem.averagepitch = restpitch;\n        elem.minpitch = restpitch;\n        elem.maxpitch = restpitch;\n        dot = 0;\n        break;\n\n      case \"rest\":\n        if (elem.style === \"rhythm\") // special case for rhythm: rests are a handy way to express the rhythm.\n          c = chartable.rhythm[-durlog];else c = chartable.rest[-durlog];\n        elem.averagepitch = restpitch;\n        elem.minpitch = restpitch;\n        elem.maxpitch = restpitch;\n        break;\n\n      case \"invisible\":\n      case \"spacer\":\n        c = \"\";\n        elem.averagepitch = restpitch;\n        elem.minpitch = restpitch;\n        elem.maxpitch = restpitch;\n        break;\n\n      case \"multimeasure\":\n        c = chartable.rest['multi'];\n        elem.averagepitch = restpitch;\n        elem.minpitch = restpitch;\n        elem.maxpitch = restpitch;\n        dot = 0;\n        var mmWidth = glyphs.getSymbolWidth(c);\n        abselem.addHead(new RelativeElement(c, -mmWidth, mmWidth * 2, 7));\n        var numMeasures = new RelativeElement(\"\" + elem.duration, 0, mmWidth, 16, {\n          type: \"multimeasure-text\"\n        });\n        abselem.addExtra(numMeasures);\n    }\n\n    if (elem.rest.type !== \"multimeasure\") {\n      var ret = createNoteHead(abselem, c, {\n        verticalPos: restpitch\n      }, null, 0, 0, null, dot, 0, voiceScale, [], false);\n      noteHead = ret.notehead;\n\n      if (noteHead) {\n        abselem.addHead(noteHead);\n        roomTaken = ret.accidentalshiftx;\n        roomTakenRight = ret.dotshiftx;\n      }\n    }\n\n    return {\n      noteHead: noteHead,\n      roomTaken: roomTaken,\n      roomTakenRight: roomTakenRight\n    };\n  }\n\n  function addIfNotExist(arr, item) {\n    for (var i = 0; i < arr.length; i++) {\n      if (JSON.stringify(arr[i]) === JSON.stringify(item)) return;\n    }\n\n    arr.push(item);\n  }\n\n  AbstractEngraver.prototype.addNoteToAbcElement = function (abselem, elem, dot, stemdir, style, zeroDuration, durlog, nostem, voice) {\n    var dotshiftx = 0; // room taken by chords with displaced noteheads which cause dots to shift\n\n    var noteHead;\n    var roomTaken = 0;\n    var roomTakenRight = 0;\n    var min;\n    var i;\n    var additionalLedgers = []; // The accidentalSlot will hold a list of all the accidentals on this chord. Each element is a vertical place,\n    // and contains a pitch, which is the last pitch that contains an accidental in that slot. The slots are numbered\n    // from closest to the note to farther left. We only need to know the last accidental we placed because\n    // we know that the pitches are sorted by now.\n\n    var accidentalSlot = [];\n    var symbolWidth = 0;\n    var dir = elem.averagepitch >= 6 ? \"down\" : \"up\";\n    if (stemdir) dir = stemdir;\n    style = elem.style ? elem.style : style; // get the style of note head.\n\n    if (!style || style === \"normal\") style = \"note\";\n    var noteSymbol;\n    if (zeroDuration) noteSymbol = chartable[style].nostem;else noteSymbol = chartable[style][-durlog];\n    if (!noteSymbol) console.log(\"noteSymbol:\", style, durlog, zeroDuration); // determine elements of chords which should be shifted\n\n    var p;\n\n    for (p = dir === \"down\" ? elem.pitches.length - 2 : 1; dir === \"down\" ? p >= 0 : p < elem.pitches.length; p = dir === \"down\" ? p - 1 : p + 1) {\n      var prev = elem.pitches[dir === \"down\" ? p + 1 : p - 1];\n      var curr = elem.pitches[p];\n      var delta = dir === \"down\" ? prev.pitch - curr.pitch : curr.pitch - prev.pitch;\n\n      if (delta <= 1 && !prev.printer_shift) {\n        curr.printer_shift = delta ? \"different\" : \"same\";\n\n        if (curr.verticalPos > 11 || curr.verticalPos < 1) {\n          // PER: add extra ledger line\n          additionalLedgers.push(curr.verticalPos - curr.verticalPos % 2);\n        }\n\n        if (dir === \"down\") {\n          roomTaken = glyphs.getSymbolWidth(noteSymbol) + 2;\n        } else {\n          dotshiftx = glyphs.getSymbolWidth(noteSymbol) + 2;\n        }\n      }\n    }\n\n    var pp = elem.pitches.length;\n\n    for (p = 0; p < elem.pitches.length; p++) {\n      if (!nostem) {\n        var flag;\n\n        if (dir === \"down\" && p !== 0 || dir === \"up\" && p !== pp - 1) {\n          // not the stemmed elem of the chord\n          flag = null;\n        } else {\n          flag = chartable[dir === \"down\" ? \"dflags\" : \"uflags\"][-durlog];\n        }\n      }\n\n      var c;\n\n      if (elem.pitches[p].style) {\n        // There is a style for the whole group of pitches, but there could also be an override for a particular pitch.\n        c = chartable[elem.pitches[p].style][-durlog];\n      } else c = noteSymbol; // The highest position for the sake of placing slurs is itself if the slur is internal. It is the highest position possible if the slur is for the whole chord.\n      // If the note is the only one in the chord, then any slur it has counts as if it were on the whole chord.\n\n\n      elem.pitches[p].highestVert = elem.pitches[p].verticalPos;\n      var isTopWhenStemIsDown = (stemdir === \"up\" || dir === \"up\") && p === 0;\n      var isBottomWhenStemIsUp = (stemdir === \"down\" || dir === \"down\") && p === pp - 1;\n\n      if (isTopWhenStemIsDown || isBottomWhenStemIsUp) {\n        // place to put slurs if not already on pitches\n        if (elem.startSlur || pp === 1) {\n          elem.pitches[p].highestVert = elem.pitches[pp - 1].verticalPos;\n          if (getDuration(elem) < 1 && (stemdir === \"up\" || dir === \"up\")) elem.pitches[p].highestVert += 6; // If the stem is up, then compensate for the length of the stem\n        }\n\n        if (elem.startSlur) {\n          if (!elem.pitches[p].startSlur) elem.pitches[p].startSlur = []; //TODO possibly redundant, provided array is not optional\n\n          for (i = 0; i < elem.startSlur.length; i++) {\n            addIfNotExist(elem.pitches[p].startSlur, elem.startSlur[i]);\n          }\n        }\n\n        if (elem.endSlur) {\n          elem.pitches[p].highestVert = elem.pitches[pp - 1].verticalPos;\n          if (getDuration(elem) < 1 && (stemdir === \"up\" || dir === \"up\")) elem.pitches[p].highestVert += 6; // If the stem is up, then compensate for the length of the stem\n\n          if (!elem.pitches[p].endSlur) elem.pitches[p].endSlur = []; //TODO possibly redundant, provided array is not optional\n\n          for (i = 0; i < elem.endSlur.length; i++) {\n            addIfNotExist(elem.pitches[p].endSlur, elem.endSlur[i]);\n          }\n        }\n      }\n\n      var hasStem = !nostem && durlog <= -1;\n      var ret = createNoteHead(abselem, c, elem.pitches[p], dir, 0, -roomTaken, flag, dot, dotshiftx, this.voiceScale, accidentalSlot, !stemdir);\n      symbolWidth = Math.max(glyphs.getSymbolWidth(c), symbolWidth);\n      abselem.extraw -= ret.extraLeft;\n      noteHead = ret.notehead;\n\n      if (noteHead) {\n        this.addSlursAndTies(abselem, elem.pitches[p], noteHead, voice, hasStem ? dir : null, false);\n        if (elem.gracenotes && elem.gracenotes.length > 0) noteHead.bottom = noteHead.bottom - 1; // If there is a tie to the grace notes, leave a little more room for the note to avoid collisions.\n\n        abselem.addHead(noteHead);\n      }\n\n      roomTaken += ret.accidentalshiftx;\n      roomTakenRight = Math.max(roomTakenRight, ret.dotshiftx);\n    } // draw stem from the furthest note to a pitch above/below the stemmed note\n\n\n    if (hasStem) {\n      var stemHeight = 7 * this.voiceScale;\n      var p1 = dir === \"down\" ? elem.minpitch - stemHeight : elem.minpitch + 1 / 3; // PER added stemdir test to make the line meet the note.\n\n      if (p1 > 6 && !stemdir) p1 = 6;\n      var p2 = dir === \"down\" ? elem.maxpitch - 1 / 3 : elem.maxpitch + stemHeight; // PER added stemdir test to make the line meet the note.\n\n      if (p2 < 6 && !stemdir) p2 = 6;\n      var dx = dir === \"down\" || abselem.heads.length === 0 ? 0 : abselem.heads[0].w;\n      var width = dir === \"down\" ? 1 : -1; // TODO-PER-HACK: One type of note head has a different placement of the stem. This should be more generically calculated:\n\n      if (noteHead.c === 'noteheads.slash.quarter') {\n        if (dir === 'down') p2 -= 1;else p1 += 1;\n      }\n\n      abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\n        \"type\": \"stem\",\n        \"pitch2\": p2,\n        linewidth: width\n      })); //var RelativeElement = function RelativeElement(c, dx, w, pitch, opt) {\n\n      min = Math.min(p1, p2);\n    }\n\n    return {\n      noteHead: noteHead,\n      roomTaken: roomTaken,\n      roomTakenRight: roomTakenRight,\n      min: min,\n      additionalLedgers: additionalLedgers,\n      dir: dir,\n      symbolWidth: symbolWidth\n    };\n  };\n\n  AbstractEngraver.prototype.addLyric = function (abselem, elem) {\n    var lyricStr = \"\";\n    parseCommon.each(elem.lyric, function (ly) {\n      var div = ly.divider === ' ' ? \"\" : ly.divider;\n      lyricStr += ly.syllable + div + \"\\n\";\n    });\n    var lyricDim = this.renderer.getTextSize(lyricStr, 'vocalfont', \"lyric\");\n    var position = elem.positioning ? elem.positioning.vocalPosition : 'below';\n    abselem.addCentered(new RelativeElement(lyricStr, 0, lyricDim.width, undefined, {\n      type: \"lyric\",\n      position: position,\n      height: lyricDim.height / spacing.STEP\n    }));\n  };\n\n  AbstractEngraver.prototype.addChord = function (abselem, elem, roomTaken, roomTakenRight) {\n    var chordMargin = 8; // If there are chords next to each other, this is how close they can get.\n\n    for (var i = 0; i < elem.chord.length; i++) {\n      var x = 0;\n      var y;\n      var dim = this.renderer.getTextSize(elem.chord[i].name, 'annotationfont', \"annotation\");\n      var chordWidth = dim.width;\n      var chordHeight = dim.height / spacing.STEP;\n\n      switch (elem.chord[i].position) {\n        case \"left\":\n          roomTaken += chordWidth + 7;\n          x = -roomTaken; // TODO-PER: This is just a guess from trial and error\n\n          y = elem.averagepitch;\n          abselem.addExtra(new RelativeElement(elem.chord[i].name, x, chordWidth + 4, y, {\n            type: \"text\",\n            height: chordHeight\n          }));\n          break;\n\n        case \"right\":\n          roomTakenRight += 4;\n          x = roomTakenRight; // TODO-PER: This is just a guess from trial and error\n\n          y = elem.averagepitch;\n          abselem.addRight(new RelativeElement(elem.chord[i].name, x, chordWidth + 4, y, {\n            type: \"text\",\n            height: chordHeight\n          }));\n          break;\n\n        case \"below\":\n          // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n          abselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth + chordMargin, undefined, {\n            type: \"text\",\n            position: \"below\",\n            height: chordHeight\n          }));\n          break;\n\n        case \"above\":\n          // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n          abselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth + chordMargin, undefined, {\n            type: \"text\",\n            height: chordHeight\n          }));\n          break;\n\n        default:\n          if (elem.chord[i].rel_position) {\n            var relPositionY = elem.chord[i].rel_position.y + 3 * spacing.STEP; // TODO-PER: this is a fudge factor to make it line up with abcm2ps\n\n            abselem.addChild(new RelativeElement(elem.chord[i].name, x + elem.chord[i].rel_position.x, 0, elem.minpitch + relPositionY / spacing.STEP, {\n              type: \"text\",\n              height: chordHeight\n            }));\n          } else {\n            // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n            var pos2 = 'above';\n            if (elem.positioning && elem.positioning.chordPosition) pos2 = elem.positioning.chordPosition;\n            dim = this.renderer.getTextSize(elem.chord[i].name, 'gchordfont', \"chord\");\n            chordHeight = dim.height / spacing.STEP;\n            chordWidth = dim.width; // Since the chord is centered, we only use half the width.\n\n            abselem.addCentered(new RelativeElement(elem.chord[i].name, x, chordWidth, undefined, {\n              type: \"chord\",\n              position: pos2,\n              height: chordHeight\n            }));\n          }\n\n      }\n    }\n\n    return {\n      roomTaken: roomTaken,\n      roomTakenRight: roomTakenRight\n    };\n  };\n\n  AbstractEngraver.prototype.createNote = function (elem, nostem, isSingleLineStaff, voice) {\n    //stem presence: true for drawing stemless notehead\n    var notehead = null;\n    var roomtaken = 0; // room needed to the left of the note\n\n    var roomtakenright = 0; // room needed to the right of the note\n\n    var symbolWidth = 0;\n    var additionalLedgers = []; // PER: handle the case of [bc'], where the b doesn't have a ledger line\n\n    var i;\n    var dir;\n    var duration = getDuration(elem);\n    var zeroDuration = false;\n\n    if (duration === 0) {\n      zeroDuration = true;\n      duration = 0.25;\n      nostem = true;\n    } //PER: zero duration will draw a quarter note head.\n\n\n    var durlog = Math.floor(Math.log(duration) / Math.log(2)); //TODO use getDurlog\n\n    var dot = 0;\n\n    for (var tot = Math.pow(2, durlog), inc = tot / 2; tot < duration; dot++, tot += inc, inc /= 2);\n\n    if (elem.startTriplet) {\n      this.tripletmultiplier = elem.tripletMultiplier;\n    }\n\n    var durationForSpacing = duration * this.tripletmultiplier;\n    if (elem.rest && elem.rest.type === 'multimeasure') durationForSpacing = 1;\n    var absType = elem.rest ? \"rest\" : \"note\";\n    var abselem = new AbsoluteElement(elem, durationForSpacing, 1, absType, this.tuneNumber, {\n      durationClassOveride: elem.duration * this.tripletmultiplier\n    });\n    if (hint) abselem.setHint();\n\n    if (elem.rest) {\n      if (this.measureLength === duration && elem.rest.type !== 'invisible' && elem.rest.type !== 'spacer') elem.rest.type = 'whole'; // If the rest is exactly a measure, always use a whole rest\n\n      var ret1 = addRestToAbsElement(abselem, elem, duration, dot, voice.voicetotal > 1, this.stemdir, isSingleLineStaff, durlog, this.voiceScale);\n      notehead = ret1.noteHead;\n      roomtaken = ret1.roomTaken;\n      roomtakenright = ret1.roomTakenRight;\n    } else {\n      var ret2 = this.addNoteToAbcElement(abselem, elem, dot, this.stemdir, this.style, zeroDuration, durlog, nostem, voice);\n      if (ret2.min !== undefined) this.minY = Math.min(ret2.min, this.minY);\n      notehead = ret2.noteHead;\n      roomtaken = ret2.roomTaken;\n      roomtakenright = ret2.roomTakenRight;\n      additionalLedgers = ret2.additionalLedgers;\n      dir = ret2.dir;\n      symbolWidth = ret2.symbolWidth;\n    }\n\n    if (elem.lyric !== undefined) {\n      this.addLyric(abselem, elem);\n    }\n\n    if (elem.gracenotes !== undefined) {\n      roomtaken += this.addGraceNotes(elem, voice, abselem, notehead, this.stemHeight * this.voiceScale, this.isBagpipes, roomtaken);\n    }\n\n    if (elem.decoration) {\n      this.decoration.createDecoration(voice, elem.decoration, abselem.top, notehead ? notehead.w : 0, abselem, roomtaken, dir, abselem.bottom, elem.positioning, this.hasVocals);\n    }\n\n    if (elem.barNumber) {\n      abselem.addChild(new RelativeElement(elem.barNumber, -10, 0, 0, {\n        type: \"barNumber\"\n      }));\n    } // ledger lines\n\n\n    ledgerLines(abselem, elem.minpitch, elem.maxpitch, elem.rest, symbolWidth, additionalLedgers, dir, -2, 1);\n\n    if (elem.chord !== undefined) {\n      var ret3 = this.addChord(abselem, elem, roomtaken, roomtakenright);\n      roomtaken = ret3.roomTaken;\n      roomtakenright = ret3.roomTakenRight;\n    }\n\n    if (elem.startTriplet) {\n      this.triplet = new TripletElem(elem.startTriplet, notehead, {\n        flatBeams: this.flatBeams\n      }); // above is opposite from case of slurs\n    }\n\n    if (elem.endTriplet && this.triplet) {\n      this.triplet.setCloseAnchor(notehead);\n    }\n\n    if (this.triplet && !elem.startTriplet && !elem.endTriplet) {\n      this.triplet.middleNote(notehead);\n    }\n\n    return abselem;\n  };\n\n  var createNoteHead = function (abselem, c, pitchelem, dir, headx, extrax, flag, dot, dotshiftx, scale, accidentalSlot, shouldExtendStem) {\n    // TODO scale the dot as well\n    var pitch = pitchelem.verticalPos;\n    var notehead;\n    var i;\n    var accidentalshiftx = 0;\n    var newDotShiftX = 0;\n    var extraLeft = 0;\n    if (c === undefined) abselem.addChild(new RelativeElement(\"pitch is undefined\", 0, 0, 0, {\n      type: \"debug\"\n    }));else if (c === \"\") {\n      notehead = new RelativeElement(null, 0, 0, pitch);\n    } else {\n      var shiftheadx = headx;\n\n      if (pitchelem.printer_shift) {\n        var adjust = pitchelem.printer_shift === \"same\" ? 1 : 0;\n        shiftheadx = dir === \"down\" ? -glyphs.getSymbolWidth(c) * scale + adjust : glyphs.getSymbolWidth(c) * scale - adjust;\n      }\n\n      var opts = {\n        scalex: scale,\n        scaley: scale,\n        thickness: glyphs.symbolHeightInPitches(c) * scale\n      };\n      notehead = new RelativeElement(c, shiftheadx, glyphs.getSymbolWidth(c) * scale, pitch, opts);\n      notehead.stemDir = dir;\n\n      if (flag) {\n        var pos = pitch + (dir === \"down\" ? -7 : 7) * scale; // if this is a regular note, (not grace or tempo indicator) then the stem will have been stretched to the middle line if it is far from the center.\n\n        if (shouldExtendStem) {\n          if (dir === \"down\" && pos > 6) pos = 6;\n          if (dir === \"up\" && pos < 6) pos = 6;\n        } //if (scale===1 && (dir===\"down\")?(pos>6):(pos<6)) pos=6;\n\n\n        var xdelta = dir === \"down\" ? headx : headx + notehead.w - 0.6;\n        abselem.addRight(new RelativeElement(flag, xdelta, glyphs.getSymbolWidth(flag) * scale, pos, {\n          scalex: scale,\n          scaley: scale\n        }));\n      }\n\n      newDotShiftX = notehead.w + dotshiftx - 2 + 5 * dot;\n\n      for (; dot > 0; dot--) {\n        var dotadjusty = 1 - Math.abs(pitch) % 2; //PER: take abs value of the pitch. And the shift still happens on ledger lines.\n\n        abselem.addRight(new RelativeElement(\"dots.dot\", notehead.w + dotshiftx - 2 + 5 * dot, glyphs.getSymbolWidth(\"dots.dot\"), pitch + dotadjusty));\n      }\n    }\n    if (notehead) notehead.highestVert = pitchelem.highestVert;\n\n    if (pitchelem.accidental) {\n      var symb;\n\n      switch (pitchelem.accidental) {\n        case \"quartersharp\":\n          symb = \"accidentals.halfsharp\";\n          break;\n\n        case \"dblsharp\":\n          symb = \"accidentals.dblsharp\";\n          break;\n\n        case \"sharp\":\n          symb = \"accidentals.sharp\";\n          break;\n\n        case \"quarterflat\":\n          symb = \"accidentals.halfflat\";\n          break;\n\n        case \"flat\":\n          symb = \"accidentals.flat\";\n          break;\n\n        case \"dblflat\":\n          symb = \"accidentals.dblflat\";\n          break;\n\n        case \"natural\":\n          symb = \"accidentals.nat\";\n      } // if a note is at least a sixth away, it can share a slot with another accidental\n\n\n      var accSlotFound = false;\n      var accPlace = extrax;\n\n      for (var j = 0; j < accidentalSlot.length; j++) {\n        if (pitch - accidentalSlot[j][0] >= 6) {\n          accidentalSlot[j][0] = pitch;\n          accPlace = accidentalSlot[j][1];\n          accSlotFound = true;\n          break;\n        }\n      }\n\n      if (accSlotFound === false) {\n        accPlace -= glyphs.getSymbolWidth(symb) * scale + 2;\n        accidentalSlot.push([pitch, accPlace]);\n        accidentalshiftx = glyphs.getSymbolWidth(symb) * scale + 2;\n      }\n\n      abselem.addExtra(new RelativeElement(symb, accPlace, glyphs.getSymbolWidth(symb), pitch, {\n        scalex: scale,\n        scaley: scale\n      }));\n      extraLeft = glyphs.getSymbolWidth(symb) / 2; // TODO-PER: We need a little extra width if there is an accidental, but I'm not sure why it isn't the full width of the accidental.\n    }\n\n    return {\n      notehead: notehead,\n      accidentalshiftx: accidentalshiftx,\n      dotshiftx: newDotShiftX,\n      extraLeft: extraLeft\n    };\n  };\n\n  AbstractEngraver.prototype.addSlursAndTies = function (abselem, pitchelem, notehead, voice, dir, isGrace) {\n    if (pitchelem.endTie) {\n      if (this.ties.length > 0) {\n        // If there are multiple open ties, find the one that applies by matching the pitch, if possible.\n        var found = false;\n\n        for (var j = 0; j < this.ties.length; j++) {\n          if (this.ties[j].anchor1 && this.ties[j].anchor1.pitch === notehead.pitch) {\n            this.ties[j].setEndAnchor(notehead);\n            this.ties.splice(j, 1);\n            found = true;\n            break;\n          }\n        }\n\n        if (!found) {\n          this.ties[0].setEndAnchor(notehead);\n          this.ties.splice(0, 1);\n        }\n      }\n    }\n\n    var voiceNumber = voice.voicetotal < 2 ? -1 : voice.voicenumber;\n\n    if (pitchelem.startTie) {\n      var tie = new TieElem({\n        anchor1: notehead,\n        force: this.stemdir === \"down\" || this.stemdir === \"up\",\n        stemDir: this.stemdir,\n        isGrace: isGrace,\n        voiceNumber: voiceNumber\n      });\n      if (hint) tie.setHint();\n      this.ties[this.ties.length] = tie;\n      voice.addOther(tie); // HACK-PER: For the animation, we need to know if a note is tied to the next one, so here's a flag.\n      // Unfortunately, only some of the notes in the current event might be tied, but this will consider it\n      // tied if any one of them is. That will work for most cases.\n\n      abselem.startTie = true;\n    }\n\n    if (pitchelem.endSlur) {\n      for (var i = 0; i < pitchelem.endSlur.length; i++) {\n        var slurid = pitchelem.endSlur[i];\n        var slur;\n\n        if (this.slurs[slurid]) {\n          slur = this.slurs[slurid];\n          slur.setEndAnchor(notehead);\n          delete this.slurs[slurid];\n        } else {\n          slur = new TieElem({\n            anchor2: notehead,\n            stemDir: this.stemdir,\n            voiceNumber: voiceNumber\n          });\n          if (hint) slur.setHint();\n          voice.addOther(slur);\n        }\n\n        if (this.startlimitelem) {\n          slur.setStartX(this.startlimitelem);\n        }\n      }\n    } else if (!isGrace) {\n      for (var s in this.slurs) {\n        if (this.slurs.hasOwnProperty(s)) {\n          this.slurs[s].addInternalNote(notehead);\n        }\n      }\n    }\n\n    if (pitchelem.startSlur) {\n      for (i = 0; i < pitchelem.startSlur.length; i++) {\n        var slurid = pitchelem.startSlur[i].label;\n        var slur = new TieElem({\n          anchor1: notehead,\n          stemDir: this.stemdir,\n          voiceNumber: voiceNumber\n        });\n        if (hint) slur.setHint();\n        this.slurs[slurid] = slur;\n        voice.addOther(slur);\n      }\n    }\n  };\n\n  AbstractEngraver.prototype.addMeasureNumber = function (number, abselem) {\n    var measureNumHeight = this.renderer.getTextSize(number, \"measurefont\", 'bar-number');\n    abselem.addChild(new RelativeElement(number, 0, 0, 11 + measureNumHeight.height / spacing.STEP, {\n      type: \"barNumber\"\n    }));\n  };\n\n  AbstractEngraver.prototype.createBarLine = function (voice, elem, isFirstStaff) {\n    // bar_thin, bar_thin_thick, bar_thin_thin, bar_thick_thin, bar_right_repeat, bar_left_repeat, bar_double_repeat\n    var abselem = new AbsoluteElement(elem, 0, 10, 'bar', this.tuneNumber);\n    var anchor = null; // place to attach part lines\n\n    var dx = 0;\n\n    if (elem.barNumber) {\n      this.addMeasureNumber(elem.barNumber, abselem);\n    }\n\n    var firstdots = elem.type === \"bar_right_repeat\" || elem.type === \"bar_dbl_repeat\";\n    var firstthin = elem.type !== \"bar_left_repeat\" && elem.type !== \"bar_thick_thin\" && elem.type !== \"bar_invisible\";\n    var thick = elem.type === \"bar_right_repeat\" || elem.type === \"bar_dbl_repeat\" || elem.type === \"bar_left_repeat\" || elem.type === \"bar_thin_thick\" || elem.type === \"bar_thick_thin\";\n    var secondthin = elem.type === \"bar_left_repeat\" || elem.type === \"bar_thick_thin\" || elem.type === \"bar_thin_thin\" || elem.type === \"bar_dbl_repeat\";\n    var seconddots = elem.type === \"bar_left_repeat\" || elem.type === \"bar_dbl_repeat\"; // limit positioning of slurs\n\n    if (firstdots || seconddots) {\n      for (var slur in this.slurs) {\n        if (this.slurs.hasOwnProperty(slur)) {\n          this.slurs[slur].setEndX(abselem);\n        }\n      }\n\n      this.startlimitelem = abselem;\n    }\n\n    if (firstdots) {\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n      dx += 6; //2 hardcoded, twice;\n    }\n\n    if (firstthin) {\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor);\n    }\n\n    if (elem.type === \"bar_invisible\") {\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"none\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor);\n    }\n\n    if (elem.decoration) {\n      this.decoration.createDecoration(voice, elem.decoration, 12, thick ? 3 : 1, abselem, 0, \"down\", 2, elem.positioning, this.hasVocals);\n    }\n\n    if (thick) {\n      dx += 4; //3 hardcoded;\n\n      anchor = new RelativeElement(null, dx, 4, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 4\n      });\n      abselem.addRight(anchor);\n      dx += 5;\n    } // if (this.partstartelem && (thick || (firstthin && secondthin))) { // means end of nth part\n    // this.partstartelem.anchor2=anchor;\n    // this.partstartelem = null;\n    // }\n\n\n    if (this.partstartelem && elem.endEnding) {\n      this.partstartelem.anchor2 = anchor;\n      this.partstartelem = null;\n    }\n\n    if (secondthin) {\n      dx += 3; //3 hardcoded;\n\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor); // 3 is hardcoded\n    }\n\n    if (seconddots) {\n      dx += 3; //3 hardcoded;\n\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n    } // 2 is hardcoded\n\n\n    if (elem.startEnding && isFirstStaff) {\n      // only put the first & second ending marks on the first staff\n      var textWidth = this.renderer.getTextSize(elem.startEnding, \"repeatfont\", '').width;\n      abselem.minspacing += textWidth + 10; // Give plenty of room for the ending number.\n\n      this.partstartelem = new EndingElem(elem.startEnding, anchor, null);\n      voice.addOther(this.partstartelem);\n    } // Add a little space to the left of the bar line so that nothing can crowd it.\n\n\n    abselem.extraw -= 5;\n    return abselem;\n  };\n})();\n\nmodule.exports = AbstractEngraver;","map":{"version":3,"sources":["/home/elad/Desktop/Repos/drums-trainer/frontend/node_modules/react-sheet-music/node_modules/abcjs/src/write/abc_abstract_engraver.js"],"names":["AbsoluteElement","require","BeamElem","BraceElem","createClef","createKeySignature","createTimeSignature","Decoration","EndingElem","glyphs","RelativeElement","spacing","StaffGroupElement","TempoElement","TieElem","TripletElem","VoiceElement","parseCommon","AbstractEngraver","getDuration","elem","d","duration","hint","chartable","rest","note","rhythm","nostem","x","harmonic","uflags","dflags","renderer","tuneNumber","options","decoration","isBagpipes","bagpipes","flatBeams","flatbeams","reset","prototype","slurs","ties","voiceScale","slursbyvoice","tiesbyvoice","endingsbyvoice","scaleByVoice","tripletmultiplier","abcline","undefined","accidentalSlot","accidentalshiftx","dotshiftx","hasVocals","minY","partstartelem","startlimitelem","stemdir","setStemHeight","heightInPixels","stemHeight","STEP","getCurrentVoiceId","s","v","pushCrossLineElems","popCrossLineElems","containsLyrics","staves","i","length","j","voices","k","el","lyric","positioning","vocalPosition","createABCLine","staffs","tempo","staffgroup","tempoSet","restoreState","createABCStaff","abcstaff","voice","barfrom","connectBarLines","barto","duplicate","title","header","clef","barNumber","addMeasureNumber","addChild","keySig","key","meter","type","measureLength","value","num","den","ts","children","staffLines","stafflines","addVoice","isSingleLineStaff","createABCVoice","setStaffLimits","brace","increaseStavesIncluded","getBeamGroup","pos","el_type","startBeam","endBeam","count","group","push","addOther","voiceNumber","voicetotal","voicenumber","slur","hasOwnProperty","force","stemDir","setHint","setAveragePitch","Math","min","minpitch","isFirstStaff","ret","abselems","createABCElement","suppress","tempoElement","createNoteHead","saveState","tiesSave","cloneArray","slursSave","cloneHashOfHash","slursbyvoiceSave","tiesbyvoiceSave","cloneHashOfArrayOfHash","elemset","createBeam","createNote","triplet","isClosed","createBarLine","invisible","absKey","direction","abselem","dim","getTextSize","height","abselem3","head","style","size","abselem2","pitches","sortPitch","sum","p","verticalPos","averagepitch","maxpitch","calcBeamDir","elems","beamelem","add","abcelem","dir","calcDir","abselemset","oldDir","addBeam","sorted","pitch","tmp","ledgerLines","minPitch","maxPitch","isRest","symbolWidth","additionalLedgers","dx","scale","ofs","addGraceNotes","notehead","roomtaken","gracescale","graceScaleStem","gracebeam","flag","gracenotes","mainNote","graceoffsets","accidental","gracepitch","highestVert","grace","addSlursAndTies","addExtra","acciaccatura","dAcciaccatura","addRight","scalex","scaley","graceDuration","pseudoabselem","heads","p1","p2","w","width","linewidth","getSymbolWidth","isTie","anchor1","anchor2","isGrace","addRestToAbsElement","dot","isMultiVoice","durlog","c","restpitch","noteHead","roomTaken","roomTakenRight","mmWidth","addHead","numMeasures","addIfNotExist","arr","item","JSON","stringify","addNoteToAbcElement","zeroDuration","noteSymbol","console","log","prev","curr","delta","printer_shift","pp","isTopWhenStemIsDown","isBottomWhenStemIsUp","startSlur","endSlur","hasStem","max","extraw","extraLeft","bottom","addLyric","lyricStr","each","ly","div","divider","syllable","lyricDim","position","addCentered","addChord","chordMargin","chord","y","name","chordWidth","chordHeight","rel_position","relPositionY","pos2","chordPosition","roomtakenright","floor","tot","pow","inc","startTriplet","tripletMultiplier","durationForSpacing","absType","durationClassOveride","ret1","ret2","createDecoration","top","ret3","endTriplet","setCloseAnchor","middleNote","pitchelem","headx","extrax","shouldExtendStem","newDotShiftX","shiftheadx","adjust","opts","thickness","symbolHeightInPitches","xdelta","dotadjusty","abs","symb","accSlotFound","accPlace","endTie","found","setEndAnchor","splice","startTie","tie","slurid","setStartX","addInternalNote","label","number","measureNumHeight","anchor","firstdots","firstthin","thick","secondthin","seconddots","setEndX","endEnding","startEnding","textWidth","minspacing","module","exports"],"mappings":"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","sourcesContent":["// abc_abstract_engraver.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nvar AbsoluteElement = require('./abc_absolute_element');\nvar BeamElem = require('./abc_beam_element');\nvar BraceElem = require('./abc_brace_element');\nvar createClef = require('./abc_create_clef');\nvar createKeySignature = require('./abc_create_key_signature');\nvar createTimeSignature = require('./abc_create_time_signature');\nvar Decoration = require('./abc_decoration');\nvar EndingElem = require('./abc_ending_element');\nvar glyphs = require('./abc_glyphs');\nvar RelativeElement = require('./abc_relative_element');\nvar spacing = require('./abc_spacing');\nvar StaffGroupElement = require('./abc_staff_group_element');\nvar TempoElement = require('./abc_tempo_element');\nvar TieElem = require('./abc_tie_element');\nvar TripletElem = require('./abc_triplet_element');\nvar VoiceElement = require('./abc_voice_element');\n\nvar parseCommon = require('../parse/abc_common');\n\nvar AbstractEngraver;\n\n(function() {\n\t\"use strict\";\n\nvar getDuration = function(elem) {\n  var d = 0;\n  if (elem.duration) {\n    d = elem.duration;\n  }\n  return d;\n};\n\nvar hint = false;\n\n\tvar chartable = {\n\t\trest:{0:\"rests.whole\", 1:\"rests.half\", 2:\"rests.quarter\", 3:\"rests.8th\", 4: \"rests.16th\",5: \"rests.32nd\", 6: \"rests.64th\", 7: \"rests.128th\", \"multi\": \"rests.multimeasure\"},\n\t\tnote:{\"-1\": \"noteheads.dbl\", 0:\"noteheads.whole\", 1:\"noteheads.half\", 2:\"noteheads.quarter\", 3:\"noteheads.quarter\", 4:\"noteheads.quarter\", 5:\"noteheads.quarter\", 6:\"noteheads.quarter\", 7:\"noteheads.quarter\", 'nostem':\"noteheads.quarter\"},\n\t\trhythm:{\"-1\": \"noteheads.slash.whole\", 0:\"noteheads.slash.whole\", 1:\"noteheads.slash.whole\", 2:\"noteheads.slash.quarter\", 3:\"noteheads.slash.quarter\", 4:\"noteheads.slash.quarter\", 5:\"noteheads.slash.quarter\", 6:\"noteheads.slash.quarter\", 7:\"noteheads.slash.quarter\", nostem: \"noteheads.slash.nostem\"},\n\t\tx:{\"-1\": \"noteheads.indeterminate\", 0:\"noteheads.indeterminate\", 1:\"noteheads.indeterminate\", 2:\"noteheads.indeterminate\", 3:\"noteheads.indeterminate\", 4:\"noteheads.indeterminate\", 5:\"noteheads.indeterminate\", 6:\"noteheads.indeterminate\", 7:\"noteheads.indeterminate\", nostem: \"noteheads.indeterminate\"},\n\t\tharmonic:{\"-1\": \"noteheads.harmonic.quarter\", 0:\"noteheads.harmonic.quarter\", 1:\"noteheads.harmonic.quarter\", 2:\"noteheads.harmonic.quarter\", 3:\"noteheads.harmonic.quarter\", 4:\"noteheads.harmonic.quarter\", 5:\"noteheads.harmonic.quarter\", 6:\"noteheads.harmonic.quarter\", 7:\"noteheads.harmonic.quarter\", nostem: \"noteheads.harmonic.quarter\"},\n\t\tuflags:{3:\"flags.u8th\", 4:\"flags.u16th\", 5:\"flags.u32nd\", 6:\"flags.u64th\"},\n\t\tdflags:{3:\"flags.d8th\", 4:\"flags.d16th\", 5:\"flags.d32nd\", 6:\"flags.d64th\"}\n\t};\n\nAbstractEngraver = function(renderer, tuneNumber, options) {\n\tthis.decoration = new Decoration();\n\tthis.renderer = renderer;\n\tthis.tuneNumber = tuneNumber;\n\tthis.isBagpipes = options.bagpipes;\n\tthis.flatBeams = options.flatbeams;\n\tthis.reset();\n};\n\nAbstractEngraver.prototype.reset = function() {\n\tthis.slurs = {};\n\tthis.ties = [];\n\tthis.voiceScale = 1;\n\tthis.slursbyvoice = {};\n\tthis.tiesbyvoice = {};\n\tthis.endingsbyvoice = {};\n\tthis.scaleByVoice = {};\n\tthis.tripletmultiplier = 1;\n\n\tthis.abcline = undefined;\n\tthis.accidentalSlot = undefined;\n\tthis.accidentalshiftx = undefined;\n\tthis.dotshiftx = undefined;\n\tthis.hasVocals = false;\n\tthis.minY = undefined;\n\tthis.partstartelem = undefined;\n\tthis.startlimitelem = undefined;\n\tthis.stemdir = undefined;\n};\n\nAbstractEngraver.prototype.setStemHeight = function(heightInPixels) {\n\tthis.stemHeight = heightInPixels / spacing.STEP;\n};\n\nAbstractEngraver.prototype.getCurrentVoiceId = function(s,v) {\n  return \"s\"+s+\"v\"+v;\n};\n\nAbstractEngraver.prototype.pushCrossLineElems = function(s,v) {\n  this.slursbyvoice[this.getCurrentVoiceId(s,v)] = this.slurs;\n  this.tiesbyvoice[this.getCurrentVoiceId(s,v)] = this.ties;\n  this.endingsbyvoice[this.getCurrentVoiceId(s,v)] = this.partstartelem;\n  this.scaleByVoice[this.getCurrentVoiceId(s,v)] = this.voiceScale;\n};\n\nAbstractEngraver.prototype.popCrossLineElems = function(s,v) {\n  this.slurs = this.slursbyvoice[this.getCurrentVoiceId(s,v)] || {};\n  this.ties = this.tiesbyvoice[this.getCurrentVoiceId(s,v)] || [];\n  this.partstartelem = this.endingsbyvoice[this.getCurrentVoiceId(s,v)];\n  this.voiceScale = this.scaleByVoice[this.getCurrentVoiceId(s,v)];\n  if (this.voiceScale === undefined) this.voiceScale = 1;\n};\n\n\tAbstractEngraver.prototype.containsLyrics = function(staves) {\n\t\tfor (var i = 0; i < staves.length; i++) {\n\t\t\tfor (var j = 0; j < staves[i].voices.length; j++) {\n\t\t\t\tfor (var k = 0; k < staves[i].voices[j].length; k++) {\n\t\t\t\t\tvar el = staves[i].voices[j][k];\n\t\t\t\t\tif (el.lyric) {\n\t\t\t\t\t\t// We just want to see if there are vocals below the music to know where to put the dynamics.\n\t\t\t\t\t\tif (!el.positioning || el.positioning.vocalPosition === 'below')\n\t\t\t\t\t\t\tthis.hasVocals = true;\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\nAbstractEngraver.prototype.createABCLine = function(staffs, tempo) {\n    this.minY = 2; // PER: This will be the lowest that any note reaches. It will be used to set the dynamics row.\n\t// See if there are any lyrics on this line.\n\tthis.containsLyrics(staffs);\n  var staffgroup = new StaffGroupElement();\n\tthis.tempoSet = false;\n  for (var s = 0; s < staffs.length; s++) {\n\t  if (hint)\n\t\t  this.restoreState();\n\t  hint = false;\n    this.createABCStaff(staffgroup, staffs[s], tempo, s);\n  }\n  return staffgroup;\n};\n\nAbstractEngraver.prototype.createABCStaff = function(staffgroup, abcstaff, tempo, s) {\n// If the tempo is passed in, then the first element should get the tempo attached to it.\n  for (var v = 0; v < abcstaff.voices.length; v++) {\n    var voice = new VoiceElement(v,abcstaff.voices.length);\n    if (v===0) {\n\t    voice.barfrom = (abcstaff.connectBarLines===\"start\" || abcstaff.connectBarLines===\"continue\");\n\t    voice.barto = (abcstaff.connectBarLines===\"continue\" || abcstaff.connectBarLines===\"end\");\n    } else {\n\t    voice.duplicate = true; // bar lines and other duplicate info need not be created\n    }\n    if (abcstaff.title && abcstaff.title[v]) voice.header=abcstaff.title[v];\n\t  var clef = createClef(abcstaff.clef, this.tuneNumber);\n\t  if (clef) {\n\t\t  if (v ===0 && abcstaff.barNumber) {\n\t\t\t  this.addMeasureNumber(abcstaff.barNumber, clef);\n\t\t  }\n\t\t  voice.addChild(clef);\n\t  }\n\t  var keySig = createKeySignature(abcstaff.key, this.tuneNumber);\n\t  if (keySig) {\n\t\t  voice.addChild(keySig);\n\t\t  this.startlimitelem = keySig; // limit ties here\n\t  }\n    if (abcstaff.meter) {\n    \tif (abcstaff.meter.type === 'specified') {\n    \t\tthis.measureLength = abcstaff.meter.value[0].num / abcstaff.meter.value[0].den;\n\t    } else\n\t    \tthis.measureLength = 1;\n\t\tvar ts = createTimeSignature(abcstaff.meter, this.tuneNumber);\n\t    voice.addChild(ts);\n\t\tthis.startlimitelem = ts; // limit ties here\n\t}\n\t  if (voice.duplicate)\n\t\t  voice.children = []; // we shouldn't reprint the above if we're reusing the same staff. We just created them to get the right spacing.\n    var staffLines = abcstaff.clef.stafflines || abcstaff.clef.stafflines === 0 ? abcstaff.clef.stafflines : 5;\n    staffgroup.addVoice(voice,s,staffLines);\n\t  var isSingleLineStaff = staffLines === 1;\n\t  this.createABCVoice(abcstaff.voices[v],tempo, s, v, isSingleLineStaff, voice);\n\t  staffgroup.setStaffLimits(voice);\n            //Tony: Here I am following what staves need to be surrounded by the brace, by incrementing the length of the brace class.\n            //So basically this keeps incrementing the number of staff surrounded by the brace until it sees \"end\".\n            //This then gets processed in abc_staff_group_element.js, so that it will have the correct top and bottom coordinates for the brace.\n\t\t\tif(abcstaff.brace === \"start\"){\n\t\t\t\tstaffgroup.brace = new BraceElem(1, true);\n\t\t\t}\n\t\t\telse if(abcstaff.brace === \"end\" && staffgroup.brace) {\n\t\t\t\tstaffgroup.brace.increaseStavesIncluded();\n\t\t\t}\n\t\t\telse if(abcstaff.brace === \"continue\" && staffgroup.brace){\n\t\t\t\tstaffgroup.brace.increaseStavesIncluded();\n\t\t\t}\n  }\n};\n\nfunction getBeamGroup(abcline, pos) {\n\t// If there are notes beamed together, they are handled as a group, so find all of them here.\n\tvar elem = abcline[pos];\n\tif (elem.el_type !== 'note' || !elem.startBeam || elem.endBeam)\n\t\treturn { count: 1, elem: elem };\n\n\tvar group = [];\n\twhile (pos < abcline.length && abcline[pos].el_type === 'note') {\n\t\tgroup.push(abcline[pos]);\n\t\tif (abcline[pos].endBeam)\n\t\t\tbreak;\n\t\tpos++;\n\t}\n\treturn { count: group.length, elem: group };\n}\n\nAbstractEngraver.prototype.createABCVoice = function(abcline, tempo, s, v, isSingleLineStaff, voice) {\n  this.popCrossLineElems(s,v);\n  this.stemdir = (this.isBagpipes)?\"down\":null;\n  this.abcline = abcline;\n  if (this.partstartelem) {\n    this.partstartelem = new EndingElem(\"\", null, null);\n\t  voice.addOther(this.partstartelem);\n  }\n\tvar voiceNumber = voice.voicetotal < 2 ? -1 : voice.voicenumber;\n  for (var slur in this.slurs) {\n    if (this.slurs.hasOwnProperty(slur)) {\n\t    // this is already a slur element, but it was created for the last line, so recreate it.\n      this.slurs[slur]= new TieElem({force: this.slurs[slur].force, voiceNumber: voiceNumber, stemDir: this.slurs[slur].stemDir});\n\t\tif (hint) this.slurs[slur].setHint();\n\t    voice.addOther(this.slurs[slur]);\n    }\n  }\n  for (var i=0; i<this.ties.length; i++) {\n  \t// this is already a tie element, but it was created for the last line, so recreate it.\n    this.ties[i]=new TieElem({ force: this.ties[i].force, stemDir: this.ties[i].stemDir, voiceNumber: voiceNumber });\n\t  if (hint) this.ties[i].setHint();\n\t  voice.addOther(this.ties[i]);\n  }\n\n  for (var j = 0; j < this.abcline.length; j++) {\n\t  setAveragePitch(this.abcline[j]);\n\t  this.minY = Math.min(this.abcline[j].minpitch, this.minY);\n  }\n\n\tvar isFirstStaff = (s === 0);\n\tvar pos = 0;\n\twhile (pos < this.abcline.length) {\n\t\tvar ret = getBeamGroup(this.abcline, pos);\n\t\tvar abselems = this.createABCElement(isFirstStaff, isSingleLineStaff, voice, ret.elem);\n\t\tif (abselems) {\n\t\t\tfor (i = 0; i < abselems.length; i++) {\n\t\t\t\tif (!this.tempoSet && tempo && !tempo.suppress) {\n\t\t\t\t\tthis.tempoSet = true;\n\t\t\t\t\tvar tempoElement = new AbsoluteElement(ret.elem, 0, 0, \"tempo\", this.tuneNumber, {});\n\t\t\t\t\ttempoElement.addChild(new TempoElement(tempo, this.tuneNumber, createNoteHead));\n\t\t\t\t\tvoice.addChild(tempoElement);\n\t\t\t\t}\n\t\t\t\tvoice.addChild(abselems[i]);\n\t\t\t}\n\t\t}\n\t\tpos += ret.count;\n\t}\n\tthis.pushCrossLineElems(s, v);\n};\n\n\tAbstractEngraver.prototype.saveState = function() {\n\t\tthis.tiesSave = parseCommon.cloneArray(this.ties);\n\t\tthis.slursSave = parseCommon.cloneHashOfHash(this.slurs);\n\t\tthis.slursbyvoiceSave = parseCommon.cloneHashOfHash(this.slursbyvoice);\n\t\tthis.tiesbyvoiceSave = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoice);\n\t};\n\n\tAbstractEngraver.prototype.restoreState = function() {\n\t\tthis.ties = parseCommon.cloneArray(this.tiesSave);\n\t\tthis.slurs = parseCommon.cloneHashOfHash(this.slursSave);\n\t\tthis.slursbyvoice = parseCommon.cloneHashOfHash(this.slursbyvoiceSave);\n\t\tthis.tiesbyvoice = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoiceSave);\n\t};\n\n\t// function writeMeasureWidth(voice) {\n\t// \tvar width = 0;\n\t// \tfor (var i = voice.children.length-1; i >= 0; i--) {\n\t// \t\tvar elem = voice.children[i];\n\t// \t\tif (elem.abcelem.el_type === 'bar')\n\t// \t\t\tbreak;\n\t// \t\twidth += elem.w;\n\t// \t}\n\t// \treturn new RelativeElement(width.toFixed(2), -70, 0, undefined, {type:\"debug\"});\n\t// }\n\n\t// return an array of AbsoluteElement\nAbstractEngraver.prototype.createABCElement = function(isFirstStaff, isSingleLineStaff, voice, elem) {\n  var elemset = [];\n  switch (elem.el_type) {\n\t  case undefined:\n\t  \t// it is undefined if we were passed an array in - an array means a set of notes that should be beamed together.\n\t\t  elemset = this.createBeam(isSingleLineStaff, voice, elem);\n\t  \tbreak;\n  case \"note\":\n\t  elemset[0] = this.createNote(elem, false, isSingleLineStaff, voice);\n\t  if (this.triplet && this.triplet.isClosed()) {\n\t\t  voice.addOther(this.triplet);\n\t\t  this.triplet = null;\n\t\t  this.tripletmultiplier = 1;\n\t  }\n    break;\n  case \"bar\":\n    elemset[0] = this.createBarLine(voice, elem, isFirstStaff);\n    if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n//\t  elemset[0].addChild(writeMeasureWidth(voice));\n    break;\n  case \"meter\":\n    elemset[0] = createTimeSignature(elem, this.tuneNumber);\n\t  this.startlimitelem = elemset[0]; // limit ties here\n    if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"clef\":\n    elemset[0] = createClef(elem, this.tuneNumber);\n\t  if (!elemset[0]) return null;\n    if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"key\":\n\t  var absKey = createKeySignature(elem, this.tuneNumber);\n\t  if (absKey) {\n\t\t  elemset[0] = absKey;\n\t\t  this.startlimitelem = elemset[0]; // limit ties here\n\t  }\n    if (voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"stem\":\n    this.stemdir=elem.direction;\n    break;\n  case \"part\":\n    var abselem = new AbsoluteElement(elem,0,0, 'part', this.tuneNumber);\n\t  var dim = this.renderer.getTextSize(elem.title, 'partsfont', \"part\");\n    abselem.addChild(new RelativeElement(elem.title, 0, 0, undefined, {type:\"part\", height: dim.height/spacing.STEP}));\n    elemset[0] = abselem;\n    break;\n  case \"tempo\":\n    var abselem3 = new AbsoluteElement(elem,0,0, 'tempo', this.tuneNumber);\n    abselem3.addChild(new TempoElement(elem, this.tuneNumber, createNoteHead));\n    elemset[0] = abselem3;\n    break;\n\t  case \"style\":\n\t\t  if (elem.head === \"normal\")\n\t\t\t  delete this.style;\n\t\t  else\n\t\t\t  this.style = elem.head;\n\t\t  break;\n\t  case \"hint\":\n\t\t  hint = true;\n\t\t  this.saveState();\n\t\t  break;\n\t  case \"midi\":\n\t\t// This has no effect on the visible music, so just skip it.\n\t\tbreak;\n\t  case \"scale\":\n\t  \tthis.voiceScale = elem.size;\n\t  \tbreak;\n\n  default:\n    var abselem2 = new AbsoluteElement(elem,0,0, 'unsupported', this.tuneNumber);\n    abselem2.addChild(new RelativeElement(\"element type \"+elem.el_type, 0, 0, undefined, {type:\"debug\"}));\n    elemset[0] = abselem2;\n  }\n\n  return elemset;\n};\n\n\tfunction setAveragePitch(elem) {\n\t\tif (elem.pitches) {\n\t\t\tsortPitch(elem);\n\t\t\tvar sum = 0;\n\t\t\tfor (var p = 0; p < elem.pitches.length; p++) {\n\t\t\t\tsum += elem.pitches[p].verticalPos;\n\t\t\t}\n\t\t\telem.averagepitch = sum / elem.pitches.length;\n\t\t\telem.minpitch = elem.pitches[0].verticalPos;\n\t\t\telem.maxpitch = elem.pitches[elem.pitches.length - 1].verticalPos;\n\t\t}\n\t}\n\n\tAbstractEngraver.prototype.calcBeamDir = function (isSingleLineStaff, voice, elems) {\n\t\tif (this.stemdir) // If the user or voice is forcing the stem direction, we already know the answer.\n\t\t\treturn this.stemdir;\n\t\tvar beamelem = new BeamElem(this.stemHeight * this.voiceScale, this.stemdir, this.flatBeams);\n\t\tfor (var i = 0; i < elems.length; i++) {\n\t\t\tbeamelem.add({abcelem: elems[i]}); // This is a hack to call beam elem with just a minimum of processing: for our purposes, we don't need to construct the whole note.\n\t\t}\n\n\t\tvar dir = beamelem.calcDir();\n\t\treturn dir ? \"up\" : \"down\";\n\t};\n\n\tAbstractEngraver.prototype.createBeam = function (isSingleLineStaff, voice, elems) {\n\t\tvar abselemset = [];\n\n\t\tvar dir = this.calcBeamDir(isSingleLineStaff, voice, elems);\n\t\tvar beamelem = new BeamElem(this.stemHeight * this.voiceScale, dir, this.flatBeams);\n\t\tif (hint) beamelem.setHint();\n\t\tvar oldDir = this.stemdir;\n\t\tthis.stemdir = dir;\n\t\tfor (var i = 0; i < elems.length; i++) {\n\t\t\tvar elem = elems[i];\n\t\t\tvar abselem = this.createNote(elem, true, isSingleLineStaff, voice);\n\t\t\tabselemset.push(abselem);\n\t\t\tbeamelem.add(abselem);\n\t\t\tif (this.triplet && this.triplet.isClosed()) {\n\t\t\t\tvoice.addOther(this.triplet);\n\t\t\t\tthis.triplet = null;\n\t\t\t\tthis.tripletmultiplier = 1;\n\t\t\t}\n\t\t}\n\t\tthis.stemdir = oldDir;\n\t\tvoice.addBeam(beamelem);\n\t\treturn abselemset;\n\t};\n\nvar sortPitch = function(elem) {\n  var sorted;\n  do {\n    sorted = true;\n    for (var p = 0; p<elem.pitches.length-1; p++) {\n      if (elem.pitches[p].pitch>elem.pitches[p+1].pitch) {\n        sorted = false;\n        var tmp = elem.pitches[p];\n        elem.pitches[p] = elem.pitches[p+1];\n        elem.pitches[p+1] = tmp;\n      }\n    }\n  } while (!sorted);\n};\n\nvar ledgerLines = function(abselem, minPitch, maxPitch, isRest, symbolWidth, additionalLedgers, dir, dx, scale) {\n\tfor (var i=maxPitch; i>11; i--) {\n\t\tif (i%2===0 && !isRest) {\n\t\t\tabselem.addChild(new RelativeElement(null, dx, (symbolWidth+4)*scale, i, {type:\"ledger\"}));\n\t\t}\n\t}\n\n\tfor (i=minPitch; i<1; i++) {\n\t\tif (i%2===0 && !isRest) {\n\t\t\tabselem.addChild(new RelativeElement(null, dx, (symbolWidth+4)*scale, i, {type:\"ledger\"}));\n\t\t}\n\t}\n\n\tfor (i = 0; i < additionalLedgers.length; i++) { // PER: draw additional ledgers\n\t\tvar ofs = symbolWidth;\n\t\tif (dir === 'down') ofs = -ofs;\n\t\tabselem.addChild(new RelativeElement(null, ofs+dx, (symbolWidth+4)*scale, additionalLedgers[i], {type:\"ledger\"}));\n\t}\n};\n\n\tAbstractEngraver.prototype.addGraceNotes = function (elem, voice, abselem, notehead, stemHeight, isBagpipes, roomtaken) {\n\t\tvar gracescale = 3 / 5;\n\t\tvar graceScaleStem = 3.5 / 5; // TODO-PER: empirically found constant.\n\t\tvar gracebeam = null;\n\t\tvar flag;\n\n\t\tif (elem.gracenotes.length > 1) {\n\t\t\tgracebeam = new BeamElem(stemHeight * graceScaleStem, \"grace\", isBagpipes);\n\t\t\tif (hint) gracebeam.setHint();\n\t\t\tgracebeam.mainNote = abselem;\t// this gives us a reference back to the note this is attached to so that the stems can be attached somewhere.\n\t\t}\n\n\t\tvar graceoffsets = [];\n\t\tfor (i = elem.gracenotes.length - 1; i >= 0; i--) { // figure out where to place each gracenote\n\t\t\troomtaken += 10;\n\t\t\tgraceoffsets[i] = roomtaken;\n\t\t\tif (elem.gracenotes[i].accidental) {\n\t\t\t\troomtaken += 7;\n\t\t\t}\n\t\t}\n\n\t\tvar i;\n\t\tfor (i = 0; i < elem.gracenotes.length; i++) {\n\t\t\tvar gracepitch = elem.gracenotes[i].verticalPos;\n\n\t\t\tflag = (gracebeam) ? null : chartable.uflags[(isBagpipes) ? 5 : 3];\n\t\t\tvar accidentalSlot = [];\n\t\t\tvar ret = createNoteHead(abselem, \"noteheads.quarter\", elem.gracenotes[i], \"up\", -graceoffsets[i], -graceoffsets[i], flag, 0, 0, gracescale*this.voiceScale, accidentalSlot, false);\n\t\t\tret.notehead.highestVert = ret.notehead.pitch + stemHeight * graceScaleStem;\n\t\t\tvar grace = ret.notehead;\n\t\t\tthis.addSlursAndTies(abselem, elem.gracenotes[i], grace, voice, \"up\", true);\n\n\t\t\tabselem.addExtra(grace);\n\t\t\t// PER: added acciaccatura slash\n\t\t\tif (elem.gracenotes[i].acciaccatura) {\n\t\t\t\tvar pos = elem.gracenotes[i].verticalPos + 7 * gracescale;        // the same formula that determines the flag position.\n\t\t\t\tvar dAcciaccatura = gracebeam ? 5 : 6;        // just an offset to make it line up correctly.\n\t\t\t\tabselem.addRight(new RelativeElement(\"flags.ugrace\", -graceoffsets[i] + dAcciaccatura, 0, pos, {scalex: gracescale, scaley: gracescale}));\n\t\t\t}\n\t\t\tif (gracebeam) { // give the beam the necessary info\n\t\t\t\tvar graceDuration = elem.gracenotes[i].duration / 2;\n\t\t\t\tif (isBagpipes) graceDuration /= 2;\n\t\t\t\tvar pseudoabselem = {\n\t\t\t\t\theads: [grace],\n\t\t\t\t\tabcelem: {averagepitch: gracepitch, minpitch: gracepitch, maxpitch: gracepitch, duration: graceDuration}\n\t\t\t\t};\n\t\t\t\tgracebeam.add(pseudoabselem);\n\t\t\t} else { // draw the stem\n\t\t\t\tvar p1 = gracepitch + 1 / 3 * gracescale;\n\t\t\t\tvar p2 = gracepitch + 7 * gracescale;\n\t\t\t\tvar dx = grace.dx + grace.w;\n\t\t\t\tvar width = -0.6;\n\t\t\t\tabselem.addExtra(new RelativeElement(null, dx, 0, p1, {\"type\": \"stem\", \"pitch2\": p2, linewidth: width}));\n\t\t\t}\n\t\t\tledgerLines(abselem, gracepitch, gracepitch, false, glyphs.getSymbolWidth(\"noteheads.quarter\"), [], true, grace.dx - 1, 0.6);\n\n\t\t\tif (i === 0 && !isBagpipes && !(elem.rest && (elem.rest.type === \"spacer\" || elem.rest.type === \"invisible\"))) {\n\t\t\t\t// This is the overall slur that is under the grace notes.\n\t\t\t\tvar isTie = (elem.gracenotes.length === 1 && grace.pitch === notehead.pitch);\n\t\t\t\tvoice.addOther(new TieElem({ anchor1: grace, anchor2: notehead, isGrace: true}));\n\t\t\t}\n\t\t}\n\n\t\tif (gracebeam) {\n\t\t\tvoice.addBeam(gracebeam);\n\t\t}\n\t\treturn roomtaken;\n\t};\n\n\tfunction addRestToAbsElement(abselem, elem, duration, dot, isMultiVoice, stemdir, isSingleLineStaff, durlog, voiceScale) {\n\t\tvar c;\n\t\tvar restpitch = 7;\n\t\tvar noteHead;\n\t\tvar roomTaken;\n\t\tvar roomTakenRight;\n\n\t\tif (isMultiVoice) {\n\t\t\tif (stemdir === \"down\") restpitch = 3;\n\t\t\tif (stemdir === \"up\") restpitch = 11;\n\t\t}\n\t\t// There is special placement for the percussion staff. If there is one staff line, then move the rest position.\n\t\tif (isSingleLineStaff) {\n\t\t\t// The half and whole rests are attached to different lines normally, so we need to tweak their position to get them to both be attached to the same one.\n\t\t\tif (duration < 0.5)\n\t\t\t\trestpitch = 7;\n\t\t\telse if (duration < 1)\n\t\t\t\trestpitch = 7;\t// half rest\n\t\t\telse\n\t\t\t\trestpitch = 5; // whole rest\n\t\t}\n\t\tswitch (elem.rest.type) {\n\t\t\tcase \"whole\":\n\t\t\t\tc = chartable.rest[0];\n\t\t\t\telem.averagepitch = restpitch;\n\t\t\t\telem.minpitch = restpitch;\n\t\t\t\telem.maxpitch = restpitch;\n\t\t\t\tdot = 0;\n\t\t\t\tbreak;\n\t\t\tcase \"rest\":\n\t\t\t\tif (elem.style === \"rhythm\") // special case for rhythm: rests are a handy way to express the rhythm.\n\t\t\t\t\tc = chartable.rhythm[-durlog];\n\t\t\t\telse\n\t\t\t\t\tc = chartable.rest[-durlog];\n\t\t\t\telem.averagepitch = restpitch;\n\t\t\t\telem.minpitch = restpitch;\n\t\t\t\telem.maxpitch = restpitch;\n\t\t\t\tbreak;\n\t\t\tcase \"invisible\":\n\t\t\tcase \"spacer\":\n\t\t\t\tc = \"\";\n\t\t\t\telem.averagepitch = restpitch;\n\t\t\t\telem.minpitch = restpitch;\n\t\t\t\telem.maxpitch = restpitch;\n\t\t\t\tbreak;\n\t\t\tcase \"multimeasure\":\n\t\t\t\tc = chartable.rest['multi'];\n\t\t\t\telem.averagepitch = restpitch;\n\t\t\t\telem.minpitch = restpitch;\n\t\t\t\telem.maxpitch = restpitch;\n\t\t\t\tdot = 0;\n\t\t\t\tvar mmWidth = glyphs.getSymbolWidth(c);\n\t\t\t\tabselem.addHead(new RelativeElement(c, -mmWidth, mmWidth * 2, 7));\n\t\t\t\tvar numMeasures = new RelativeElement(\"\" + elem.duration, 0, mmWidth, 16, {type: \"multimeasure-text\"});\n\t\t\t\tabselem.addExtra(numMeasures);\n\t\t}\n\t\tif (elem.rest.type !== \"multimeasure\") {\n\t\t\tvar ret = createNoteHead(abselem, c, {verticalPos: restpitch}, null, 0, 0, null, dot, 0, voiceScale, [], false);\n\t\t\tnoteHead = ret.notehead;\n\t\t\tif (noteHead) {\n\t\t\t\tabselem.addHead(noteHead);\n\t\t\t\troomTaken = ret.accidentalshiftx;\n\t\t\t\troomTakenRight = ret.dotshiftx;\n\t\t\t}\n\t\t}\n\t\treturn { noteHead: noteHead, roomTaken: roomTaken, roomTakenRight: roomTakenRight };\n\t}\n\n\tfunction addIfNotExist(arr, item) {\n\t\tfor (var i = 0; i < arr.length; i++) {\n\t\t\tif (JSON.stringify(arr[i]) === JSON.stringify(item))\n\t\t\t\treturn;\n\t\t}\n\t\tarr.push(item);\n\t}\n\n\tAbstractEngraver.prototype.addNoteToAbcElement = function(abselem, elem, dot, stemdir, style, zeroDuration, durlog, nostem, voice) {\n\t\tvar dotshiftx = 0; // room taken by chords with displaced noteheads which cause dots to shift\n\t\tvar noteHead;\n\t\tvar roomTaken = 0;\n\t\tvar roomTakenRight = 0;\n\t\tvar min;\n\t\tvar i;\n\t\tvar additionalLedgers = [];\n\t\t// The accidentalSlot will hold a list of all the accidentals on this chord. Each element is a vertical place,\n\t\t// and contains a pitch, which is the last pitch that contains an accidental in that slot. The slots are numbered\n\t\t// from closest to the note to farther left. We only need to know the last accidental we placed because\n\t\t// we know that the pitches are sorted by now.\n\t\tvar accidentalSlot = [];\n\t\tvar symbolWidth = 0;\n\n\t\tvar dir = (elem.averagepitch>=6) ? \"down\": \"up\";\n\t\tif (stemdir) dir=stemdir;\n\n\t\tstyle = elem.style ? elem.style : style; // get the style of note head.\n\t\tif (!style || style === \"normal\") style = \"note\";\n\t\tvar noteSymbol;\n\t\tif (zeroDuration)\n\t\t\tnoteSymbol = chartable[style].nostem;\n\t\telse\n\t\t\tnoteSymbol = chartable[style][-durlog];\n\t\tif (!noteSymbol)\n\t\t\tconsole.log(\"noteSymbol:\", style, durlog, zeroDuration);\n\n\t\t// determine elements of chords which should be shifted\n\t\tvar p;\n\t\tfor (p=(dir===\"down\")?elem.pitches.length-2:1; (dir===\"down\")?p>=0:p<elem.pitches.length; p=(dir===\"down\")?p-1:p+1) {\n\t\t\tvar prev = elem.pitches[(dir===\"down\")?p+1:p-1];\n\t\t\tvar curr = elem.pitches[p];\n\t\t\tvar delta = (dir===\"down\")?prev.pitch-curr.pitch:curr.pitch-prev.pitch;\n\t\t\tif (delta<=1 && !prev.printer_shift) {\n\t\t\t\tcurr.printer_shift=(delta)?\"different\":\"same\";\n\t\t\t\tif (curr.verticalPos > 11 || curr.verticalPos < 1) {        // PER: add extra ledger line\n\t\t\t\t\tadditionalLedgers.push(curr.verticalPos - (curr.verticalPos%2));\n\t\t\t\t}\n\t\t\t\tif (dir===\"down\") {\n\t\t\t\t\troomTaken = glyphs.getSymbolWidth(noteSymbol)+2;\n\t\t\t\t} else {\n\t\t\t\t\tdotshiftx = glyphs.getSymbolWidth(noteSymbol)+2;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar pp = elem.pitches.length;\n\t\tfor (p=0; p<elem.pitches.length; p++) {\n\n\t\t\tif (!nostem) {\n\t\t\t\tvar flag;\n\t\t\t\tif ((dir===\"down\" && p!==0) || (dir===\"up\" && p!==pp-1)) { // not the stemmed elem of the chord\n\t\t\t\t\tflag = null;\n\t\t\t\t} else {\n\t\t\t\t\tflag = chartable[(dir===\"down\")?\"dflags\":\"uflags\"][-durlog];\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar c;\n\t\t\tif (elem.pitches[p].style) { // There is a style for the whole group of pitches, but there could also be an override for a particular pitch.\n\t\t\t\tc = chartable[elem.pitches[p].style][-durlog];\n\t\t\t} else\n\t\t\t\tc = noteSymbol;\n\t\t\t// The highest position for the sake of placing slurs is itself if the slur is internal. It is the highest position possible if the slur is for the whole chord.\n\t\t\t// If the note is the only one in the chord, then any slur it has counts as if it were on the whole chord.\n\t\t\telem.pitches[p].highestVert = elem.pitches[p].verticalPos;\n\t\t\tvar isTopWhenStemIsDown = (stemdir===\"up\" || dir===\"up\") && p===0;\n\t\t\tvar isBottomWhenStemIsUp = (stemdir===\"down\" || dir===\"down\") && p===pp-1;\n\t\t\tif (isTopWhenStemIsDown || isBottomWhenStemIsUp) { // place to put slurs if not already on pitches\n\n\t\t\t\tif (elem.startSlur || pp === 1) {\n\t\t\t\t\telem.pitches[p].highestVert = elem.pitches[pp-1].verticalPos;\n\t\t\t\t\tif (getDuration(elem) < 1 && (stemdir===\"up\" || dir===\"up\"))\n\t\t\t\t\t\telem.pitches[p].highestVert += 6;        // If the stem is up, then compensate for the length of the stem\n\t\t\t\t}\n\t\t\t\tif (elem.startSlur) {\n\t\t\t\t\tif (!elem.pitches[p].startSlur) elem.pitches[p].startSlur = []; //TODO possibly redundant, provided array is not optional\n\t\t\t\t\tfor (i=0; i<elem.startSlur.length; i++) {\n\t\t\t\t\t\taddIfNotExist(elem.pitches[p].startSlur, elem.startSlur[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (elem.endSlur) {\n\t\t\t\t\telem.pitches[p].highestVert = elem.pitches[pp-1].verticalPos;\n\t\t\t\t\tif (getDuration(elem) < 1 && (stemdir===\"up\" || dir===\"up\"))\n\t\t\t\t\t\telem.pitches[p].highestVert += 6;        // If the stem is up, then compensate for the length of the stem\n\t\t\t\t\tif (!elem.pitches[p].endSlur) elem.pitches[p].endSlur = []; //TODO possibly redundant, provided array is not optional\n\t\t\t\t\tfor (i=0; i<elem.endSlur.length; i++) {\n\t\t\t\t\t\taddIfNotExist(elem.pitches[p].endSlur, elem.endSlur[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar hasStem = !nostem && durlog<=-1;\n\t\t\tvar ret = createNoteHead(abselem, c, elem.pitches[p], dir, 0, -roomTaken, flag, dot, dotshiftx, this.voiceScale, accidentalSlot, !stemdir);\n\t\t\tsymbolWidth = Math.max(glyphs.getSymbolWidth(c), symbolWidth);\n\t\t\tabselem.extraw -= ret.extraLeft;\n\t\t\tnoteHead = ret.notehead;\n\t\t\tif (noteHead) {\n\t\t\t\tthis.addSlursAndTies(abselem, elem.pitches[p], noteHead, voice, hasStem ? dir : null, false);\n\n\t\t\t\tif (elem.gracenotes && elem.gracenotes.length > 0)\n\t\t\t\t\tnoteHead.bottom = noteHead.bottom - 1;\t // If there is a tie to the grace notes, leave a little more room for the note to avoid collisions.\n\t\t\t\tabselem.addHead(noteHead);\n\t\t\t}\n\t\t\troomTaken += ret.accidentalshiftx;\n\t\t\troomTakenRight = Math.max(roomTakenRight,ret.dotshiftx);\n\t\t}\n\n\t\t// draw stem from the furthest note to a pitch above/below the stemmed note\n\t\tif (hasStem) {\n\t\t\tvar stemHeight = 7 * this.voiceScale;\n\t\t\tvar p1 = (dir===\"down\") ? elem.minpitch-stemHeight : elem.minpitch+1/3;\n\t\t\t// PER added stemdir test to make the line meet the note.\n\t\t\tif (p1>6 && !stemdir) p1=6;\n\t\t\tvar p2 = (dir===\"down\") ? elem.maxpitch-1/3 : elem.maxpitch+stemHeight;\n\t\t\t// PER added stemdir test to make the line meet the note.\n\t\t\tif (p2<6 && !stemdir) p2=6;\n\t\t\tvar dx = (dir===\"down\" || abselem.heads.length === 0)?0:abselem.heads[0].w;\n\t\t\tvar width = (dir===\"down\")?1:-1;\n\t\t\t// TODO-PER-HACK: One type of note head has a different placement of the stem. This should be more generically calculated:\n\t\t\tif (noteHead.c === 'noteheads.slash.quarter') {\n\t\t\t\tif (dir === 'down')\n\t\t\t\t\tp2 -= 1;\n\t\t\t\telse\n\t\t\t\t\tp1 += 1;\n\t\t\t}\n\t\t\tabselem.addExtra(new RelativeElement(null, dx, 0, p1, {\"type\": \"stem\", \"pitch2\":p2, linewidth: width}));\n\t\t\t//var RelativeElement = function RelativeElement(c, dx, w, pitch, opt) {\n\t\t\tmin = Math.min(p1, p2);\n\t\t}\n\t\treturn { noteHead: noteHead, roomTaken: roomTaken, roomTakenRight: roomTakenRight, min: min, additionalLedgers: additionalLedgers, dir: dir, symbolWidth: symbolWidth };\n\t};\n\n\tAbstractEngraver.prototype.addLyric = function(abselem, elem) {\n\t\tvar lyricStr = \"\";\n\t\tparseCommon.each(elem.lyric, function(ly) {\n\t\t\tvar div = ly.divider === ' ' ? \"\" : ly.divider;\n\t\t\tlyricStr += ly.syllable + div + \"\\n\";\n\t\t});\n\t\tvar lyricDim = this.renderer.getTextSize(lyricStr, 'vocalfont', \"lyric\");\n\t\tvar position = elem.positioning ? elem.positioning.vocalPosition : 'below';\n\t\tabselem.addCentered(new RelativeElement(lyricStr, 0, lyricDim.width, undefined, {type:\"lyric\", position: position, height: lyricDim.height / spacing.STEP }));\n\t};\n\n\tAbstractEngraver.prototype.addChord = function(abselem, elem, roomTaken, roomTakenRight) {\n\t\tvar chordMargin = 8; // If there are chords next to each other, this is how close they can get.\n\t\tfor (var i = 0; i < elem.chord.length; i++) {\n\t\t\tvar x = 0;\n\t\t\tvar y;\n\t\t\tvar dim = this.renderer.getTextSize(elem.chord[i].name, 'annotationfont', \"annotation\");\n\t\t\tvar chordWidth = dim.width;\n\t\t\tvar chordHeight = dim.height / spacing.STEP;\n\t\t\tswitch (elem.chord[i].position) {\n\t\t\t\tcase \"left\":\n\t\t\t\t\troomTaken+=chordWidth+7;\n\t\t\t\t\tx = -roomTaken;        // TODO-PER: This is just a guess from trial and error\n\t\t\t\t\ty = elem.averagepitch;\n\t\t\t\t\tabselem.addExtra(new RelativeElement(elem.chord[i].name, x, chordWidth+4, y, {type:\"text\", height: chordHeight}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"right\":\n\t\t\t\t\troomTakenRight+=4;\n\t\t\t\t\tx = roomTakenRight;// TODO-PER: This is just a guess from trial and error\n\t\t\t\t\ty = elem.averagepitch;\n\t\t\t\t\tabselem.addRight(new RelativeElement(elem.chord[i].name, x, chordWidth+4, y, {type:\"text\", height: chordHeight}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"below\":\n\t\t\t\t\t// setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t\t\t\tabselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth+chordMargin, undefined, {type: \"text\", position: \"below\", height: chordHeight}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"above\":\n\t\t\t\t\t// setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t\t\t\tabselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth+chordMargin, undefined, {type: \"text\", height: chordHeight}));\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tif (elem.chord[i].rel_position) {\n\t\t\t\t\t\tvar relPositionY = elem.chord[i].rel_position.y + 3*spacing.STEP; // TODO-PER: this is a fudge factor to make it line up with abcm2ps\n\t\t\t\t\t\tabselem.addChild(new RelativeElement(elem.chord[i].name, x + elem.chord[i].rel_position.x, 0, elem.minpitch + relPositionY / spacing.STEP, {type: \"text\", height: chordHeight}));\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t\t\t\t\tvar pos2 = 'above';\n\t\t\t\t\t\tif (elem.positioning && elem.positioning.chordPosition)\n\t\t\t\t\t\t\tpos2 = elem.positioning.chordPosition;\n\n\t\t\t\t\t\tdim = this.renderer.getTextSize(elem.chord[i].name, 'gchordfont', \"chord\");\n\t\t\t\t\t\tchordHeight = dim.height / spacing.STEP;\n\t\t\t\t\t\tchordWidth = dim.width; // Since the chord is centered, we only use half the width.\n\t\t\t\t\t\tabselem.addCentered(new RelativeElement(elem.chord[i].name, x, chordWidth, undefined, {type: \"chord\", position: pos2, height: chordHeight }));\n\t\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn { roomTaken: roomTaken, roomTakenRight: roomTakenRight };\n\t};\n\nAbstractEngraver.prototype.createNote = function(elem, nostem, isSingleLineStaff, voice) { //stem presence: true for drawing stemless notehead\n  var notehead = null;\n  var roomtaken = 0; // room needed to the left of the note\n  var roomtakenright = 0; // room needed to the right of the note\n  var symbolWidth = 0;\n  var additionalLedgers = []; // PER: handle the case of [bc'], where the b doesn't have a ledger line\n\n  var i;\n  var dir;\n\n\tvar duration = getDuration(elem);\n\tvar zeroDuration = false;\n  if (duration === 0) { zeroDuration = true; duration = 0.25; nostem = true; }        //PER: zero duration will draw a quarter note head.\n  var durlog = Math.floor(Math.log(duration)/Math.log(2)); //TODO use getDurlog\n  var dot=0;\n\n  for (var tot = Math.pow(2,durlog), inc=tot/2; tot<duration; dot++,tot+=inc,inc/=2);\n\n\n\tif (elem.startTriplet) {\n\t\tthis.tripletmultiplier = elem.tripletMultiplier;\n\t}\n\n  var durationForSpacing = duration * this.tripletmultiplier;\n  if (elem.rest && elem.rest.type === 'multimeasure')\n  \tdurationForSpacing = 1;\n  var absType = elem.rest ? \"rest\" : \"note\";\n  var abselem = new AbsoluteElement(elem, durationForSpacing, 1, absType, this.tuneNumber, { durationClassOveride: elem.duration * this.tripletmultiplier});\n  if (hint) abselem.setHint();\n\n  if (elem.rest) {\n  \tif (this.measureLength === duration && elem.rest.type !== 'invisible' && elem.rest.type !== 'spacer')\n\t    elem.rest.type = 'whole'; // If the rest is exactly a measure, always use a whole rest\n\t  var ret1 = addRestToAbsElement(abselem, elem, duration, dot, voice.voicetotal > 1, this.stemdir, isSingleLineStaff, durlog, this.voiceScale);\n\t  notehead = ret1.noteHead;\n\t  roomtaken = ret1.roomTaken;\n\t  roomtakenright = ret1.roomTakenRight;\n  } else {\n\t  var ret2 = this.addNoteToAbcElement(abselem, elem, dot, this.stemdir, this.style, zeroDuration, durlog, nostem, voice);\n\t  if (ret2.min !== undefined)\n\t\t  this.minY = Math.min(ret2.min, this.minY);\n\t  notehead = ret2.noteHead;\n\t  roomtaken = ret2.roomTaken;\n\t  roomtakenright = ret2.roomTakenRight;\n\t  additionalLedgers = ret2.additionalLedgers;\n\t  dir = ret2.dir;\n\t  symbolWidth = ret2.symbolWidth;\n  }\n\n  if (elem.lyric !== undefined) {\n  \tthis.addLyric(abselem, elem);\n  }\n\n  if (elem.gracenotes !== undefined) {\n\troomtaken += this.addGraceNotes(elem, voice, abselem, notehead, this.stemHeight * this.voiceScale, this.isBagpipes, roomtaken);\n  }\n\n  if (elem.decoration) {\n\t  this.decoration.createDecoration(voice, elem.decoration, abselem.top, (notehead)?notehead.w:0, abselem, roomtaken, dir, abselem.bottom, elem.positioning, this.hasVocals);\n  }\n\n  if (elem.barNumber) {\n    abselem.addChild(new RelativeElement(elem.barNumber, -10, 0, 0, {type:\"barNumber\"}));\n  }\n\n  // ledger lines\n\tledgerLines(abselem, elem.minpitch, elem.maxpitch, elem.rest, symbolWidth, additionalLedgers, dir, -2, 1);\n\n  if (elem.chord !== undefined) {\n  \tvar ret3 = this.addChord(abselem, elem, roomtaken, roomtakenright);\n\t  roomtaken = ret3.roomTaken;\n\t  roomtakenright = ret3.roomTakenRight;\n  }\n\n\n  if (elem.startTriplet) {\n    this.triplet = new TripletElem(elem.startTriplet, notehead, { flatBeams: this.flatBeams }); // above is opposite from case of slurs\n  }\n\n  if (elem.endTriplet && this.triplet) {\n    this.triplet.setCloseAnchor(notehead);\n  }\n\n  if (this.triplet && !elem.startTriplet && !elem.endTriplet) {\n  \tthis.triplet.middleNote(notehead);\n  }\n\n\n  return abselem;\n};\n\n\n\n\nvar createNoteHead = function(abselem, c, pitchelem, dir, headx, extrax, flag, dot, dotshiftx, scale, accidentalSlot, shouldExtendStem) {\n  // TODO scale the dot as well\n  var pitch = pitchelem.verticalPos;\n  var notehead;\n  var i;\n  var accidentalshiftx = 0;\n  var newDotShiftX = 0;\n  var extraLeft = 0;\n  if (c === undefined)\n    abselem.addChild(new RelativeElement(\"pitch is undefined\", 0, 0, 0, {type:\"debug\"}));\n  else if (c===\"\") {\n    notehead = new RelativeElement(null, 0, 0, pitch);\n  } else {\n    var shiftheadx = headx;\n    if (pitchelem.printer_shift) {\n      var adjust = (pitchelem.printer_shift===\"same\")?1:0;\n      shiftheadx = (dir===\"down\")?-glyphs.getSymbolWidth(c)*scale+adjust:glyphs.getSymbolWidth(c)*scale-adjust;\n    }\n\t  var opts = {scalex:scale, scaley: scale, thickness: glyphs.symbolHeightInPitches(c)*scale };\n    notehead = new RelativeElement(c, shiftheadx, glyphs.getSymbolWidth(c)*scale, pitch, opts);\n    notehead.stemDir = dir;\n    if (flag) {\n      var pos = pitch+((dir===\"down\")?-7:7)*scale;\n      // if this is a regular note, (not grace or tempo indicator) then the stem will have been stretched to the middle line if it is far from the center.\n\t    if (shouldExtendStem) {\n\t    \tif (dir===\"down\" && pos > 6)\n\t    \t\tpos = 6;\n\t    \tif (dir===\"up\" && pos < 6)\n\t    \t\tpos = 6;\n\t    }\n      //if (scale===1 && (dir===\"down\")?(pos>6):(pos<6)) pos=6;\n      var xdelta = (dir===\"down\")?headx:headx+notehead.w-0.6;\n      abselem.addRight(new RelativeElement(flag, xdelta, glyphs.getSymbolWidth(flag)*scale, pos, {scalex:scale, scaley: scale}));\n    }\n\t  newDotShiftX = notehead.w+dotshiftx-2+5*dot;\n    for (;dot>0;dot--) {\n      var dotadjusty = (1-Math.abs(pitch)%2); //PER: take abs value of the pitch. And the shift still happens on ledger lines.\n      abselem.addRight(new RelativeElement(\"dots.dot\", notehead.w+dotshiftx-2+5*dot, glyphs.getSymbolWidth(\"dots.dot\"), pitch+dotadjusty));\n    }\n  }\n        if (notehead)\n                notehead.highestVert = pitchelem.highestVert;\n\n  if (pitchelem.accidental) {\n    var symb;\n    switch (pitchelem.accidental) {\n    case \"quartersharp\":\n      symb = \"accidentals.halfsharp\";\n        break;\n    case \"dblsharp\":\n      symb = \"accidentals.dblsharp\";\n      break;\n    case \"sharp\":\n      symb = \"accidentals.sharp\";\n      break;\n    case \"quarterflat\":\n      symb = \"accidentals.halfflat\";\n      break;\n    case \"flat\":\n      symb = \"accidentals.flat\";\n      break;\n    case \"dblflat\":\n      symb = \"accidentals.dblflat\";\n      break;\n    case \"natural\":\n      symb = \"accidentals.nat\";\n    }\n         // if a note is at least a sixth away, it can share a slot with another accidental\n         var accSlotFound = false;\n         var accPlace = extrax;\n         for (var j = 0; j < accidentalSlot.length; j++) {\n                 if (pitch - accidentalSlot[j][0] >= 6) {\n                         accidentalSlot[j][0] = pitch;\n                         accPlace = accidentalSlot[j][1];\n                         accSlotFound = true;\n                         break;\n                 }\n         }\n         if (accSlotFound === false) {\n                 accPlace -= (glyphs.getSymbolWidth(symb)*scale+2);\n                 accidentalSlot.push([pitch,accPlace]);\n                 accidentalshiftx = (glyphs.getSymbolWidth(symb)*scale+2);\n         }\n    abselem.addExtra(new RelativeElement(symb, accPlace, glyphs.getSymbolWidth(symb), pitch, {scalex:scale, scaley: scale}));\n\t  extraLeft = glyphs.getSymbolWidth(symb) / 2; // TODO-PER: We need a little extra width if there is an accidental, but I'm not sure why it isn't the full width of the accidental.\n  }\n\n  return { notehead: notehead, accidentalshiftx: accidentalshiftx, dotshiftx: newDotShiftX, extraLeft: extraLeft };\n\n};\n\n\tAbstractEngraver.prototype.addSlursAndTies = function(abselem, pitchelem, notehead, voice, dir, isGrace) {\n\t\tif (pitchelem.endTie) {\n\t\t\tif (this.ties.length > 0) {\n\t\t\t\t// If there are multiple open ties, find the one that applies by matching the pitch, if possible.\n\t\t\t\tvar found = false;\n\t\t\t\tfor (var j = 0; j < this.ties.length; j++) {\n\t\t\t\t\tif (this.ties[j].anchor1 && this.ties[j].anchor1.pitch === notehead.pitch) {\n\t\t\t\t\t\tthis.ties[j].setEndAnchor(notehead);\n\t\t\t\t\t\tthis.ties.splice(j, 1);\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!found) {\n\t\t\t\t\tthis.ties[0].setEndAnchor(notehead);\n\t\t\t\t\tthis.ties.splice(0, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar voiceNumber = voice.voicetotal < 2 ? -1 : voice.voicenumber;\n\t\tif (pitchelem.startTie) {\n\t\t\tvar tie = new TieElem({ anchor1: notehead, force: (this.stemdir===\"down\" || this.stemdir===\"up\"), stemDir: this.stemdir, isGrace: isGrace, voiceNumber: voiceNumber});\n\t\t\tif (hint) tie.setHint();\n\n\t\t\tthis.ties[this.ties.length]=tie;\n\t\t\tvoice.addOther(tie);\n\t\t\t// HACK-PER: For the animation, we need to know if a note is tied to the next one, so here's a flag.\n\t\t\t// Unfortunately, only some of the notes in the current event might be tied, but this will consider it\n\t\t\t// tied if any one of them is. That will work for most cases.\n\t\t\tabselem.startTie = true;\n\t\t}\n\n\t\tif (pitchelem.endSlur) {\n\t\t\tfor (var i=0; i<pitchelem.endSlur.length; i++) {\n\t\t\t\tvar slurid = pitchelem.endSlur[i];\n\t\t\t\tvar slur;\n\t\t\t\tif (this.slurs[slurid]) {\n\t\t\t\t\tslur = this.slurs[slurid];\n\t\t\t\t\tslur.setEndAnchor(notehead);\n\t\t\t\t\tdelete this.slurs[slurid];\n\t\t\t\t} else {\n\t\t\t\t\tslur = new TieElem({ anchor2: notehead, stemDir: this.stemdir, voiceNumber: voiceNumber});\n\t\t\t\t\tif (hint) slur.setHint();\n\t\t\t\t\tvoice.addOther(slur);\n\t\t\t\t}\n\t\t\t\tif (this.startlimitelem) {\n\t\t\t\t\tslur.setStartX(this.startlimitelem);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (!isGrace) {\n\t\t\tfor (var s in this.slurs) {\n\t\t\t\tif (this.slurs.hasOwnProperty(s)) {\n\t\t\t\t\tthis.slurs[s].addInternalNote(notehead);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (pitchelem.startSlur) {\n\t\t\tfor (i=0; i<pitchelem.startSlur.length; i++) {\n\t\t\t\tvar slurid = pitchelem.startSlur[i].label;\n\t\t\t\tvar slur = new TieElem({ anchor1: notehead, stemDir: this.stemdir, voiceNumber: voiceNumber});\n\t\t\t\tif (hint) slur.setHint();\n\t\t\t\tthis.slurs[slurid]=slur;\n\t\t\t\tvoice.addOther(slur);\n\t\t\t}\n\t\t}\n\t};\n\nAbstractEngraver.prototype.addMeasureNumber = function (number, abselem) {\n\tvar measureNumHeight = this.renderer.getTextSize(number, \"measurefont\", 'bar-number');\n\tabselem.addChild(new RelativeElement(number, 0, 0, 11+measureNumHeight.height / spacing.STEP, {type:\"barNumber\"}));\n};\n\nAbstractEngraver.prototype.createBarLine = function (voice, elem, isFirstStaff) {\n// bar_thin, bar_thin_thick, bar_thin_thin, bar_thick_thin, bar_right_repeat, bar_left_repeat, bar_double_repeat\n\n  var abselem = new AbsoluteElement(elem, 0, 10, 'bar', this.tuneNumber);\n  var anchor = null; // place to attach part lines\n  var dx = 0;\n\n\tif (elem.barNumber) {\n\t\tthis.addMeasureNumber(elem.barNumber, abselem);\n\t}\n\n\n  var firstdots = (elem.type===\"bar_right_repeat\" || elem.type===\"bar_dbl_repeat\");\n  var firstthin = (elem.type!==\"bar_left_repeat\" && elem.type!==\"bar_thick_thin\" && elem.type!==\"bar_invisible\");\n  var thick = (elem.type===\"bar_right_repeat\" || elem.type===\"bar_dbl_repeat\" || elem.type===\"bar_left_repeat\" ||\n         elem.type===\"bar_thin_thick\" || elem.type===\"bar_thick_thin\");\n  var secondthin = (elem.type===\"bar_left_repeat\" || elem.type===\"bar_thick_thin\" || elem.type===\"bar_thin_thin\" || elem.type===\"bar_dbl_repeat\");\n  var seconddots = (elem.type===\"bar_left_repeat\" || elem.type===\"bar_dbl_repeat\");\n\n  // limit positioning of slurs\n  if (firstdots || seconddots) {\n    for (var slur in this.slurs) {\n      if (this.slurs.hasOwnProperty(slur)) {\n        this.slurs[slur].setEndX(abselem);\n      }\n    }\n    this.startlimitelem = abselem;\n  }\n\n  if (firstdots) {\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n    dx+=6; //2 hardcoded, twice;\n  }\n\n  if (firstthin) {\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor);\n  }\n\n  if (elem.type===\"bar_invisible\") {\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"none\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor);\n  }\n\n  if (elem.decoration) {\n    this.decoration.createDecoration(voice, elem.decoration, 12, (thick)?3:1, abselem, 0, \"down\", 2, elem.positioning, this.hasVocals);\n  }\n\n  if (thick) {\n    dx+=4; //3 hardcoded;\n    anchor = new RelativeElement(null, dx, 4, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:4});\n    abselem.addRight(anchor);\n    dx+=5;\n  }\n\n// if (this.partstartelem && (thick || (firstthin && secondthin))) { // means end of nth part\n// this.partstartelem.anchor2=anchor;\n// this.partstartelem = null;\n// }\n\n  if (this.partstartelem && elem.endEnding) {\n    this.partstartelem.anchor2=anchor;\n    this.partstartelem = null;\n  }\n\n  if (secondthin) {\n    dx+=3; //3 hardcoded;\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor); // 3 is hardcoded\n  }\n\n  if (seconddots) {\n    dx+=3; //3 hardcoded;\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n  } // 2 is hardcoded\n\n  if (elem.startEnding && isFirstStaff) { // only put the first & second ending marks on the first staff\n\t  var textWidth = this.renderer.getTextSize(elem.startEnding, \"repeatfont\", '').width;\n\t  abselem.minspacing += textWidth + 10; // Give plenty of room for the ending number.\n    this.partstartelem = new EndingElem(elem.startEnding, anchor, null);\n\t  voice.addOther(this.partstartelem);\n  }\n\n  // Add a little space to the left of the bar line so that nothing can crowd it.\n\tabselem.extraw -= 5;\n\n\treturn abselem;\n\n};\n\n\n})();\n\nmodule.exports = AbstractEngraver;\n"]},"metadata":{},"sourceType":"script"}