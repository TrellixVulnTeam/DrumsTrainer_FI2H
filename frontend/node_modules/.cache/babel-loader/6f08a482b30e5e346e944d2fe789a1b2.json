{"ast":null,"code":"//    abc_midi_flattener.js: Turn a linear series of events into a series of MIDI commands.\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com) and Paul Rosen\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n// We input a set of voices, but the notes are still complex. This pass changes the logical definitions\n// of the grace notes, decorations, ties, triplets, rests, transpositions, keys, and accidentals into actual note durations.\n// It also extracts guitar chords to a separate voice and resolves their rhythm.\nvar flatten;\n\n(function () {\n  \"use strict\";\n\n  var barAccidentals;\n  var accidentals;\n  var transpose;\n  var bagpipes;\n  var multiplier;\n  var tracks;\n  var startingTempo;\n  var startingMeter;\n  var tempoChangeFactor = 1;\n  var instrument;\n  var currentInstrument; // var channel;\n\n  var currentTrack;\n  var pitchesTied;\n  var lastNoteDurationPosition;\n  var currentTrackCounter;\n  var meter = {\n    num: 4,\n    den: 4\n  };\n  var chordTrack;\n  var chordTrackFinished;\n  var chordChannel;\n  var chordInstrument = 0;\n  var drumInstrument = 128;\n  var currentChords;\n  var lastChord;\n  var barBeat;\n  var gChordTacet = false;\n  var doBeatAccents = true;\n  var stressBeat1 = 105;\n  var stressBeatDown = 95;\n  var stressBeatUp = 85;\n  var beatFraction = 0.25;\n  var nextVolume;\n  var nextVolumeDelta;\n  var drumTrack;\n  var drumTrackFinished;\n  var drumDefinition = {};\n  var normalBreakBetweenNotes = 1.0 / 128; // a 128th note of silence between notes for articulation.\n\n  flatten = function (voices, options) {\n    if (!options) options = {};\n    barAccidentals = [];\n    accidentals = [0, 0, 0, 0, 0, 0, 0];\n    bagpipes = false;\n    multiplier = 1;\n    tracks = [];\n    startingTempo = undefined;\n    startingMeter = undefined;\n    tempoChangeFactor = 1;\n    instrument = undefined;\n    currentInstrument = undefined; // channel = undefined;\n\n    currentTrack = undefined;\n    currentTrackCounter = undefined;\n    pitchesTied = {}; // For resolving chords.\n\n    meter = {\n      num: 4,\n      den: 4\n    };\n    chordTrack = [];\n    chordChannel = voices.length; // first free channel for chords\n\n    chordTrackFinished = false;\n    currentChords = [];\n    lastChord = undefined;\n    barBeat = 0;\n    gChordTacet = options.chordsOff ? true : false;\n    doBeatAccents = true;\n    stressBeat1 = 105;\n    stressBeatDown = 95;\n    stressBeatUp = 85;\n    beatFraction = 0.25;\n    nextVolume = undefined;\n    nextVolumeDelta = undefined; // For the drum/metronome track.\n\n    drumTrack = [];\n    drumTrackFinished = false;\n    drumDefinition = {};\n    zeroOutMilliseconds(voices);\n\n    for (var i = 0; i < voices.length; i++) {\n      transpose = 0;\n      lastNoteDurationPosition = -1;\n      var voice = voices[i];\n      currentTrack = [{\n        cmd: 'program',\n        channel: i,\n        instrument: instrument\n      }];\n      currentTrackCounter = 0;\n      pitchesTied = {};\n\n      for (var j = 0; j < voice.length; j++) {\n        var element = voice[j];\n\n        switch (element.el_type) {\n          case \"note\":\n            writeNote(element, options.voicesOff);\n            break;\n\n          case \"key\":\n            accidentals = setKeySignature(element);\n            break;\n\n          case \"meter\":\n            if (!startingMeter) startingMeter = element;\n            meter = element;\n            beatFraction = getBeatFraction(meter);\n            break;\n\n          case \"tempo\":\n            if (!startingTempo) startingTempo = element.qpm;else tempoChangeFactor = element.qpm ? startingTempo / element.qpm : 1;\n            break;\n\n          case \"transpose\":\n            transpose = element.transpose;\n            break;\n\n          case \"bar\":\n            if (chordTrack.length > 0 && i === 0) {\n              resolveChords();\n              currentChords = [];\n            }\n\n            barBeat = 0;\n            barAccidentals = [];\n            if (i === 0) // Only write the drum part on the first voice so that it is not duplicated.\n              writeDrum(voices.length + 1);\n            break;\n\n          case \"bagpipes\":\n            bagpipes = true;\n            break;\n\n          case \"instrument\":\n            if (instrument === undefined) instrument = element.program;\n            currentInstrument = element.program;\n            if (currentTrack.length > 0 && currentTrack[currentTrack.length - 1].cmd === 'program') currentTrack[currentTrack.length - 1].instrument = element.program;else {\n              var ii;\n\n              for (ii = currentTrack.length - 1; ii >= 0 && currentTrack[ii].cmd !== 'program'; ii--);\n\n              if (ii < 0 || currentTrack[ii].instrument !== element.program) currentTrack.push({\n                cmd: 'program',\n                channel: i,\n                instrument: element.program\n              });\n            }\n            break;\n\n          case \"channel\":\n            // \tif (channel === undefined)\n            // \t\tchannel = element.channel;\n            // \tcurrentTrack[0].channel = element.channel;\n            break;\n\n          case \"drum\":\n            drumDefinition = normalizeDrumDefinition(element.params);\n            break;\n\n          case \"gchord\":\n            if (!options.chordsOff) gChordTacet = element.tacet;\n            break;\n\n          case \"beat\":\n            stressBeat1 = element.beats[0];\n            stressBeatDown = element.beats[1];\n            stressBeatUp = element.beats[2]; // TODO-PER: also use the last parameter - which changes which beats are strong.\n\n            break;\n\n          case \"vol\":\n            nextVolume = element.volume;\n            break;\n\n          case \"volinc\":\n            nextVolumeDelta = element.volume;\n            break;\n\n          case \"beataccents\":\n            doBeatAccents = element.value;\n            break;\n\n          default:\n            // This should never happen\n            console.log(\"MIDI creation. Unknown el_type: \" + element.el_type + \"\\n\"); // jshint ignore:line\n\n            break;\n        }\n      }\n\n      if (currentTrack[0].instrument === undefined) currentTrack[0].instrument = instrument ? instrument : 0;\n      tracks.push(currentTrack);\n      if (chordTrack.length > 0) // Don't do chords on more than one track, so turn off chord detection after we create it.\n        chordTrackFinished = true;\n      if (drumTrack.length > 0) // Don't do drums on more than one track, so turn off drum after we create it.\n        drumTrackFinished = true;\n    }\n\n    if (chordTrack.length > 0) tracks.push(chordTrack);\n    if (drumTrack.length > 0) tracks.push(drumTrack); // Adjust the tempo according to the meter. The rules are this:\n    // 1) If the denominator is 2 or 4, then always make a beat be the denominator.\n    //\n    // 2) If the denominator is 8 or 16, then:\n    // a) If the numerator is divisible by 3, the beat is 3*denominator.\n    // b) Otherwise the beat is the denominator.\n    //\n    // 3) If the denominator is anything else, then don't worry about it because it doesn't make sense. Don't modify it and hope for the best.\n    //\n    // Right now, the startingTempo is calculated for a quarter note, so modify it if necessary.\n    // var num = startingMeter ? parseInt(startingMeter.num, 10) : meter.num;\n    // var den = startingMeter ? parseInt(startingMeter.den, 10) : meter.den;\n    // if (den === 2)\n    // \tstartingTempo *= 2;\n    // else if (den === 8) {\n    // \tif (parseInt(num, 10) % 3 === 0)\n    // \t\tstartingTempo *= 3/2;\n    // \telse\n    // \t\tstartingTempo /= 2;\n    // } else if (den === 16) {\n    // \tif (num % 3 === 0)\n    // \t\tstartingTempo *= 3/4;\n    // \telse\n    // \t\tstartingTempo /= 4;\n    // }\n\n    return {\n      tempo: startingTempo,\n      instrument: instrument,\n      tracks: tracks,\n      totalDuration: totalDuration(tracks)\n    };\n  };\n\n  function zeroOutMilliseconds(voices) {\n    for (var i = 0; i < voices.length; i++) {\n      var voice = voices[i];\n\n      for (var j = 0; j < voice.length; j++) {\n        var element = voice[j];\n        delete element.currentTrackMilliseconds;\n      }\n    }\n  }\n\n  function totalDuration(tracks) {\n    var total = 0;\n\n    for (var i = 0; i < tracks.length; i++) {\n      var track = tracks[i];\n      var trackTotal = 0;\n\n      for (var j = 0; j < track.length; j++) {\n        var event = track[j];\n        if (event.duration) trackTotal += event.duration;\n      }\n\n      total = Math.max(total, trackTotal);\n    }\n\n    return total;\n  }\n\n  function getBeatFraction(meter) {\n    switch (meter.den) {\n      case 2:\n        return 0.5;\n\n      case 4:\n        return 0.25;\n\n      case 8:\n        return 0.375;\n\n      case 16:\n        return 0.125;\n    }\n\n    return 0.25;\n  } //\n  // The algorithm for chords is:\n  // - The chords are done in a separate track.\n  // - If there are notes before the first chord, then put that much silence to start the track.\n  // - The pattern of chord expression depends on the meter, and how many chords are in a measure.\n  // - There is a possibility that a measure will have an incorrect number of beats, if that is the case, then\n  // start the pattern anew on the next measure number.\n  // - If a chord root is not A-G, then ignore it as if the chord wasn't there at all.\n  // - If a chord modification isn't in our supported list, change it to a major triad.\n  //\n  // - If there is only one chord in a measure:\n  //\t\t- If 2/4, play root chord\n  //\t\t- If cut time, play root(1) chord(3)\n  //\t\t- If 3/4, play root chord chord\n  //\t\t- If 4/4 or common time, play root chord fifth chord\n  //\t\t- If 6/8, play root(1) chord(3) fifth(4) chord(6)\n  //\t\t- For any other meter, play the full chord on each beat. (TODO-PER: expand this as more support is added.)\n  //\n  //\t- If there is a chord specified that is not on a beat, move it earlier to the previous beat, unless there is already a chord on that beat.\n  //\t- Otherwise, move it later, unless there is already a chord on that beat.\n  // \t- Otherwise, ignore it. (TODO-PER: expand this as more support is added.)\n  //\n  // - If there is a chord on the second beat, play a chord for the first beat instead of a bass note.\n  // - Likewise, if there is a chord on the fourth beat of 4/4, play a chord on the third beat instead of a bass note.\n  //\n\n\n  var breakSynonyms = ['break', '(break)', 'no chord', 'n.c.', 'tacet'];\n\n  function findChord(elem) {\n    if (gChordTacet) return 'break'; // TODO-PER: Just using the first chord if there are more than one.\n\n    if (chordTrackFinished || !elem.chord || elem.chord.length === 0) return null; // Return the first annotation that is a regular chord: that is, it is in the default place or is a recognized \"tacet\" phrase.\n\n    for (var i = 0; i < elem.chord.length; i++) {\n      var ch = elem.chord[i];\n      if (ch.position === 'default') return ch.name;\n      if (breakSynonyms.indexOf(ch.name.toLowerCase()) >= 0) return 'break';\n    }\n\n    return null;\n  }\n\n  function timeFromStart() {\n    var distance = 0;\n\n    for (var ct = 0; ct < currentTrack.length; ct++) {\n      if (currentTrack[ct].cmd === 'move') distance += currentTrack[ct].duration;\n    }\n\n    return distance;\n  }\n\n  function writeNote(elem, voiceOff) {\n    //\n    // Create a series of note events to append to the current track.\n    // The output event is one of: { pitchStart: pitch_in_abc_units, volume: from_1_to_64 }\n    // { pitchStop: pitch_in_abc_units }\n    // { moveTime: duration_in_abc_units }\n    // If there are guitar chords, then they are put in a separate track, but they have the same format.\n    //\n    var volume;\n\n    if (nextVolume) {\n      volume = nextVolume;\n      nextVolume = undefined;\n    } else if (!doBeatAccents) {\n      volume = stressBeatDown;\n    } else {\n      if (barBeat === 0) volume = stressBeat1;else if (barBeat % beatFraction < 0.001) // A little slop because of JavaScript floating point math.\n        volume = stressBeatDown;else volume = stressBeatUp;\n    }\n\n    if (nextVolumeDelta) {\n      volume += nextVolumeDelta;\n      nextVolumeDelta = undefined;\n    }\n\n    if (volume < 0) volume = 0;\n    if (volume > 127) volume = 127;\n    var velocity = voiceOff ? 0 : volume;\n    var chord = findChord(elem);\n\n    if (chord) {\n      var c = interpretChord(chord); // If this isn't a recognized chord, just completely ignore it.\n\n      if (c) {\n        // If we ever have a chord in this voice, then we add the chord track.\n        // However, if there are chords on more than one voice, then just use the first voice.\n        if (chordTrack.length === 0) {\n          chordTrack.push({\n            cmd: 'program',\n            channel: chordChannel,\n            instrument: chordInstrument\n          }); // need to figure out how far in time the chord started: if there are pickup notes before the chords start, we need pauses.\n\n          var distance = timeFromStart();\n          if (distance > 0) chordTrack.push({\n            cmd: 'move',\n            duration: distance * tempoChangeFactor\n          });\n        }\n\n        lastChord = c;\n        currentChords.push({\n          chord: lastChord,\n          beat: barBeat\n        });\n      }\n    }\n\n    if (elem.startTriplet) {\n      multiplier = elem.tripletMultiplier;\n    }\n\n    var duration = (elem.durationClass ? elem.durationClass : elem.duration) * multiplier;\n    barBeat += duration; // if there are grace notes, then also play them.\n    // I'm not sure there is an exact rule for the length of the notes. My rule, unless I find\n    // a better one is: the grace notes cannot take more than 1/2 of the main note's value.\n    // A grace note (of 1/8 note duration) takes 1/8 of the main note's value.\n\n    var graces;\n\n    if (elem.gracenotes) {\n      // There are two cases: if this is bagpipe, the grace notes are played on the beat with the current note.\n      // Normally, the grace notes would be played before the beat. (If this is the first note in the track, however, then it is played on the current beat.)\n      // The reason for the exception on the first note is that it would otherwise move the whole track in time and would affect all the other tracks.\n      var stealFromCurrent = bagpipes || lastNoteDurationPosition < 0 || currentTrack.length === 0;\n      var stealFromDuration = stealFromCurrent ? duration : currentTrack[lastNoteDurationPosition].duration;\n      graces = processGraceNotes(elem.gracenotes, stealFromDuration);\n\n      if (!bagpipes) {\n        duration = writeGraceNotes(graces, stealFromCurrent, duration, null, velocity);\n      }\n    } // The currentTrackCounter is the number of whole notes from the beginning of the piece.\n    // The beat fraction is the note that gets a beat (.25 is a quarter note)\n    // The tempo is in minutes and we want to get to milliseconds.\n\n\n    if (!elem.currentTrackMilliseconds) elem.currentTrackMilliseconds = [];\n    elem.currentTrackMilliseconds.push(currentTrackCounter / beatFraction / startingTempo * 60 * 1000);\n\n    if (elem.pitches) {\n      if (graces && bagpipes) {\n        // If it is bagpipes, then the graces are played with the note. If the grace has the same pitch as the note, then we just skip it.\n        duration = writeGraceNotes(graces, true, duration, null, velocity);\n      }\n\n      var pitches = [];\n      elem.midiPitches = [];\n\n      for (var i = 0; i < elem.pitches.length; i++) {\n        var note = elem.pitches[i];\n        var actualPitch = adjustPitch(note);\n        pitches.push({\n          pitch: actualPitch,\n          startTie: note.startTie\n        });\n        elem.midiPitches.push({\n          pitch: actualPitch + 60,\n          durationInMeasures: duration * tempoChangeFactor,\n          volume: volume,\n          instrument: currentInstrument\n        }); // TODO-PER: why is the internal numbering system offset by 60 from midi? It should probably be the same as midi.\n\n        if (!pitchesTied['' + actualPitch]) // If this is the second note of a tie, we don't start it again.\n          currentTrack.push({\n            cmd: 'start',\n            pitch: actualPitch,\n            volume: velocity\n          });else {\n          // but we do add the duration to what we call back.\n          for (var last = currentTrack.length - 1; last >= 0; last--) {\n            if (currentTrack[last].cmd === 'start' && currentTrack[last].pitch === actualPitch && currentTrack[last].elem) {\n              var pitchArray = currentTrack[last].elem.midiPitches;\n\n              for (var last2 = 0; last2 < pitchArray.length; last2++) {\n                if (pitchArray[last2].pitch - 60 === actualPitch) {\n                  // TODO-PER: the 60 is to compensate for the midi pitch numbers again.\n                  pitchArray[last2].durationInMeasures += duration * tempoChangeFactor;\n                }\n              }\n\n              break;\n            }\n          }\n        }\n\n        if (note.startTie) {\n          pitchesTied['' + actualPitch] = true;\n          currentTrack[currentTrack.length - 1].elem = elem;\n        } else if (note.endTie) pitchesTied['' + actualPitch] = false;\n      }\n\n      if (elem.gracenotes) {\n        for (var j = 0; j < elem.gracenotes.length; j++) {\n          elem.midiGraceNotePitches = [];\n          var grace = elem.gracenotes[j];\n          elem.midiGraceNotePitches.push({\n            pitch: adjustPitch(grace) + 60,\n            durationInMeasures: 0,\n            volume: volume,\n            instrument: currentInstrument\n          });\n        }\n      }\n\n      var thisBreakBetweenNotes = normalBreakBetweenNotes;\n      var soundDuration = duration - normalBreakBetweenNotes;\n\n      if (soundDuration < 0) {\n        soundDuration = 0;\n        thisBreakBetweenNotes = 0;\n      }\n\n      currentTrack.push({\n        cmd: 'move',\n        duration: soundDuration * tempoChangeFactor\n      });\n      lastNoteDurationPosition = currentTrack.length - 1;\n      currentTrackCounter += soundDuration * tempoChangeFactor;\n\n      for (var ii = 0; ii < pitches.length; ii++) {\n        if (!pitchesTied['' + pitches[ii].pitch]) currentTrack.push({\n          cmd: 'stop',\n          pitch: pitches[ii].pitch\n        });\n      }\n\n      currentTrack.push({\n        cmd: 'move',\n        duration: thisBreakBetweenNotes * tempoChangeFactor\n      });\n      currentTrackCounter += thisBreakBetweenNotes * tempoChangeFactor;\n    } else if (elem.rest) {\n      currentTrack.push({\n        cmd: 'move',\n        duration: duration * tempoChangeFactor\n      });\n      currentTrackCounter += duration * tempoChangeFactor;\n    }\n\n    if (elem.endTriplet) {\n      multiplier = 1;\n    }\n  }\n\n  var scale = [0, 2, 4, 5, 7, 9, 11];\n\n  function adjustPitch(note) {\n    if (note.midipitch) return note.midipitch - 60;\n    var pitch = note.pitch;\n\n    if (note.accidental) {\n      switch (note.accidental) {\n        // change that pitch (not other octaves) for the rest of the bar\n        case \"sharp\":\n          barAccidentals[pitch] = 1;\n          break;\n\n        case \"flat\":\n          barAccidentals[pitch] = -1;\n          break;\n\n        case \"natural\":\n          barAccidentals[pitch] = 0;\n          break;\n\n        case \"dblsharp\":\n          barAccidentals[pitch] = 2;\n          break;\n\n        case \"dblflat\":\n          barAccidentals[pitch] = -2;\n          break;\n      }\n    }\n\n    var actualPitch = extractOctave(pitch) * 12 + scale[extractNote(pitch)];\n\n    if (barAccidentals[pitch] !== undefined) {\n      actualPitch += barAccidentals[pitch];\n    } else {\n      // use normal accidentals\n      actualPitch += accidentals[extractNote(pitch)];\n    }\n\n    actualPitch += transpose;\n    return actualPitch;\n  }\n\n  function setKeySignature(elem) {\n    var accidentals = [0, 0, 0, 0, 0, 0, 0];\n    if (!elem.accidentals) return accidentals;\n\n    for (var i = 0; i < elem.accidentals.length; i++) {\n      var acc = elem.accidentals[i];\n      var d = acc.acc === \"sharp\" ? 1 : acc.acc === \"natural\" ? 0 : -1;\n      var lowercase = acc.note.toLowerCase();\n      var note = extractNote(lowercase.charCodeAt(0) - 'c'.charCodeAt(0));\n      accidentals[note] += d;\n    }\n\n    return accidentals;\n  }\n\n  var graceDivider = 8; // This is the fraction of a note that the grace represents. That is, if this is 2, then a grace note of 1/16 would be a 1/32.\n\n  function processGraceNotes(graces, companionDuration) {\n    var graceDuration = 0;\n    var ret = [];\n    var grace;\n\n    for (var g = 0; g < graces.length; g++) {\n      grace = graces[g];\n      graceDuration += grace.duration;\n    }\n\n    graceDuration = graceDuration / graceDivider;\n    var multiplier = graceDuration * 2 > companionDuration ? companionDuration / (graceDuration * 2) : 1;\n\n    for (g = 0; g < graces.length; g++) {\n      grace = graces[g];\n      var pitch = grace.midipitch ? grace.midipitch - 60 : grace.pitch;\n      ret.push({\n        pitch: pitch,\n        duration: grace.duration / graceDivider * multiplier\n      });\n    }\n\n    return ret;\n  }\n\n  function writeGraceNotes(graces, stealFromCurrent, duration, skipNote, velocity) {\n    for (var g = 0; g < graces.length; g++) {\n      var gp = graces[g];\n      if (gp !== skipNote) currentTrack.push({\n        cmd: 'start',\n        pitch: gp.pitch,\n        volume: velocity\n      });\n      currentTrack.push({\n        cmd: 'move',\n        duration: graces[g].duration * tempoChangeFactor\n      });\n      if (gp !== skipNote) currentTrack.push({\n        cmd: 'stop',\n        pitch: gp.pitch\n      });\n      if (!stealFromCurrent) currentTrack[lastNoteDurationPosition].duration -= graces[g].duration;\n      duration -= graces[g].duration;\n    }\n\n    return duration;\n  }\n\n  function extractOctave(pitch) {\n    return Math.floor(pitch / 7);\n  }\n\n  function extractNote(pitch) {\n    pitch = pitch % 7;\n    if (pitch < 0) pitch += 7;\n    return pitch;\n  }\n\n  var basses = {\n    'A': -27,\n    'B': -25,\n    'C': -24,\n    'D': -22,\n    'E': -20,\n    'F': -19,\n    'G': -17\n  };\n\n  function interpretChord(name) {\n    // chords have the format:\n    // [root][acc][modifier][/][bass][acc]\n    // (The chord might be surrounded by parens. Just ignore them.)\n    // root must be present and must be from A-G.\n    // acc is optional and can be # or b\n    // The modifier can be a wide variety of things, like \"maj7\". As they are discovered, more are supported here.\n    // If there is a slash, then there is a bass note, which can be from A-G, with an optional acc.\n    // If the root is unrecognized, then \"undefined\" is returned and there is no chord.\n    // If the modifier is unrecognized, a major triad is returned.\n    // If the bass notes is unrecognized, it is ignored.\n    if (name.length === 0) return undefined;\n    if (name === 'break') return {\n      chick: []\n    };\n    var root = name.substring(0, 1);\n\n    if (root === '(') {\n      name = name.substring(1, name.length - 2);\n      if (name.length === 0) return undefined;\n      root = name.substring(0, 1);\n    }\n\n    var bass = basses[root];\n    if (!bass) // If the bass note isn't listed, then this was an unknown root. Only A-G are accepted.\n      return undefined;\n    bass += transpose;\n    var bass2 = bass - 5; // The alternating bass is a 4th below\n\n    var chick;\n    if (name.length === 1) chick = chordNotes(bass, '');\n    var remaining = name.substring(1);\n    var acc = remaining.substring(0, 1);\n\n    if (acc === 'b' || acc === '♭') {\n      bass--;\n      bass2--;\n      remaining = remaining.substring(1);\n    } else if (acc === '#' || acc === '♯') {\n      bass++;\n      bass2++;\n      remaining = remaining.substring(1);\n    }\n\n    var arr = remaining.split('/');\n    chick = chordNotes(bass, arr[0]);\n\n    if (arr.length === 2) {\n      var explicitBass = basses[arr[1].substring(0, 1)];\n\n      if (explicitBass) {\n        var bassAcc = arr[1].substring(1);\n        var bassShift = {\n          '#': 1,\n          '♯': 1,\n          'b': -1,\n          '♭': -1\n        }[bassAcc] || 0;\n        bass = basses[arr[1].substring(0, 1)] + bassShift + transpose;\n        bass2 = bass;\n      }\n    }\n\n    return {\n      boom: bass,\n      boom2: bass2,\n      chick: chick\n    };\n  }\n\n  var chordIntervals = {\n    // diminished (all flat 5 chords)\n    'dim': [0, 3, 6],\n    '°': [0, 3, 6],\n    '˚': [0, 3, 6],\n    'dim7': [0, 3, 6, 9],\n    '°7': [0, 3, 6, 9],\n    '˚7': [0, 3, 6, 9],\n    'ø7': [0, 3, 6, 10],\n    'm7(b5)': [0, 3, 6, 10],\n    'm7b5': [0, 3, 6, 10],\n    '-7(b5)': [0, 3, 6, 10],\n    '-7b5': [0, 3, 6, 10],\n    '7b5': [0, 4, 6, 10],\n    '7(b5)': [0, 4, 6, 10],\n    '7♭5': [0, 4, 6, 10],\n    '7(b9,b5)': [0, 4, 6, 10, 13],\n    '7b9,b5': [0, 4, 6, 10, 13],\n    '7(#9,b5)': [0, 4, 6, 10, 15],\n    '7#9b5': [0, 4, 6, 10, 15],\n    'maj7(b5)': [0, 3, 6, 11],\n    'maj7b5': [0, 3, 6, 11],\n    '13(b5)': [0, 4, 6, 10, 14, 18],\n    '13b5': [0, 4, 6, 10, 14, 18],\n    // minor (all normal 5, minor 3 chords)\n    'm': [0, 3, 7],\n    '-': [0, 3, 7],\n    'm6': [0, 3, 7, 9],\n    '-6': [0, 3, 7, 9],\n    'm7': [0, 3, 7, 10],\n    '-7': [0, 3, 7, 10],\n    '-(b6)': [0, 3, 7, 8],\n    '-b6': [0, 3, 7, 8],\n    '-6/9': [0, 3, 7, 9, 14],\n    '-7(b9)': [0, 3, 7, 10, 13],\n    '-7b9': [0, 3, 7, 10, 13],\n    '-maj7': [0, 3, 7, 11],\n    '-9+7': [0, 3, 7, 11, 13],\n    '-11': [0, 3, 7, 11, 14, 16],\n    // major (all normal 5, major 3 chords)\n    'M': [0, 4, 7],\n    '6': [0, 4, 7, 9],\n    '6/9': [0, 4, 7, 9, 14],\n    '7': [0, 4, 7, 10],\n    '9': [0, 4, 7, 10, 14],\n    '11': [0, 4, 7, 10, 14, 16],\n    '13': [0, 4, 7, 10, 14, 18],\n    '7b9': [0, 4, 7, 10, 13],\n    '7♭9': [0, 4, 7, 10, 13],\n    '7(b9)': [0, 4, 7, 10, 13],\n    '7(#9)': [0, 4, 7, 10, 15],\n    '7#9': [0, 4, 7, 10, 15],\n    '(13)': [0, 4, 7, 10, 14, 18],\n    '7(9,13)': [0, 4, 7, 10, 14, 18],\n    '7(#9,b13)': [0, 4, 7, 10, 15, 17],\n    '7(#11)': [0, 4, 7, 10, 14, 17],\n    '7#11': [0, 4, 7, 10, 14, 17],\n    '7(b13)': [0, 4, 7, 10, 17],\n    '7b13': [0, 4, 7, 10, 17],\n    '9(#11)': [0, 4, 7, 10, 14, 17],\n    '9#11': [0, 4, 7, 10, 14, 17],\n    '13(#11)': [0, 4, 7, 10, 15, 18],\n    '13#11': [0, 4, 7, 10, 15, 18],\n    'maj7': [0, 4, 7, 11],\n    '∆7': [0, 4, 7, 11],\n    'Δ7': [0, 4, 7, 11],\n    'maj9': [0, 4, 7, 11, 14],\n    'maj7(9)': [0, 4, 7, 11, 14],\n    'maj7(11)': [0, 4, 7, 11, 16],\n    'maj7(#11)': [0, 4, 7, 11, 17],\n    'maj7(13)': [0, 4, 7, 11, 18],\n    'maj7(9,13)': [0, 4, 7, 11, 14, 18],\n    '7sus4': [0, 5, 7, 10],\n    'm7sus4': [0, 5, 7, 10],\n    'sus4': [0, 5, 7],\n    'sus2': [0, 2, 7],\n    '7sus2': [0, 2, 7, 10],\n    '9sus4': [0, 5, 7, 14],\n    '13sus4': [0, 5, 7, 18],\n    // augmented (all sharp 5 chords)\n    'aug7': [0, 4, 8, 10],\n    '+7': [0, 4, 8, 10],\n    '+': [0, 4, 8],\n    '7#5': [0, 4, 8, 10],\n    '7♯5': [0, 4, 8, 10],\n    '7+5': [0, 4, 8, 10],\n    '9#5': [0, 4, 8, 10, 14],\n    '9♯5': [0, 4, 8, 10, 14],\n    '9+5': [0, 4, 8, 10, 14],\n    '-7(#5)': [0, 3, 8, 10],\n    '-7#5': [0, 3, 8, 10],\n    '7(#5)': [0, 4, 8, 10],\n    '7(b9,#5)': [0, 4, 8, 10, 13],\n    '7b9#5': [0, 4, 8, 10, 13],\n    'maj7(#5)': [0, 4, 8, 11],\n    'maj7#5': [0, 4, 8, 11],\n    'maj7(#5,#11)': [0, 4, 8, 11, 14],\n    'maj7#5#11': [0, 4, 8, 11, 14],\n    '9(#5)': [0, 4, 8, 10, 14],\n    '13(#5)': [0, 4, 8, 10, 14, 18],\n    '13#5': [0, 4, 8, 10, 14, 18]\n  };\n\n  function chordNotes(bass, modifier) {\n    var intervals = chordIntervals[modifier];\n    if (!intervals) intervals = chordIntervals.M;\n    bass += 12; // the chord is an octave above the bass note.\n\n    var notes = [];\n\n    for (var i = 0; i < intervals.length; i++) {\n      notes.push(bass + intervals[i]);\n    }\n\n    return notes;\n  }\n\n  function writeBoom(boom, beatLength) {\n    // undefined means there is a stop time.\n    if (boom !== undefined) chordTrack.push({\n      cmd: 'start',\n      pitch: boom,\n      volume: 64\n    });\n    chordTrack.push({\n      cmd: 'move',\n      duration: beatLength / 2 * tempoChangeFactor\n    });\n    if (boom !== undefined) chordTrack.push({\n      cmd: 'stop',\n      pitch: boom\n    });\n    chordTrack.push({\n      cmd: 'move',\n      duration: beatLength / 2 * tempoChangeFactor\n    });\n  }\n\n  function writeChick(chick, beatLength) {\n    for (var c = 0; c < chick.length; c++) chordTrack.push({\n      cmd: 'start',\n      pitch: chick[c],\n      volume: 48\n    });\n\n    chordTrack.push({\n      cmd: 'move',\n      duration: beatLength / 2 * tempoChangeFactor\n    });\n\n    for (c = 0; c < chick.length; c++) chordTrack.push({\n      cmd: 'stop',\n      pitch: chick[c]\n    });\n\n    chordTrack.push({\n      cmd: 'move',\n      duration: beatLength / 2 * tempoChangeFactor\n    });\n  }\n\n  var rhythmPatterns = {\n    \"2/2\": ['boom', 'chick'],\n    \"2/4\": ['boom', 'chick'],\n    \"3/4\": ['boom', 'chick', 'chick'],\n    \"4/4\": ['boom', 'chick', 'boom2', 'chick'],\n    \"5/4\": ['boom', 'chick', 'chick', 'boom2', 'chick'],\n    \"6/8\": ['boom', '', 'chick', 'boom2', '', 'chick'],\n    \"9/8\": ['boom', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick'],\n    \"12/8\": ['boom', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick']\n  };\n\n  function resolveChords() {\n    var num = meter.num;\n    var den = meter.den;\n    var beatLength = 1 / den;\n    var pattern = rhythmPatterns[num + '/' + den];\n    var thisMeasureLength = parseInt(num, 10) / parseInt(den, 10); // See if this is a full measure: unfortunately, with triplets, there isn't an exact match, what with the floating point, so we just see if it is \"close\".\n\n    var portionOfAMeasure = Math.abs(thisMeasureLength - barBeat);\n\n    if (!pattern || portionOfAMeasure > 0.0078125) {\n      // If it is an unsupported meter, or this isn't a full bar, just chick on each beat.\n      pattern = [];\n      var beatsPresent = barBeat / beatLength;\n\n      for (var p = 0; p < beatsPresent; p++) pattern.push(\"chick\");\n    }\n\n    if (currentChords.length === 0) {\n      // there wasn't a new chord this measure, so use the last chord declared.\n      currentChords.push({\n        beat: 0,\n        chord: lastChord\n      });\n    }\n\n    if (currentChords[0].beat !== 0 && lastChord) {\n      // this is the case where there is a chord declared in the measure, but not on its first beat.\n      currentChords.unshift({\n        beat: 0,\n        chord: lastChord\n      });\n    }\n\n    if (currentChords.length === 1) {\n      for (var m = 0; m < pattern.length; m++) {\n        switch (pattern[m]) {\n          case 'boom':\n            writeBoom(currentChords[0].chord.boom, beatLength);\n            break;\n\n          case 'boom2':\n            writeBoom(currentChords[0].chord.boom2, beatLength);\n            break;\n\n          case 'chick':\n            writeChick(currentChords[0].chord.chick, beatLength);\n            break;\n\n          case '':\n            chordTrack.push({\n              cmd: 'move',\n              duration: beatLength * tempoChangeFactor\n            });\n            break;\n        }\n      }\n\n      return;\n    } // If we are here it is because more than one chord was declared in the measure, so we have to sort out what chord goes where.\n    // First, normalize the chords on beats.\n\n\n    var beats = {};\n\n    for (var i = 0; i < currentChords.length; i++) {\n      var cc = currentChords[i];\n      var beat = Math.floor(cc.beat / beatLength); // now all the beats are integers, there may be\n\n      beats['' + beat] = cc;\n    } // - If there is a chord on the second beat, play a chord for the first beat instead of a bass note.\n    // - Likewise, if there is a chord on the fourth beat of 4/4, play a chord on the third beat instead of a bass note.\n\n\n    for (var m2 = 0; m2 < pattern.length; m2++) {\n      var thisChord;\n      if (beats['' + m2]) thisChord = beats['' + m2];\n\n      switch (pattern[m2]) {\n        case 'boom':\n          if (beats['' + (m2 + 1)]) // If there is not a chord change on the next beat, play a bass note.\n            writeChick(thisChord.chord.chick, beatLength);else writeBoom(thisChord.chord.boom, beatLength);\n          break;\n\n        case 'boom2':\n          if (beats['' + (m2 + 1)]) writeChick(thisChord.chord.chick, beatLength);else writeBoom(thisChord.chord.boom2, beatLength);\n          break;\n\n        case 'chick':\n          writeChick(thisChord.chord.chick, beatLength);\n          break;\n\n        case '':\n          if (beats['' + m2]) // If there is an explicit chord on this beat, play it.\n            writeChick(thisChord.chord.chick, beatLength);else chordTrack.push({\n            cmd: 'move',\n            duration: beatLength * tempoChangeFactor\n          });\n          break;\n      }\n    }\n  }\n\n  function normalizeDrumDefinition(params) {\n    // Be very strict with the drum definition. If anything is not perfect,\n    // just turn the drums off.\n    // Perhaps all of this logic belongs in the parser instead.\n    if (params.pattern.length === 0 || params.on === false) return {\n      on: false\n    };\n    var str = params.pattern[0];\n    var events = [];\n    var event = \"\";\n    var totalPlay = 0;\n\n    for (var i = 0; i < str.length; i++) {\n      if (str[i] === 'd') totalPlay++;\n\n      if (str[i] === 'd' || str[i] === 'z') {\n        if (event.length !== 0) {\n          events.push(event);\n          event = str[i];\n        } else event = event + str[i];\n      } else {\n        if (event.length === 0) {\n          // there was an error: the string should have started with d or z\n          return {\n            on: false\n          };\n        }\n\n        event = event + str[i];\n      }\n    }\n\n    if (event.length !== 0) events.push(event); // Now the events array should have one item per event.\n    // There should be two more params for each event: the volume and the pitch.\n\n    if (params.pattern.length !== totalPlay * 2 + 1) return {\n      on: false\n    };\n    var ret = {\n      on: true,\n      bars: params.bars,\n      pattern: []\n    };\n    var beatLength = 1 / meter.den;\n    var playCount = 0;\n\n    for (var j = 0; j < events.length; j++) {\n      event = events[j];\n      var len = 1;\n      var div = false;\n      var num = 0;\n\n      for (var k = 1; k < event.length; k++) {\n        switch (event[k]) {\n          case \"/\":\n            if (num !== 0) len *= num;\n            num = 0;\n            div = true;\n            break;\n\n          case \"1\":\n          case \"2\":\n          case \"3\":\n          case \"4\":\n          case \"5\":\n          case \"6\":\n          case \"7\":\n          case \"8\":\n          case \"9\":\n            num = num * 10 + event[k];\n            break;\n\n          default:\n            return {\n              on: false\n            };\n        }\n      }\n\n      if (div) {\n        if (num === 0) num = 2; // a slash by itself is interpreted as \"/2\"\n\n        len /= num;\n      } else if (num) len *= num;\n\n      if (event[0] === 'd') {\n        ret.pattern.push({\n          len: len * beatLength,\n          pitch: params.pattern[1 + playCount],\n          velocity: params.pattern[1 + playCount + totalPlay]\n        });\n        playCount++;\n      } else ret.pattern.push({\n        len: len * beatLength,\n        pitch: null\n      });\n    } // Now normalize the pattern to cover the correct number of measures. The note lengths passed are relative to each other and need to be scaled to fit a measure.\n\n\n    var totalTime = 0;\n    var measuresPerBeat = meter.num / meter.den;\n\n    for (var ii = 0; ii < ret.pattern.length; ii++) totalTime += ret.pattern[ii].len;\n\n    var numBars = params.bars ? params.bars : 1;\n    var factor = totalTime / numBars / measuresPerBeat;\n\n    for (ii = 0; ii < ret.pattern.length; ii++) ret.pattern[ii].len = ret.pattern[ii].len / factor;\n\n    return ret;\n  }\n\n  function drumBeat(pitch, soundLength, volume) {\n    drumTrack.push({\n      cmd: 'start',\n      pitch: pitch - 60,\n      volume: volume\n    });\n    drumTrack.push({\n      cmd: 'move',\n      duration: soundLength\n    });\n    drumTrack.push({\n      cmd: 'stop',\n      pitch: pitch - 60\n    });\n  }\n\n  function writeDrum(channel) {\n    if (drumTrack.length === 0 && !drumDefinition.on) return;\n    var measureLen = meter.num / meter.den;\n\n    if (drumTrack.length === 0) {\n      drumTrack.push({\n        cmd: 'program',\n        channel: channel,\n        instrument: drumInstrument\n      }); // need to figure out how far in time the bar started: if there are pickup notes before the chords start, we need pauses.\n\n      var distance = timeFromStart();\n\n      if (distance > 0 && distance < measureLen - 0.01) {\n        // because of floating point, adding the notes might not exactly equal the measure size.\n        drumTrack.push({\n          cmd: 'move',\n          duration: distance * tempoChangeFactor\n        });\n        return;\n      }\n    }\n\n    if (!drumDefinition.on) {\n      // this is the case where there has been a drum track, but it was specifically turned off.\n      drumTrack.push({\n        cmd: 'move',\n        duration: measureLen * tempoChangeFactor\n      });\n      return;\n    }\n\n    for (var i = 0; i < drumDefinition.pattern.length; i++) {\n      var len = drumDefinition.pattern[i].len * tempoChangeFactor;\n      if (drumDefinition.pattern[i].pitch) drumBeat(drumDefinition.pattern[i].pitch, len, drumDefinition.pattern[i].velocity);else drumTrack.push({\n        cmd: 'move',\n        duration: len\n      });\n    }\n  }\n})();\n\nmodule.exports = flatten;","map":{"version":3,"sources":["/home/elad/Desktop/Repos/drums-trainer/frontend/node_modules/react-sheet-music/node_modules/abcjs/src/midi/abc_midi_flattener.js"],"names":["flatten","barAccidentals","accidentals","transpose","bagpipes","multiplier","tracks","startingTempo","startingMeter","tempoChangeFactor","instrument","currentInstrument","currentTrack","pitchesTied","lastNoteDurationPosition","currentTrackCounter","meter","num","den","chordTrack","chordTrackFinished","chordChannel","chordInstrument","drumInstrument","currentChords","lastChord","barBeat","gChordTacet","doBeatAccents","stressBeat1","stressBeatDown","stressBeatUp","beatFraction","nextVolume","nextVolumeDelta","drumTrack","drumTrackFinished","drumDefinition","normalBreakBetweenNotes","voices","options","undefined","length","chordsOff","zeroOutMilliseconds","i","voice","cmd","channel","j","element","el_type","writeNote","voicesOff","setKeySignature","getBeatFraction","qpm","resolveChords","writeDrum","program","ii","push","normalizeDrumDefinition","params","tacet","beats","volume","value","console","log","tempo","totalDuration","currentTrackMilliseconds","total","track","trackTotal","event","duration","Math","max","breakSynonyms","findChord","elem","chord","ch","position","name","indexOf","toLowerCase","timeFromStart","distance","ct","voiceOff","velocity","c","interpretChord","beat","startTriplet","tripletMultiplier","durationClass","graces","gracenotes","stealFromCurrent","stealFromDuration","processGraceNotes","writeGraceNotes","pitches","midiPitches","note","actualPitch","adjustPitch","pitch","startTie","durationInMeasures","last","pitchArray","last2","endTie","midiGraceNotePitches","grace","thisBreakBetweenNotes","soundDuration","rest","endTriplet","scale","midipitch","accidental","extractOctave","extractNote","acc","d","lowercase","charCodeAt","graceDivider","companionDuration","graceDuration","ret","g","skipNote","gp","floor","basses","chick","root","substring","bass","bass2","chordNotes","remaining","arr","split","explicitBass","bassAcc","bassShift","boom","boom2","chordIntervals","modifier","intervals","M","notes","writeBoom","beatLength","writeChick","rhythmPatterns","pattern","thisMeasureLength","parseInt","portionOfAMeasure","abs","beatsPresent","p","unshift","m","cc","m2","thisChord","on","str","events","totalPlay","bars","playCount","len","div","k","totalTime","measuresPerBeat","numBars","factor","drumBeat","soundLength","measureLen","module","exports"],"mappings":"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","sourcesContent":["//    abc_midi_flattener.js: Turn a linear series of events into a series of MIDI commands.\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com) and Paul Rosen\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n// We input a set of voices, but the notes are still complex. This pass changes the logical definitions\n// of the grace notes, decorations, ties, triplets, rests, transpositions, keys, and accidentals into actual note durations.\n// It also extracts guitar chords to a separate voice and resolves their rhythm.\n\nvar flatten;\n\n(function() {\n\t\"use strict\";\n\n\tvar barAccidentals;\n\tvar accidentals;\n\tvar transpose;\n\tvar bagpipes;\n\tvar multiplier;\n\tvar tracks;\n\tvar startingTempo;\n\tvar startingMeter;\n\tvar tempoChangeFactor = 1;\n\tvar instrument;\n\tvar currentInstrument;\n\t// var channel;\n\tvar currentTrack;\n\tvar pitchesTied;\n\tvar lastNoteDurationPosition;\n\tvar currentTrackCounter;\n\n\tvar meter = { num: 4, den: 4 };\n\tvar chordTrack;\n\tvar chordTrackFinished;\n\tvar chordChannel;\n\tvar chordInstrument = 0;\n\tvar drumInstrument = 128;\n\tvar currentChords;\n\tvar lastChord;\n\tvar barBeat;\n\tvar gChordTacet = false;\n\tvar doBeatAccents = true;\n\tvar stressBeat1 = 105;\n\tvar stressBeatDown = 95;\n\tvar stressBeatUp = 85;\n\tvar beatFraction = 0.25;\n\tvar nextVolume;\n\tvar nextVolumeDelta;\n\n\tvar drumTrack;\n\tvar drumTrackFinished;\n\tvar drumDefinition = {};\n\n\tvar normalBreakBetweenNotes = 1.0/128;\t// a 128th note of silence between notes for articulation.\n\n\tflatten = function(voices, options) {\n\t\tif (!options) options = {};\n\t\tbarAccidentals = [];\n\t\taccidentals = [0,0,0,0,0,0,0];\n\t\tbagpipes = false;\n\t\tmultiplier = 1;\n\t\ttracks = [];\n\t\tstartingTempo = undefined;\n\t\tstartingMeter = undefined;\n\t\ttempoChangeFactor = 1;\n\t\tinstrument = undefined;\n\t\tcurrentInstrument = undefined;\n\t\t// channel = undefined;\n\t\tcurrentTrack = undefined;\n\t\tcurrentTrackCounter = undefined;\n\t\tpitchesTied = {};\n\n\t\t// For resolving chords.\n\t\tmeter = { num: 4, den: 4 };\n\t\tchordTrack = [];\n\t\tchordChannel = voices.length; // first free channel for chords\n\t\tchordTrackFinished = false;\n\t\tcurrentChords = [];\n\t\tlastChord = undefined;\n\t\tbarBeat = 0;\n\t\tgChordTacet = options.chordsOff ? true : false;\n\n\t\tdoBeatAccents = true;\n\t\tstressBeat1 = 105;\n\t\tstressBeatDown = 95;\n\t\tstressBeatUp = 85;\n\t\tbeatFraction = 0.25;\n\t\tnextVolume = undefined;\n\t\tnextVolumeDelta = undefined;\n\n\t\t// For the drum/metronome track.\n\t\tdrumTrack = [];\n\t\tdrumTrackFinished = false;\n\t\tdrumDefinition = {};\n\n\t\tzeroOutMilliseconds(voices);\n\n\t\tfor (var i = 0; i < voices.length; i++) {\n\t\t\ttranspose = 0;\n\t\t\tlastNoteDurationPosition = -1;\n\t\t\tvar voice = voices[i];\n\t\t\tcurrentTrack = [{ cmd: 'program', channel: i, instrument: instrument }];\n\t\t\tcurrentTrackCounter = 0;\n\t\t\tpitchesTied = {};\n\t\t\tfor (var j = 0; j < voice.length; j++) {\n\t\t\t\tvar element = voice[j];\n\t\t\t\tswitch (element.el_type) {\n\t\t\t\t\tcase \"note\":\n\t\t\t\t\t\twriteNote(element, options.voicesOff);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"key\":\n\t\t\t\t\t\taccidentals = setKeySignature(element);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"meter\":\n\t\t\t\t\t\tif (!startingMeter)\n\t\t\t\t\t\t\tstartingMeter = element;\n\t\t\t\t\t\tmeter = element;\n\t\t\t\t\t\tbeatFraction = getBeatFraction(meter);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"tempo\":\n\t\t\t\t\t\tif (!startingTempo)\n\t\t\t\t\t\t\tstartingTempo = element.qpm;\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\ttempoChangeFactor = element.qpm ? startingTempo / element.qpm : 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"transpose\":\n\t\t\t\t\t\ttranspose = element.transpose;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"bar\":\n\t\t\t\t\t\tif (chordTrack.length > 0 && i === 0) {\n\t\t\t\t\t\t\tresolveChords();\n\t\t\t\t\t\t\tcurrentChords = [];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbarBeat = 0;\n\t\t\t\t\t\tbarAccidentals = [];\n\t\t\t\t\t\tif (i === 0) // Only write the drum part on the first voice so that it is not duplicated.\n\t\t\t\t\t\t\twriteDrum(voices.length+1);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"bagpipes\":\n\t\t\t\t\t\tbagpipes = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"instrument\":\n\t\t\t\t\t\tif (instrument === undefined)\n\t\t\t\t\t\t\tinstrument = element.program;\n\t\t\t\t\t\tcurrentInstrument = element.program;\n\t\t\t\t\t\tif (currentTrack.length > 0 && currentTrack[currentTrack.length-1].cmd === 'program')\n\t\t\t\t\t\t\tcurrentTrack[currentTrack.length-1].instrument = element.program;\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tvar ii;\n\t\t\t\t\t\t\tfor (ii = currentTrack.length-1; ii >= 0 && currentTrack[ii].cmd !== 'program'; ii--)\n\t\t\t\t\t\t\t\t;\n\t\t\t\t\t\t\tif (ii < 0 || currentTrack[ii].instrument !== element.program)\n\t\t\t\t\t\t\t\tcurrentTrack.push({cmd: 'program', channel: i, instrument: element.program});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"channel\":\n\t\t\t\t\t// \tif (channel === undefined)\n\t\t\t\t\t// \t\tchannel = element.channel;\n\t\t\t\t\t// \tcurrentTrack[0].channel = element.channel;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"drum\":\n\t\t\t\t\t\tdrumDefinition = normalizeDrumDefinition(element.params);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"gchord\":\n\t\t\t\t\t\tif (!options.chordsOff)\n\t\t\t\t\t\t\tgChordTacet = element.tacet;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"beat\":\n\t\t\t\t\t\tstressBeat1 = element.beats[0];\n\t\t\t\t\t\tstressBeatDown = element.beats[1];\n\t\t\t\t\t\tstressBeatUp = element.beats[2];\n\t\t\t\t\t\t// TODO-PER: also use the last parameter - which changes which beats are strong.\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"vol\":\n\t\t\t\t\t\tnextVolume = element.volume;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"volinc\":\n\t\t\t\t\t\tnextVolumeDelta = element.volume;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"beataccents\":\n\t\t\t\t\t\tdoBeatAccents = element.value;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\t// This should never happen\n\t\t\t\t\t\tconsole.log(\"MIDI creation. Unknown el_type: \" + element.el_type + \"\\n\");// jshint ignore:line\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (currentTrack[0].instrument === undefined)\n\t\t\t\tcurrentTrack[0].instrument = instrument ? instrument : 0;\n\t\t\ttracks.push(currentTrack);\n\t\t\tif (chordTrack.length > 0) // Don't do chords on more than one track, so turn off chord detection after we create it.\n\t\t\t\tchordTrackFinished = true;\n\t\t\tif (drumTrack.length > 0) // Don't do drums on more than one track, so turn off drum after we create it.\n\t\t\t\tdrumTrackFinished = true;\n\t\t}\n\t\tif (chordTrack.length > 0)\n\t\t\ttracks.push(chordTrack);\n\t\tif (drumTrack.length > 0)\n\t\t\ttracks.push(drumTrack);\n\t\t// Adjust the tempo according to the meter. The rules are this:\n\t\t// 1) If the denominator is 2 or 4, then always make a beat be the denominator.\n\t\t//\n\t\t// 2) If the denominator is 8 or 16, then:\n\t\t// a) If the numerator is divisible by 3, the beat is 3*denominator.\n\t\t// b) Otherwise the beat is the denominator.\n\t\t//\n\t\t// 3) If the denominator is anything else, then don't worry about it because it doesn't make sense. Don't modify it and hope for the best.\n\t\t//\n\t\t// Right now, the startingTempo is calculated for a quarter note, so modify it if necessary.\n\t\t// var num = startingMeter ? parseInt(startingMeter.num, 10) : meter.num;\n\t\t// var den = startingMeter ? parseInt(startingMeter.den, 10) : meter.den;\n\t\t// if (den === 2)\n\t\t// \tstartingTempo *= 2;\n\t\t// else if (den === 8) {\n\t\t// \tif (parseInt(num, 10) % 3 === 0)\n\t\t// \t\tstartingTempo *= 3/2;\n\t\t// \telse\n\t\t// \t\tstartingTempo /= 2;\n\t\t// } else if (den === 16) {\n\t\t// \tif (num % 3 === 0)\n\t\t// \t\tstartingTempo *= 3/4;\n\t\t// \telse\n\t\t// \t\tstartingTempo /= 4;\n\t\t// }\n\n\t\treturn { tempo: startingTempo, instrument: instrument, tracks: tracks, totalDuration: totalDuration(tracks) };\n\t};\n\n\tfunction zeroOutMilliseconds(voices) {\n\t\tfor (var i = 0; i < voices.length; i++) {\n\t\t\tvar voice = voices[i];\n\t\t\tfor (var j = 0; j < voice.length; j++) {\n\t\t\t\tvar element = voice[j];\n\t\t\t\tdelete element.currentTrackMilliseconds;\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction totalDuration(tracks) {\n\t\tvar total = 0;\n\t\tfor (var i = 0; i < tracks.length; i++) {\n\t\t\tvar track = tracks[i];\n\t\t\tvar trackTotal = 0;\n\t\t\tfor (var j = 0; j < track.length; j++) {\n\t\t\t\tvar event = track[j];\n\t\t\t\tif (event.duration)\n\t\t\t\t\ttrackTotal += event.duration;\n\t\t\t}\n\t\t\ttotal = Math.max(total, trackTotal);\n\t\t}\n\t\treturn total;\n\t}\n\n\tfunction getBeatFraction(meter) {\n\t\tswitch (meter.den) {\n\t\t\tcase 2: return 0.5;\n\t\t\tcase 4: return 0.25;\n\t\t\tcase 8: return 0.375;\n\t\t\tcase 16: return 0.125;\n\t\t}\n\t\treturn 0.25;\n\t}\n\t//\n\t// The algorithm for chords is:\n\t// - The chords are done in a separate track.\n\t// - If there are notes before the first chord, then put that much silence to start the track.\n\t// - The pattern of chord expression depends on the meter, and how many chords are in a measure.\n\t// - There is a possibility that a measure will have an incorrect number of beats, if that is the case, then\n\t// start the pattern anew on the next measure number.\n\t// - If a chord root is not A-G, then ignore it as if the chord wasn't there at all.\n\t// - If a chord modification isn't in our supported list, change it to a major triad.\n\t//\n\t// - If there is only one chord in a measure:\n\t//\t\t- If 2/4, play root chord\n\t//\t\t- If cut time, play root(1) chord(3)\n\t//\t\t- If 3/4, play root chord chord\n\t//\t\t- If 4/4 or common time, play root chord fifth chord\n\t//\t\t- If 6/8, play root(1) chord(3) fifth(4) chord(6)\n\t//\t\t- For any other meter, play the full chord on each beat. (TODO-PER: expand this as more support is added.)\n\t//\n\t//\t- If there is a chord specified that is not on a beat, move it earlier to the previous beat, unless there is already a chord on that beat.\n\t//\t- Otherwise, move it later, unless there is already a chord on that beat.\n\t// \t- Otherwise, ignore it. (TODO-PER: expand this as more support is added.)\n\t//\n\t// - If there is a chord on the second beat, play a chord for the first beat instead of a bass note.\n\t// - Likewise, if there is a chord on the fourth beat of 4/4, play a chord on the third beat instead of a bass note.\n\t//\n\tvar breakSynonyms = [ 'break', '(break)', 'no chord', 'n.c.', 'tacet'];\n\n\tfunction findChord(elem) {\n\t\tif (gChordTacet)\n\t\t\treturn 'break';\n\n\t\t// TODO-PER: Just using the first chord if there are more than one.\n\t\tif (chordTrackFinished || !elem.chord || elem.chord.length === 0)\n\t\t\treturn null;\n\n\t\t// Return the first annotation that is a regular chord: that is, it is in the default place or is a recognized \"tacet\" phrase.\n\t\tfor (var i = 0; i < elem.chord.length; i++) {\n\t\t\tvar ch = elem.chord[i];\n\t\t\tif (ch.position === 'default')\n\t\t\t\treturn ch.name;\n\t\t\tif (breakSynonyms.indexOf(ch.name.toLowerCase()) >= 0)\n\t\t\t\treturn 'break';\n\t\t}\n\t\treturn null;\n\t}\n\n\tfunction timeFromStart() {\n\t\tvar distance = 0;\n\t\tfor (var ct = 0; ct < currentTrack.length; ct++) {\n\t\t\tif (currentTrack[ct].cmd === 'move')\n\t\t\t\tdistance += currentTrack[ct].duration;\n\t\t}\n\t\treturn distance;\n\t}\n\n\tfunction writeNote(elem, voiceOff) {\n\t\t//\n\t\t// Create a series of note events to append to the current track.\n\t\t// The output event is one of: { pitchStart: pitch_in_abc_units, volume: from_1_to_64 }\n\t\t// { pitchStop: pitch_in_abc_units }\n\t\t// { moveTime: duration_in_abc_units }\n\t\t// If there are guitar chords, then they are put in a separate track, but they have the same format.\n\t\t//\n\n\t\tvar volume;\n\t\tif (nextVolume) {\n\t\t\tvolume = nextVolume;\n\t\t\tnextVolume = undefined;\n\t\t} else if (!doBeatAccents) {\n\t\t\tvolume = stressBeatDown;\n\t\t} else {\n\t\t\tif (barBeat === 0)\n\t\t\t\tvolume = stressBeat1;\n\t\t\telse if (barBeat % beatFraction < 0.001) // A little slop because of JavaScript floating point math.\n\t\t\t\tvolume = stressBeatDown;\n\t\t\telse\n\t\t\t\tvolume = stressBeatUp;\n\t\t}\n\t\tif (nextVolumeDelta) {\n\t\t\tvolume += nextVolumeDelta;\n\t\t\tnextVolumeDelta = undefined;\n\t\t}\n\t\tif (volume < 0)\n\t\t\tvolume = 0;\n\t\tif (volume > 127)\n\t\t\tvolume = 127;\n\t\tvar velocity = voiceOff ? 0 : volume;\n\t\tvar chord = findChord(elem);\n\t\tif (chord) {\n\t\t\tvar c = interpretChord(chord);\n\t\t\t// If this isn't a recognized chord, just completely ignore it.\n\t\t\tif (c) {\n\t\t\t\t// If we ever have a chord in this voice, then we add the chord track.\n\t\t\t\t// However, if there are chords on more than one voice, then just use the first voice.\n\t\t\t\tif (chordTrack.length === 0) {\n\t\t\t\t\tchordTrack.push({cmd: 'program', channel: chordChannel, instrument: chordInstrument});\n\t\t\t\t\t// need to figure out how far in time the chord started: if there are pickup notes before the chords start, we need pauses.\n\t\t\t\t\tvar distance = timeFromStart();\n\t\t\t\t\tif (distance > 0)\n\t\t\t\t\t\tchordTrack.push({cmd: 'move', duration: distance*tempoChangeFactor });\n\t\t\t\t}\n\n\t\t\t\tlastChord = c;\n\t\t\t\tcurrentChords.push({chord: lastChord, beat: barBeat});\n\t\t\t}\n\t\t}\n\n\t\tif (elem.startTriplet) {\n\t\t\tmultiplier = elem.tripletMultiplier;\n\t\t}\n\n\t\tvar duration = (elem.durationClass ? elem.durationClass : elem.duration) *multiplier;\n\t\tbarBeat += duration;\n\n\t\t// if there are grace notes, then also play them.\n\t\t// I'm not sure there is an exact rule for the length of the notes. My rule, unless I find\n\t\t// a better one is: the grace notes cannot take more than 1/2 of the main note's value.\n\t\t// A grace note (of 1/8 note duration) takes 1/8 of the main note's value.\n\t\tvar graces;\n\t\tif (elem.gracenotes) {\n\t\t\t// There are two cases: if this is bagpipe, the grace notes are played on the beat with the current note.\n\t\t\t// Normally, the grace notes would be played before the beat. (If this is the first note in the track, however, then it is played on the current beat.)\n\t\t\t// The reason for the exception on the first note is that it would otherwise move the whole track in time and would affect all the other tracks.\n\t\t\tvar stealFromCurrent = (bagpipes || lastNoteDurationPosition < 0 || currentTrack.length === 0);\n\t\t\tvar stealFromDuration = stealFromCurrent ? duration : currentTrack[lastNoteDurationPosition].duration;\n\t\t\tgraces = processGraceNotes(elem.gracenotes, stealFromDuration);\n\t\t\tif (!bagpipes) {\n\t\t\t\tduration = writeGraceNotes(graces, stealFromCurrent, duration, null, velocity);\n\t\t\t}\n\t\t}\n\n\t\t// The currentTrackCounter is the number of whole notes from the beginning of the piece.\n\t\t// The beat fraction is the note that gets a beat (.25 is a quarter note)\n\t\t// The tempo is in minutes and we want to get to milliseconds.\n\t\tif (!elem.currentTrackMilliseconds)\n\t\t\telem.currentTrackMilliseconds = [];\n\t\telem.currentTrackMilliseconds.push(currentTrackCounter / beatFraction / startingTempo * 60*1000);\n\t\tif (elem.pitches) {\n\t\t\tif (graces && bagpipes) {\n\t\t\t\t// If it is bagpipes, then the graces are played with the note. If the grace has the same pitch as the note, then we just skip it.\n\t\t\t\tduration = writeGraceNotes(graces, true, duration, null, velocity);\n\t\t\t}\n\t\t\tvar pitches = [];\n\t\t\telem.midiPitches = [];\n\t\t\tfor (var i=0; i<elem.pitches.length; i++) {\n\t\t\t\tvar note = elem.pitches[i];\n\t\t\t\tvar actualPitch = adjustPitch(note);\n\t\t\t\tpitches.push({ pitch: actualPitch, startTie: note.startTie });\n\t\t\t\telem.midiPitches.push({ pitch: actualPitch+60, durationInMeasures: duration*tempoChangeFactor, volume: volume, instrument: currentInstrument }); // TODO-PER: why is the internal numbering system offset by 60 from midi? It should probably be the same as midi.\n\n\t\t\t\tif (!pitchesTied[''+actualPitch])\t// If this is the second note of a tie, we don't start it again.\n\t\t\t\t\tcurrentTrack.push({ cmd: 'start', pitch: actualPitch, volume: velocity });\n\t\t\t\telse {\n\t\t\t\t\t// but we do add the duration to what we call back.\n\t\t\t\t\tfor (var last = currentTrack.length-1; last >= 0; last--) {\n\t\t\t\t\t\tif (currentTrack[last].cmd === 'start' && currentTrack[last].pitch === actualPitch && currentTrack[last].elem) {\n\t\t\t\t\t\t\tvar pitchArray = currentTrack[last].elem.midiPitches;\n\t\t\t\t\t\t\tfor (var last2 = 0; last2 < pitchArray.length; last2++) {\n\t\t\t\t\t\t\t\tif (pitchArray[last2].pitch-60 === actualPitch) { // TODO-PER: the 60 is to compensate for the midi pitch numbers again.\n\t\t\t\t\t\t\t\t\tpitchArray[last2].durationInMeasures += duration * tempoChangeFactor;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (note.startTie) {\n\t\t\t\t\tpitchesTied['' + actualPitch] = true;\n\t\t\t\t\tcurrentTrack[currentTrack.length-1].elem = elem;\n\t\t\t\t} else if (note.endTie)\n\t\t\t\t\tpitchesTied[''+actualPitch] = false;\n\t\t\t}\n\t\t\tif (elem.gracenotes) {\n\t\t\t\tfor (var j = 0; j < elem.gracenotes.length; j++) {\n\t\t\t\t\telem.midiGraceNotePitches = [];\n\t\t\t\t\tvar grace = elem.gracenotes[j];\n\t\t\t\t\telem.midiGraceNotePitches.push({ pitch: adjustPitch(grace)+60, durationInMeasures: 0, volume: volume, instrument: currentInstrument});\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar thisBreakBetweenNotes = normalBreakBetweenNotes;\n\t\t\tvar soundDuration = duration-normalBreakBetweenNotes;\n\t\t\tif (soundDuration < 0) {\n\t\t\t\tsoundDuration = 0;\n\t\t\t\tthisBreakBetweenNotes = 0;\n\t\t\t}\n\t\t\tcurrentTrack.push({ cmd: 'move', duration: soundDuration*tempoChangeFactor });\n\t\t\tlastNoteDurationPosition = currentTrack.length-1;\n\t\t\tcurrentTrackCounter += soundDuration*tempoChangeFactor;\n\n\t\t\tfor (var ii = 0; ii < pitches.length; ii++) {\n\t\t\t\tif (!pitchesTied[''+pitches[ii].pitch])\n\t\t\t\t\tcurrentTrack.push({ cmd: 'stop', pitch: pitches[ii].pitch });\n\t\t\t}\n\t\t\tcurrentTrack.push({ cmd: 'move', duration: thisBreakBetweenNotes*tempoChangeFactor });\n\t\t\tcurrentTrackCounter += thisBreakBetweenNotes*tempoChangeFactor;\n\t\t} else if (elem.rest) {\n\t\t\tcurrentTrack.push({ cmd: 'move', duration: duration*tempoChangeFactor });\n\t\t\tcurrentTrackCounter += duration*tempoChangeFactor;\n\t\t}\n\n\t\tif (elem.endTriplet) {\n\t\t\tmultiplier=1;\n\t\t}\n\t}\n\n\tvar scale = [0,2,4,5,7,9,11];\n\tfunction adjustPitch(note) {\n\t\tif (note.midipitch)\n\t\t\treturn note.midipitch - 60;\n\t\tvar pitch = note.pitch;\n\t\tif (note.accidental) {\n\t\t\tswitch(note.accidental) { // change that pitch (not other octaves) for the rest of the bar\n\t\t\t\tcase \"sharp\":\n\t\t\t\t\tbarAccidentals[pitch]=1; break;\n\t\t\t\tcase \"flat\":\n\t\t\t\t\tbarAccidentals[pitch]=-1; break;\n\t\t\t\tcase \"natural\":\n\t\t\t\t\tbarAccidentals[pitch]=0; break;\n\t\t\t\tcase \"dblsharp\":\n\t\t\t\t\tbarAccidentals[pitch]=2; break;\n\t\t\t\tcase \"dblflat\":\n\t\t\t\t\tbarAccidentals[pitch]=-2; break;\n\t\t\t}\n\t\t}\n\n\t\tvar actualPitch = extractOctave(pitch) *12 + scale[extractNote(pitch)];\n\n\t\tif ( barAccidentals[pitch]!==undefined) {\n\t\t\tactualPitch +=  barAccidentals[pitch];\n\t\t} else { // use normal accidentals\n\t\t\tactualPitch +=  accidentals[extractNote(pitch)];\n\t\t}\n\t\tactualPitch += transpose;\n\t\treturn actualPitch;\n\t}\n\n\tfunction setKeySignature(elem) {\n\t\tvar accidentals = [0,0,0,0,0,0,0];\n\t\tif (!elem.accidentals) return accidentals;\n\t\tfor (var i = 0; i < elem.accidentals.length; i++) {\n\t\t\tvar acc = elem.accidentals[i];\n\t\t\tvar d = (acc.acc === \"sharp\") ? 1 : (acc.acc === \"natural\") ?0 : -1;\n\n\t\t\tvar lowercase = acc.note.toLowerCase();\n\t\t\tvar note = extractNote(lowercase.charCodeAt(0)-'c'.charCodeAt(0));\n\t\t\taccidentals[note]+=d;\n\t\t}\n\t\treturn accidentals;\n\t}\n\n\tvar graceDivider = 8; // This is the fraction of a note that the grace represents. That is, if this is 2, then a grace note of 1/16 would be a 1/32.\n\tfunction processGraceNotes(graces, companionDuration) {\n\t\tvar graceDuration = 0;\n\t\tvar ret = [];\n\t\tvar grace;\n\t\tfor (var g = 0; g < graces.length; g++) {\n\t\t\tgrace = graces[g];\n\t\t\tgraceDuration += grace.duration;\n\t\t}\n\t\tgraceDuration = graceDuration / graceDivider;\n\t\tvar multiplier = (graceDuration * 2 > companionDuration) ? companionDuration/(graceDuration * 2) : 1;\n\n\t\tfor (g = 0; g < graces.length; g++) {\n\t\t\tgrace = graces[g];\n\t\t\tvar pitch = grace.midipitch ? grace.midipitch - 60 : grace.pitch;\n\t\t\tret.push({ pitch: pitch, duration: grace.duration/graceDivider*multiplier });\n\t\t}\n\t\treturn ret;\n\t}\n\n\tfunction writeGraceNotes(graces, stealFromCurrent, duration, skipNote, velocity) {\n\t\tfor (var g = 0; g < graces.length; g++) {\n\t\t\tvar gp = graces[g];\n\t\t\tif (gp !== skipNote)\n\t\t\t\tcurrentTrack.push({cmd: 'start', pitch: gp.pitch, volume: velocity});\n\t\t\tcurrentTrack.push({cmd: 'move', duration: graces[g].duration*tempoChangeFactor });\n\t\t\tif (gp !== skipNote)\n\t\t\t\tcurrentTrack.push({cmd: 'stop', pitch: gp.pitch});\n\t\t\tif (!stealFromCurrent)\n\t\t\t\tcurrentTrack[lastNoteDurationPosition].duration -= graces[g].duration;\n\t\t\tduration -= graces[g].duration;\n\t\t}\n\t\treturn duration;\n\t}\n\n\tfunction extractOctave(pitch) {\n\t\treturn Math.floor(pitch/7);\n\t}\n\n\tfunction extractNote(pitch) {\n\t\tpitch = pitch%7;\n\t\tif (pitch<0) pitch+=7;\n\t\treturn pitch;\n\t}\n\n\tvar basses = {\n\t\t'A': -27, 'B': -25, 'C': -24, 'D': -22, 'E': -20, 'F': -19, 'G': -17\n\t};\n\tfunction interpretChord(name) {\n\t\t// chords have the format:\n\t\t// [root][acc][modifier][/][bass][acc]\n\t\t// (The chord might be surrounded by parens. Just ignore them.)\n\t\t// root must be present and must be from A-G.\n\t\t// acc is optional and can be # or b\n\t\t// The modifier can be a wide variety of things, like \"maj7\". As they are discovered, more are supported here.\n\t\t// If there is a slash, then there is a bass note, which can be from A-G, with an optional acc.\n\t\t// If the root is unrecognized, then \"undefined\" is returned and there is no chord.\n\t\t// If the modifier is unrecognized, a major triad is returned.\n\t\t// If the bass notes is unrecognized, it is ignored.\n\t\tif (name.length === 0)\n\t\t\treturn undefined;\n\t\tif (name === 'break')\n\t\t\treturn { chick: []};\n\t\tvar root = name.substring(0,1);\n\t\tif (root === '(') {\n\t\t\tname = name.substring(1,name.length-2);\n\t\t\tif (name.length === 0)\n\t\t\t\treturn undefined;\n\t\t\troot = name.substring(0,1);\n\t\t}\n\t\tvar bass = basses[root];\n\t\tif (!bass)\t// If the bass note isn't listed, then this was an unknown root. Only A-G are accepted.\n\t\t\treturn undefined;\n\t\tbass  += transpose;\n\t\tvar bass2 = bass - 5;\t// The alternating bass is a 4th below\n\t\tvar chick;\n\t\tif (name.length === 1)\n\t\t\tchick = chordNotes(bass, '');\n\t\tvar remaining = name.substring(1);\n\t\tvar acc = remaining.substring(0,1);\n\t\tif (acc === 'b' || acc === '♭') {\n\t\t\tbass--;\n\t\t\tbass2--;\n\t\t\tremaining = remaining.substring(1);\n\t\t} else if (acc === '#' || acc === '♯') {\n\t\t\tbass++;\n\t\t\tbass2++;\n\t\t\tremaining = remaining.substring(1);\n\t\t}\n\t\tvar arr = remaining.split('/');\n\t\tchick = chordNotes(bass, arr[0]);\n\t\tif (arr.length === 2) {\n\t\t\tvar explicitBass = basses[arr[1].substring(0,1)];\n\t\t\tif (explicitBass) {\n\t\t\t\tvar bassAcc = arr[1].substring(1);\n\t\t\t\tvar bassShift = {'#': 1, '♯': 1, 'b': -1, '♭': -1}[bassAcc] || 0;\n\t\t\t\tbass = basses[arr[1].substring(0,1)] + bassShift + transpose;\n\t\t\t\tbass2 = bass;\n\t\t\t}\n\t\t}\n\t\treturn { boom: bass, boom2: bass2, chick: chick };\n\t}\n\n\tvar chordIntervals = {\n\t\t// diminished (all flat 5 chords)\n\t\t'dim': [ 0, 3, 6 ],\n\t\t'°': [ 0, 3, 6 ],\n\t\t'˚': [ 0, 3, 6 ],\n\n\t\t'dim7': [ 0, 3, 6, 9 ],\n\t\t'°7': [ 0, 3, 6, 9 ],\n\t\t'˚7': [ 0, 3, 6, 9 ],\n\n\t\t'ø7': [ 0, 3, 6, 10 ],\n\t\t'm7(b5)': [ 0, 3, 6, 10 ],\n\t\t'm7b5': [ 0, 3, 6, 10 ],\n\t\t'-7(b5)': [ 0, 3, 6, 10 ],\n\t\t'-7b5': [ 0, 3, 6, 10 ],\n\n\t\t'7b5': [ 0, 4, 6, 10 ],\n\t\t'7(b5)': [ 0, 4, 6, 10 ],\n\t\t'7♭5': [ 0, 4, 6, 10 ],\n\n\t\t'7(b9,b5)': [ 0, 4, 6, 10, 13 ],\n\t\t'7b9,b5': [ 0, 4, 6, 10, 13 ],\n\t\t'7(#9,b5)': [ 0, 4, 6, 10, 15 ],\n\t\t'7#9b5': [ 0, 4, 6, 10, 15 ],\n\t\t'maj7(b5)': [ 0, 3, 6, 11 ],\n\t\t'maj7b5': [ 0, 3, 6, 11 ],\n\t\t'13(b5)': [ 0, 4, 6, 10, 14, 18 ],\n\t\t'13b5': [ 0, 4, 6, 10, 14, 18 ],\n\n\t\t// minor (all normal 5, minor 3 chords)\n\t\t'm': [ 0, 3, 7 ],\n\t\t'-': [ 0, 3, 7 ],\n\t\t'm6': [ 0, 3, 7, 9 ],\n\t\t'-6': [ 0, 3, 7, 9 ],\n\t\t'm7': [ 0, 3, 7, 10 ],\n\t\t'-7': [ 0, 3, 7, 10 ],\n\n\t\t'-(b6)': [ 0, 3, 7, 8 ],\n\t\t'-b6': [ 0, 3, 7, 8 ],\n\t\t'-6/9': [ 0, 3, 7, 9, 14 ],\n\t\t'-7(b9)': [ 0, 3, 7, 10, 13 ],\n\t\t'-7b9': [ 0, 3, 7, 10, 13 ],\n\t\t'-maj7': [ 0, 3, 7, 11 ],\n\t\t'-9+7': [ 0, 3, 7, 11, 13 ],\n\t\t'-11': [  0, 3, 7, 11, 14, 16 ],\n\n\t\t// major (all normal 5, major 3 chords)\n\t\t'M': [ 0, 4, 7 ],\n\t\t'6': [ 0, 4, 7, 9 ],\n\t\t'6/9': [ 0, 4, 7, 9, 14 ],\n\n\t\t'7': [ 0, 4, 7, 10 ],\n\t\t'9': [ 0, 4, 7, 10, 14 ],\n\t\t'11': [ 0, 4, 7, 10, 14, 16 ],\n\t\t'13': [ 0, 4, 7, 10, 14, 18 ],\n\t\t'7b9': [ 0, 4, 7, 10, 13 ],\n\t\t'7♭9': [ 0, 4, 7, 10, 13 ],\n\t\t'7(b9)': [ 0, 4, 7, 10, 13 ],\n\t\t'7(#9)': [ 0, 4, 7, 10, 15 ],\n\t\t'7#9': [ 0, 4, 7, 10, 15 ],\n\t\t'(13)': [ 0, 4, 7, 10, 14, 18 ],\n\t\t'7(9,13)': [ 0, 4, 7, 10, 14, 18 ],\n\t\t'7(#9,b13)': [ 0, 4, 7, 10, 15, 17 ],\n\t\t'7(#11)': [ 0, 4, 7, 10, 14, 17 ],\n\t\t'7#11': [ 0, 4, 7, 10, 14, 17 ],\n\t\t'7(b13)': [ 0, 4, 7, 10, 17 ],\n\t\t'7b13': [ 0, 4, 7, 10, 17 ],\n\t\t'9(#11)': [ 0, 4, 7, 10, 14, 17 ],\n\t\t'9#11': [ 0, 4, 7, 10, 14, 17 ],\n\t\t'13(#11)': [ 0, 4, 7, 10, 15, 18 ],\n\t\t'13#11': [ 0, 4, 7, 10, 15, 18 ],\n\n\t\t'maj7': [ 0, 4, 7, 11 ],\n\t\t'∆7': [ 0, 4, 7, 11 ],\n\t\t'Δ7': [ 0, 4, 7, 11 ],\n\t\t'maj9': [ 0, 4, 7, 11, 14 ],\n\t\t'maj7(9)': [ 0, 4, 7, 11, 14 ],\n\t\t'maj7(11)': [ 0, 4, 7, 11, 16 ],\n\t\t'maj7(#11)': [ 0, 4, 7, 11, 17 ],\n\t\t'maj7(13)': [ 0, 4, 7, 11, 18 ],\n\t\t'maj7(9,13)': [ 0, 4, 7, 11, 14, 18 ],\n\n\t\t'7sus4': [ 0, 5, 7, 10 ],\n\t\t'm7sus4': [ 0, 5, 7, 10 ],\n\t\t'sus4': [ 0, 5, 7 ],\n\t\t'sus2': [ 0, 2, 7 ],\n\t\t'7sus2': [ 0, 2, 7, 10 ],\n\t\t'9sus4': [ 0, 5, 7, 14 ],\n\t\t'13sus4': [ 0, 5, 7, 18 ],\n\n\t\t// augmented (all sharp 5 chords)\n\t\t'aug7': [ 0, 4, 8, 10 ],\n\t\t'+7': [ 0, 4, 8, 10 ],\n\t\t'+': [ 0, 4, 8 ],\n\t\t'7#5': [ 0, 4, 8, 10 ],\n\t\t'7♯5': [ 0, 4, 8, 10 ],\n\t\t'7+5': [ 0, 4, 8, 10 ],\n\t\t'9#5': [ 0, 4, 8, 10, 14 ],\n\t\t'9♯5': [ 0, 4, 8, 10, 14 ],\n\t\t'9+5': [ 0, 4, 8, 10, 14 ],\n\t\t'-7(#5)': [ 0, 3, 8, 10 ],\n\t\t'-7#5': [ 0, 3, 8, 10 ],\n\t\t'7(#5)': [ 0, 4, 8, 10 ],\n\t\t'7(b9,#5)': [ 0, 4, 8, 10, 13 ],\n\t\t'7b9#5': [ 0, 4, 8, 10, 13 ],\n\t\t'maj7(#5)': [ 0, 4, 8, 11 ],\n\t\t'maj7#5': [ 0, 4, 8, 11 ],\n\t\t'maj7(#5,#11)': [ 0, 4, 8, 11, 14 ],\n\t\t'maj7#5#11': [ 0, 4, 8, 11, 14 ],\n\t\t'9(#5)': [ 0, 4, 8, 10, 14 ],\n\t\t'13(#5)': [ 0, 4, 8, 10, 14, 18 ],\n\t\t'13#5': [ 0, 4, 8, 10, 14, 18 ]\n};\n\tfunction chordNotes(bass, modifier) {\n\t\tvar intervals = chordIntervals[modifier];\n\t\tif (!intervals)\n\t\t\tintervals = chordIntervals.M;\n\t\tbass += 12;\t// the chord is an octave above the bass note.\n\t\tvar notes = [ ];\n\t\tfor (var i = 0; i < intervals.length; i++) {\n\t\t\tnotes.push(bass + intervals[i]);\n\t\t}\n\t\treturn notes;\n\t}\n\n\tfunction writeBoom(boom, beatLength) {\n\t\t// undefined means there is a stop time.\n\t\tif (boom !== undefined)\n\t\t\tchordTrack.push({cmd: 'start', pitch: boom, volume: 64});\n\t\tchordTrack.push({ cmd: 'move', duration: (beatLength/2)*tempoChangeFactor });\n\t\tif (boom !== undefined)\n\t\t\tchordTrack.push({ cmd: 'stop', pitch: boom });\n\t\tchordTrack.push({ cmd: 'move', duration: (beatLength/2)*tempoChangeFactor });\n\t}\n\n\tfunction writeChick(chick, beatLength) {\n\t\tfor (var c = 0; c < chick.length; c++)\n\t\t\tchordTrack.push({cmd: 'start', pitch: chick[c], volume: 48});\n\t\tchordTrack.push({ cmd: 'move', duration: (beatLength/2)*tempoChangeFactor });\n\t\tfor (c = 0; c < chick.length; c++)\n\t\t\tchordTrack.push({ cmd: 'stop', pitch: chick[c] });\n\t\tchordTrack.push({ cmd: 'move', duration: (beatLength/2)*tempoChangeFactor });\n\t}\n\n\tvar rhythmPatterns = { \"2/2\": [ 'boom', 'chick' ],\n\t\t\"2/4\": [ 'boom', 'chick' ],\n\t\t\"3/4\": [ 'boom', 'chick', 'chick' ],\n\t\t\"4/4\": [ 'boom', 'chick', 'boom2', 'chick' ],\n\t\t\"5/4\": [ 'boom', 'chick', 'chick', 'boom2', 'chick' ],\n\t\t\"6/8\": [ 'boom', '', 'chick', 'boom2', '', 'chick' ],\n\t\t\"9/8\": [ 'boom', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick' ],\n\t\t\"12/8\": [ 'boom', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick', 'boom2', '', 'chick' ],\n\t};\n\n\tfunction resolveChords() {\n\t\tvar num = meter.num;\n\t\tvar den = meter.den;\n\t\tvar beatLength = 1/den;\n\t\tvar pattern = rhythmPatterns[num+'/'+den];\n\t\tvar thisMeasureLength = parseInt(num,10)/parseInt(den,10);\n\t\t// See if this is a full measure: unfortunately, with triplets, there isn't an exact match, what with the floating point, so we just see if it is \"close\".\n\t\tvar portionOfAMeasure = Math.abs(thisMeasureLength - barBeat);\n\t\tif (!pattern || portionOfAMeasure > 0.0078125) { // If it is an unsupported meter, or this isn't a full bar, just chick on each beat.\n\t\t\tpattern = [];\n\t\t\tvar beatsPresent = barBeat / beatLength;\n\t\t\tfor (var p = 0; p < beatsPresent; p++)\n\t\t\t\tpattern.push(\"chick\");\n\t\t}\n\n\t\tif (currentChords.length === 0) { // there wasn't a new chord this measure, so use the last chord declared.\n\t\t\tcurrentChords.push({ beat: 0, chord: lastChord});\n\t\t}\n\t\tif (currentChords[0].beat !== 0 && lastChord) { // this is the case where there is a chord declared in the measure, but not on its first beat.\n\t\t\tcurrentChords.unshift({ beat: 0, chord: lastChord});\n\t\t}\n\t\tif (currentChords.length === 1) {\n\t\t\tfor (var m = 0; m < pattern.length; m++) {\n\t\t\t\tswitch (pattern[m]) {\n\t\t\t\t\tcase 'boom':\n\t\t\t\t\t\twriteBoom(currentChords[0].chord.boom, beatLength);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'boom2':\n\t\t\t\t\t\twriteBoom(currentChords[0].chord.boom2, beatLength);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'chick':\n\t\t\t\t\t\twriteChick(currentChords[0].chord.chick, beatLength);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase '':\n\t\t\t\t\t\tchordTrack.push({ cmd: 'move', duration: beatLength*tempoChangeFactor });\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// If we are here it is because more than one chord was declared in the measure, so we have to sort out what chord goes where.\n\n\t\t// First, normalize the chords on beats.\n\t\tvar beats = {};\n\t\tfor (var i = 0; i < currentChords.length; i++) {\n\t\t\tvar cc = currentChords[i];\n\t\t\tvar beat = Math.floor(cc.beat / beatLength);\t// now all the beats are integers, there may be\n\t\t\tbeats[''+beat] = cc;\n\t\t}\n\n\t\t// - If there is a chord on the second beat, play a chord for the first beat instead of a bass note.\n\t\t// - Likewise, if there is a chord on the fourth beat of 4/4, play a chord on the third beat instead of a bass note.\n\t\tfor (var m2 = 0; m2 < pattern.length; m2++) {\n\t\t\tvar thisChord;\n\t\t\tif (beats[''+m2])\n\t\t\t\tthisChord = beats[''+m2];\n\t\t\tswitch (pattern[m2]) {\n\t\t\t\tcase 'boom':\n\t\t\t\t\tif (beats[''+(m2+1)]) // If there is not a chord change on the next beat, play a bass note.\n\t\t\t\t\t\twriteChick(thisChord.chord.chick, beatLength);\n\t\t\t\t\telse\n\t\t\t\t\t\twriteBoom(thisChord.chord.boom, beatLength);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'boom2':\n\t\t\t\t\tif (beats[''+(m2+1)])\n\t\t\t\t\t\twriteChick(thisChord.chord.chick, beatLength);\n\t\t\t\t\telse\n\t\t\t\t\t\twriteBoom(thisChord.chord.boom2, beatLength);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'chick':\n\t\t\t\t\twriteChick(thisChord.chord.chick, beatLength);\n\t\t\t\t\tbreak;\n\t\t\t\tcase '':\n\t\t\t\t\tif (beats[''+m2])\t// If there is an explicit chord on this beat, play it.\n\t\t\t\t\t\twriteChick(thisChord.chord.chick, beatLength);\n\t\t\t\t\telse\n\t\t\t\t\t\tchordTrack.push({cmd: 'move', duration: beatLength*tempoChangeFactor });\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction normalizeDrumDefinition(params) {\n\t\t// Be very strict with the drum definition. If anything is not perfect,\n\t\t// just turn the drums off.\n\t\t// Perhaps all of this logic belongs in the parser instead.\n\t\tif (params.pattern.length === 0 || params.on === false)\n\t\t\treturn { on: false };\n\n\t\tvar str = params.pattern[0];\n\t\tvar events = [];\n\t\tvar event = \"\";\n\t\tvar totalPlay = 0;\n\t\tfor (var i = 0; i < str.length; i++) {\n\t\t\tif (str[i] === 'd')\n\t\t\t\ttotalPlay++;\n\t\t\tif (str[i] === 'd' || str[i] === 'z') {\n\t\t\t\tif (event.length !== 0) {\n\t\t\t\t\tevents.push(event);\n\t\t\t\t\tevent = str[i];\n\t\t\t\t} else\n\t\t\t\t\tevent = event + str[i];\n\t\t\t} else {\n\t\t\t\tif (event.length === 0) {\n\t\t\t\t\t// there was an error: the string should have started with d or z\n\t\t\t\t\treturn {on: false};\n\t\t\t\t}\n\t\t\t\tevent = event + str[i];\n\t\t\t}\n\t\t}\n\n\t\tif (event.length !== 0)\n\t\t\tevents.push(event);\n\n\t\t// Now the events array should have one item per event.\n\t\t// There should be two more params for each event: the volume and the pitch.\n\t\tif (params.pattern.length !== totalPlay*2 + 1)\n\t\t\treturn { on: false };\n\n\t\tvar ret = { on: true, bars: params.bars, pattern: []};\n\t\tvar beatLength = 1/meter.den;\n\t\tvar playCount = 0;\n\t\tfor (var j = 0; j < events.length; j++) {\n\t\t\tevent = events[j];\n\t\t\tvar len = 1;\n\t\t\tvar div = false;\n\t\t\tvar num = 0;\n\t\t\tfor (var k = 1; k < event.length; k++) {\n\t\t\t\tswitch(event[k]) {\n\t\t\t\t\tcase \"/\":\n\t\t\t\t\t\tif (num !== 0)\n\t\t\t\t\t\t\tlen *= num;\n\t\t\t\t\t\tnum = 0;\n\t\t\t\t\t\tdiv = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"1\":\n\t\t\t\t\tcase \"2\":\n\t\t\t\t\tcase \"3\":\n\t\t\t\t\tcase \"4\":\n\t\t\t\t\tcase \"5\":\n\t\t\t\t\tcase \"6\":\n\t\t\t\t\tcase \"7\":\n\t\t\t\t\tcase \"8\":\n\t\t\t\t\tcase \"9\":\n\t\t\t\t\t\tnum = num*10 +event[k];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn { on: false };\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (div) {\n\t\t\t\tif (num === 0) num = 2; // a slash by itself is interpreted as \"/2\"\n\t\t\t\tlen /= num;\n\t\t\t} else if (num)\n\t\t\t\tlen *= num;\n\t\t\tif (event[0] === 'd') {\n\t\t\t\tret.pattern.push({ len: len * beatLength, pitch: params.pattern[1 + playCount], velocity: params.pattern[1 + playCount + totalPlay]});\n\t\t\t\tplayCount++;\n\t\t\t} else\n\t\t\t\tret.pattern.push({ len: len * beatLength, pitch: null});\n\t\t}\n\t\t// Now normalize the pattern to cover the correct number of measures. The note lengths passed are relative to each other and need to be scaled to fit a measure.\n\t\tvar totalTime = 0;\n\t\tvar measuresPerBeat = meter.num/meter.den;\n\t\tfor (var ii = 0; ii < ret.pattern.length; ii++)\n\t\t\ttotalTime += ret.pattern[ii].len;\n\t\tvar numBars = params.bars ? params.bars : 1;\n\t\tvar factor = totalTime /  numBars / measuresPerBeat;\n\t\tfor (ii = 0; ii < ret.pattern.length; ii++)\n\t\t\tret.pattern[ii].len = ret.pattern[ii].len / factor;\n\t\treturn ret;\n\t}\n\n\tfunction drumBeat(pitch, soundLength, volume) {\n\t\tdrumTrack.push({ cmd: 'start', pitch: pitch - 60, volume: volume});\n\t\tdrumTrack.push({ cmd: 'move', duration: soundLength });\n\t\tdrumTrack.push({ cmd: 'stop', pitch: pitch - 60 });\n\t}\n\n\tfunction writeDrum(channel) {\n\t\tif (drumTrack.length === 0 && !drumDefinition.on)\n\t\t\treturn;\n\n\t\tvar measureLen = meter.num/meter.den;\n\t\tif (drumTrack.length === 0) {\n\t\t\tdrumTrack.push({cmd: 'program', channel: channel, instrument: drumInstrument});\n\t\t\t// need to figure out how far in time the bar started: if there are pickup notes before the chords start, we need pauses.\n\t\t\tvar distance = timeFromStart();\n\t\t\tif (distance > 0 && distance < measureLen - 0.01) { // because of floating point, adding the notes might not exactly equal the measure size.\n\t\t\t\tdrumTrack.push({cmd: 'move', duration: distance * tempoChangeFactor});\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (!drumDefinition.on) {\n\t\t\t// this is the case where there has been a drum track, but it was specifically turned off.\n\t\t\tdrumTrack.push({ cmd: 'move', duration: measureLen * tempoChangeFactor });\n\t\t\treturn;\n\t\t}\n\t\tfor (var i = 0; i < drumDefinition.pattern.length; i++) {\n\t\t\tvar len = drumDefinition.pattern[i].len * tempoChangeFactor;\n\t\t\tif (drumDefinition.pattern[i].pitch)\n\t\t\t\tdrumBeat(drumDefinition.pattern[i].pitch, len, drumDefinition.pattern[i].velocity);\n\t\t\telse\n\t\t\t\tdrumTrack.push({ cmd: 'move', duration: len });\n\t\t}\n\t}\n})();\n\nmodule.exports = flatten;\n"]},"metadata":{},"sourceType":"script"}