{"ast":null,"code":"//    abc_renderer.js: API to render to SVG/Raphael/whatever rendering engine\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global Math, console */\nvar glyphs = require('./abc_glyphs');\n\nvar spacing = require('./abc_spacing');\n\nvar sprintf = require('./sprintf');\n\nvar Svg = require('./svg');\n/**\n * Implements the API for rendering ABCJS Abstract Rendering Structure to a canvas/paper (e.g. SVG, Raphael, etc)\n * @param {Object} paper\n * @param {bool} doRegression\n */\n\n\nvar Renderer = function (paper, doRegression, shouldAddClasses) {\n  this.paper = new Svg(paper);\n  this.controller = null; //TODO-GD only used when drawing the ABCJS ARS to connect the controller with the elements for highlighting\n\n  this.space = 3 * spacing.SPACE;\n  this.padding = {}; // renderer's padding is managed by the controller\n\n  this.doRegression = doRegression;\n  this.shouldAddClasses = shouldAddClasses;\n  if (this.doRegression) this.regressionLines = [];\n  this.reset();\n};\n\nRenderer.prototype.reset = function () {\n  this.paper.clear();\n  this.y = 0;\n  this.abctune = null;\n  this.lastM = null;\n  this.ingroup = false;\n  this.path = null;\n  this.isPrint = false;\n  this.initVerticalSpace();\n  if (this.doRegression) this.regressionLines = []; // HACK-PER: There was a problem in Raphael where every path string that was sent to it was cached.\n  // That was causing the browser's memory to steadily grow until the browser went slower and slower until\n  // it crashed. The fix to that was a patch to Raphael, so it is only patched on the versions of this library that\n  // bundle Raphael with it. Also, if Raphael gets an update, then that patch will be lost. On version 2.1.2 of Raphael,\n  // the patch is on line 1542 and 1545 and it is:\n  //             p[ps].sleep = 1;\n};\n\nRenderer.prototype.newTune = function (abcTune) {\n  this.abctune = abcTune; // TODO-PER: this is just to get the font info.\n\n  this.setVerticalSpace(abcTune.formatting);\n  this.measureNumber = null;\n  this.noteNumber = null;\n  this.setPrintMode(abcTune.media === 'print');\n  this.setPadding(abcTune);\n};\n\nRenderer.prototype.createElemSet = function () {\n  return this.paper.openGroup();\n};\n\nRenderer.prototype.closeElemSet = function () {\n  return this.paper.closeGroup();\n};\n/**\n * Set whether we are formatting this for the screen, or as a preview for creating a PDF version.\n * @param {bool} isPrint\n */\n\n\nRenderer.prototype.setPrintMode = function (isPrint) {\n  this.isPrint = isPrint;\n};\n/**\n * Set the size of the canvas.\n * @param {object} maxwidth\n * @param {object} scale\n */\n\n\nRenderer.prototype.setPaperSize = function (maxwidth, scale, responsive) {\n  var w = (maxwidth + this.padding.right) * scale;\n  var h = (this.y + this.padding.bottom) * scale;\n  if (this.isPrint) h = Math.max(h, 1056); // 11in x 72pt/in x 1.33px/pt\n  // TODO-PER: We are letting the page get as long as it needs now, but eventually that should go to a second page.\n\n  if (this.doRegression) this.regressionLines.push(\"PAPER SIZE: (\" + w + \",\" + h + \")\"); // for accessibility\n\n  var text = \"Sheet Music\";\n  if (this.abctune && this.abctune.metaText && this.abctune.metaText.title) text += \" for \\\"\" + this.abctune.metaText.title + '\"';\n  this.paper.setTitle(text);\n  var parentStyles = {\n    overflow: \"hidden\"\n  };\n\n  if (responsive === 'resize') {\n    this.paper.setResponsiveWidth(w, h);\n  } else {\n    parentStyles.width = \"\";\n    parentStyles.height = h + \"px\";\n\n    if (scale < 1) {\n      parentStyles.width = w + \"px\";\n      this.paper.setSize(w / scale, h / scale);\n    } else this.paper.setSize(w, h);\n  }\n\n  this.paper.setScale(scale);\n  this.paper.setParentStyles(parentStyles);\n};\n/**\n * Set the padding\n * @param {object} params\n */\n\n\nRenderer.prototype.setPaddingOverride = function (params) {\n  this.paddingOverride = {\n    top: params.paddingtop,\n    bottom: params.paddingbottom,\n    right: params.paddingright,\n    left: params.paddingleft\n  };\n};\n/**\n * Set the padding\n * @param {object} params\n */\n\n\nRenderer.prototype.setPadding = function (abctune) {\n  // If the padding is set in the tune, then use that.\n  // Otherwise, if the padding is set in the override, use that.\n  // Otherwise, use the defaults (there are a different set of defaults for screen and print.)\n  function setPaddingVariable(self, paddingKey, formattingKey, printDefault, screenDefault) {\n    if (abctune.formatting[formattingKey] !== undefined) self.padding[paddingKey] = abctune.formatting[formattingKey];else if (self.paddingOverride[paddingKey] !== undefined) self.padding[paddingKey] = self.paddingOverride[paddingKey];else if (self.isPrint) self.padding[paddingKey] = printDefault;else self.padding[paddingKey] = screenDefault;\n  } // 1cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 38px\n  // 1.8cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 68px\n\n\n  setPaddingVariable(this, 'top', 'topmargin', 38, 15);\n  setPaddingVariable(this, 'bottom', 'botmargin', 38, 15);\n  setPaddingVariable(this, 'left', 'leftmargin', 68, 15);\n  setPaddingVariable(this, 'right', 'rightmargin', 68, 15);\n};\n/**\n * Some of the items on the page are not scaled, so adjust them in the opposite direction of scaling to cancel out the scaling.\n * @param {float} scale\n */\n\n\nRenderer.prototype.adjustNonScaledItems = function (scale) {\n  this.padding.top /= scale;\n  this.padding.bottom /= scale;\n  this.padding.left /= scale;\n  this.padding.right /= scale;\n  this.abctune.formatting.headerfont.size /= scale;\n  this.abctune.formatting.footerfont.size /= scale;\n};\n/**\n * Set the the values for all the configurable vertical space options.\n */\n\n\nRenderer.prototype.initVerticalSpace = function () {\n  // conversion: 37.7953 = conversion factor for cm to px.\n  // All of the following values are in px.\n  this.spacing = {\n    composer: 7.56,\n    // Set the vertical space above the composer.\n    graceBefore: 8.67,\n    // Define the space before, inside and after the grace notes.\n    graceInside: 10.67,\n    graceAfter: 16,\n    info: 0,\n    // Set the vertical space above the infoline.\n    lineSkipFactor: 1.1,\n    // Set the factor for spacing between lines of text. (multiply this by the font size)\n    music: 7.56,\n    // Set the vertical space above the first staff.\n    paragraphSkipFactor: 0.4,\n    // Set the factor for spacing between text paragraphs. (multiply this by the font size)\n    parts: 11.33,\n    // Set the vertical space above a new part.\n    slurHeight: 1.0,\n    // Set the slur height factor.\n    staffSeparation: 61.33,\n    // Do not put a staff system closer than <unit> from the previous system.\n    stemHeight: 26.67 + 10,\n    // Set the stem height.\n    subtitle: 3.78,\n    // Set the vertical space above the subtitle.\n    systemStaffSeparation: 48,\n    // Do not place the staves closer than <unit> inside a system. * This values applies to all staves when in the tune header. Otherwise, it applies to the next staff\n    text: 18.9,\n    // Set the vertical space above the history.\n    title: 7.56,\n    // Set the vertical space above the title.\n    top: 30.24,\n    //Set the vertical space above the tunes and on the top of the continuation pages.\n    vocal: 30.67,\n    // Set the vertical space above the lyrics under the staves.\n    words: 0 // Set the vertical space above the lyrics at the end of the tune.\n\n  };\n  /*\n  TODO-PER: Handle the x-coordinate spacing items, too.\n  maxshrink <float>Default: 0.65\n  Set how much to compress horizontally when music line breaks\n  are automatic.\n  <float> must be between 0 (natural spacing)\n  and 1 (max shrinking).\n  // This next value is used to compute the natural spacing of\n  // the notes. The base spacing of the crotchet is always\n  // 40 pts. When the duration of a note type is twice the\n  // duration of an other note type, its spacing is multiplied\n  // by this factor.\n  // The default value causes the note spacing to be multiplied\n  // by 2 when its duration is multiplied by 4, i.e. the\n  // space of the semibreve is 80 pts and the space of the\n  // semiquaver is 20 pts.\n  // Setting this value to 1 sets all note spacing to 40 pts.\n  noteSpacingFactor: 1.414, // Set the note spacing factor to <float> (range 1..2).\n  scale <float> Default: 0.75 Set the page scale factor. Note that the header and footer are not scaled.\n  stretchlast <float>Default: 0.8\n  Stretch the last music line of a tune when it exceeds\n  the <float> fraction of the page width.\n  <float> range is 0.0 to 1.0.\n   */\n};\n\nRenderer.prototype.setVerticalSpace = function (formatting) {\n  // conversion from pts to px 4/3\n  if (formatting.staffsep !== undefined) this.spacing.staffSeparation = formatting.staffsep * 4 / 3;\n  if (formatting.composerspace !== undefined) this.spacing.composer = formatting.composerspace * 4 / 3;\n  if (formatting.partsspace !== undefined) this.spacing.parts = formatting.partsspace * 4 / 3;\n  if (formatting.textspace !== undefined) this.spacing.text = formatting.textspace * 4 / 3;\n  if (formatting.musicspace !== undefined) this.spacing.music = formatting.musicspace * 4 / 3;\n  if (formatting.titlespace !== undefined) this.spacing.title = formatting.titlespace * 4 / 3;\n  if (formatting.sysstaffsep !== undefined) this.spacing.systemStaffSeparation = formatting.sysstaffsep * 4 / 3;\n  if (formatting.subtitlespace !== undefined) this.spacing.subtitle = formatting.subtitlespace * 4 / 3;\n  if (formatting.topspace !== undefined) this.spacing.top = formatting.topspace * 4 / 3;\n  if (formatting.vocalspace !== undefined) this.spacing.vocal = formatting.vocalspace * 4 / 3;\n  if (formatting.wordsspace !== undefined) this.spacing.words = formatting.wordsspace * 4 / 3;\n};\n/**\n * Leave space at the top of the paper\n * @param {object} abctune\n */\n\n\nRenderer.prototype.topMargin = function (abctune) {\n  this.moveY(this.padding.top);\n};\n/**\n * Leave space before printing the music\n */\n\n\nRenderer.prototype.addMusicPadding = function () {\n  this.moveY(this.spacing.music);\n};\n/**\n * Leave space before printing a staff system\n */\n\n\nRenderer.prototype.addStaffPadding = function (lastStaffGroup, thisStaffGroup) {\n  var lastStaff = lastStaffGroup.staffs[lastStaffGroup.staffs.length - 1];\n  var lastBottomLine = -(lastStaff.bottom - 2); // The 2 is because the scale goes to 2 below the last line.\n\n  var nextTopLine = thisStaffGroup.staffs[0].top - 10; // Because 10 represents the top line.\n\n  var naturalSeparation = nextTopLine + lastBottomLine; // This is how far apart they'd be without extra spacing\n\n  var separationInPixels = naturalSeparation * spacing.STEP;\n  if (separationInPixels < this.spacing.staffSeparation) this.moveY(this.spacing.staffSeparation - separationInPixels);\n};\n/**\n * Text that goes above the score\n * @param {number} width\n * @param {object} abctune\n */\n\n\nRenderer.prototype.engraveTopText = function (width, abctune) {\n  if (abctune.metaText.header && this.isPrint) {\n    // Note: whether there is a header or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n    // This text goes above the margin, so we'll temporarily move up.\n    var headerTextHeight = this.getTextSize(\"XXXX\", \"headerfont\", 'abcjs-header abcjs-meta-top').height;\n    this.y -= headerTextHeight;\n    this.outputTextIf(this.padding.left, abctune.metaText.header.left, 'headerfont', 'header meta-top', 0, null, 'start');\n    this.outputTextIf(this.padding.left + width / 2, abctune.metaText.header.center, 'headerfont', 'header meta-top', 0, null, 'middle');\n    this.outputTextIf(this.padding.left + width, abctune.metaText.header.right, 'headerfont', 'header meta-top', 0, null, 'end');\n    this.y += headerTextHeight;\n  }\n\n  if (this.isPrint) this.moveY(this.spacing.top);\n  this.outputTextIf(this.padding.left + width / 2, abctune.metaText.title, 'titlefont', 'title meta-top', this.spacing.title, 0, 'middle');\n  if (abctune.lines[0]) this.outputTextIf(this.padding.left + width / 2, abctune.lines[0].subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n\n  if (abctune.metaText.rhythm || abctune.metaText.origin || abctune.metaText.composer) {\n    this.moveY(this.spacing.composer);\n    var rSpace = this.outputTextIf(this.padding.left, abctune.metaText.rhythm, 'infofont', 'meta-top', 0, null, \"start\");\n    var composerLine = \"\";\n    if (abctune.metaText.composer) composerLine += abctune.metaText.composer;\n    if (abctune.metaText.origin) composerLine += ' (' + abctune.metaText.origin + ')';\n\n    if (composerLine.length > 0) {\n      var space = this.outputTextIf(this.padding.left + width, composerLine, 'composerfont', 'meta-top', 0, null, \"end\");\n      this.moveY(space[1]);\n    } else {\n      this.moveY(rSpace[1]);\n    } // TODO-PER: The following is a hack to make the elements line up with abcm2ps. Don't know where the extra space is coming from.\n\n\n    this.moveY(-6); //} else if (this.isPrint) {\n    //\t// abcm2ps adds this space whether there is anything to write or not.\n    //\tthis.moveY(this.spacing.composer);\n    //\tvar space2 = this.getTextSize(\"M\", 'composerfont', 'meta-top');\n    //\tthis.moveY(space2.height);\n  }\n\n  this.outputTextIf(this.padding.left + width, abctune.metaText.author, 'composerfont', 'meta-top', 0, 0, \"end\"); //this.skipSpaceY();\n\n  this.outputTextIf(this.padding.left, abctune.metaText.partOrder, 'partsfont', 'meta-bottom', 0, 0, \"start\");\n};\n/**\n * Text that goes below the score\n * @param {number} width\n * @param {object} abctune\n */\n\n\nRenderer.prototype.engraveExtraText = function (width, abctune) {\n  this.lineNumber = null;\n  this.measureNumber = null;\n  this.noteNumber = null;\n  this.voiceNumber = null;\n\n  if (abctune.metaText.unalignedWords) {\n    var hash = this.getFontAndAttr(\"wordsfont\", 'meta-bottom');\n    var space = this.getTextSize(\"i\", 'wordsfont', 'meta-bottom');\n    if (abctune.metaText.unalignedWords.length > 0) this.moveY(this.spacing.words, 1);\n\n    for (var j = 0; j < abctune.metaText.unalignedWords.length; j++) {\n      if (abctune.metaText.unalignedWords[j] === '') this.moveY(hash.font.size, 1);else if (typeof abctune.metaText.unalignedWords[j] === 'string') {\n        this.outputTextIf(this.padding.left + spacing.INDENT, abctune.metaText.unalignedWords[j], 'wordsfont', 'meta-bottom', 0, 0, \"start\");\n      } else {\n        var largestY = 0;\n        var offsetX = 0;\n\n        for (var k = 0; k < abctune.metaText.unalignedWords[j].length; k++) {\n          var thisWord = abctune.metaText.unalignedWords[j][k];\n          var type = thisWord.font ? thisWord.font : \"wordsfont\";\n          var el = this.renderText(this.padding.left + spacing.INDENT + offsetX, this.y, thisWord.text, type, 'meta-bottom', false);\n          var size = this.getTextSize(thisWord.text, type, 'meta-bottom');\n          largestY = Math.max(largestY, size.height);\n          offsetX += size.width; // If the phrase ends in a space, then that is not counted in the width, so we need to add that in ourselves.\n\n          if (thisWord.text[thisWord.text.length - 1] === ' ') {\n            offsetX += space.width;\n          }\n        }\n\n        this.moveY(largestY, 1);\n      }\n    }\n\n    if (abctune.metaText.unalignedWords.length > 0) this.moveY(hash.font.size, 2);\n  }\n\n  var extraText = \"\";\n  if (abctune.metaText.book) extraText += \"Book: \" + abctune.metaText.book + \"\\n\";\n  if (abctune.metaText.source) extraText += \"Source: \" + abctune.metaText.source + \"\\n\";\n  if (abctune.metaText.discography) extraText += \"Discography: \" + abctune.metaText.discography + \"\\n\";\n  if (abctune.metaText.notes) extraText += \"Notes: \" + abctune.metaText.notes + \"\\n\";\n  if (abctune.metaText.transcription) extraText += \"Transcription: \" + abctune.metaText.transcription + \"\\n\";\n  if (abctune.metaText.history) extraText += \"History: \" + abctune.metaText.history + \"\\n\";\n  if (abctune.metaText['abc-copyright']) extraText += \"Copyright: \" + abctune.metaText['abc-copyright'] + \"\\n\";\n  if (abctune.metaText['abc-creator']) extraText += \"Creator: \" + abctune.metaText['abc-creator'] + \"\\n\";\n  if (abctune.metaText['abc-edited-by']) extraText += \"Edited By: \" + abctune.metaText['abc-edited-by'] + \"\\n\";\n  this.outputTextIf(this.padding.left, extraText, 'historyfont', 'meta-bottom', this.spacing.info, 0, \"start\");\n\n  if (abctune.metaText.footer && this.isPrint) {\n    // Note: whether there is a footer or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n    this.outputTextIf(this.padding.left, abctune.metaText.footer.left, 'footerfont', 'header meta-bottom', 0, null, 'start');\n    this.outputTextIf(this.padding.left + width / 2, abctune.metaText.footer.center, 'footerfont', 'header meta-bottom', 0, null, 'middle');\n    this.outputTextIf(this.padding.left + width, abctune.metaText.footer.right, 'footerfont', 'header meta-bottom', 0, null, 'end');\n  }\n};\n/**\n * Output text defined with %%text.\n * @param {array or string} text\n */\n\n\nRenderer.prototype.outputFreeText = function (text, vskip) {\n  if (vskip) this.moveY(vskip);\n  var hash = this.getFontAndAttr('textfont', 'defined-text');\n\n  if (text === \"\") {\n    // we do want to print out blank lines if they have been specified.\n    this.moveY(hash.attr['font-size'] * 2); // move the distance of the line, plus the distance of the margin, which is also one line.\n  } else if (typeof text === 'string') {\n    this.moveY(hash.attr['font-size'] / 2); // TODO-PER: move down some - the y location should be the top of the text, but we output text specifying the center line.\n\n    this.outputTextIf(this.padding.left, text, 'textfont', 'defined-text', 0, 0, \"start\");\n  } else {\n    var str = \"\";\n    var isCentered = false; // The structure is wrong here: it requires an array to do centering, but it shouldn't have.\n\n    for (var i = 0; i < text.length; i++) {\n      if (text[i].font) str += \"FONT(\" + text[i].font + \")\";\n      str += text[i].text;\n      if (text[i].center) isCentered = true;\n    }\n\n    var alignment = isCentered ? 'middle' : 'start';\n    var x = isCentered ? this.controller.width / 2 : this.padding.left;\n    this.outputTextIf(x, str, 'textfont', 'defined-text', 0, 1, alignment);\n  }\n};\n\nRenderer.prototype.outputSeparator = function (separator) {\n  if (!separator.lineLength) return;\n  this.moveY(separator.spaceAbove);\n  this.printSeparator(separator.lineLength);\n  this.moveY(separator.spaceBelow);\n};\n/**\n * Output an extra subtitle that is defined later in the tune.\n */\n\n\nRenderer.prototype.outputSubtitle = function (width, subtitle) {\n  this.outputTextIf(this.padding.left + width / 2, subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n};\n/**\n * Begin a group of glyphs that will always be moved, scaled and highlighted together\n */\n\n\nRenderer.prototype.beginGroup = function () {\n  this.path = [];\n  this.lastM = [0, 0];\n  this.ingroup = true;\n};\n/**\n * Add a path to the current group\n * @param {Array} path\n * @private\n */\n\n\nRenderer.prototype.addPath = function (path) {\n  path = path || [];\n  if (path.length === 0) return;\n  path[0][0] = \"m\";\n  path[0][1] -= this.lastM[0];\n  path[0][2] -= this.lastM[1];\n  this.lastM[0] += path[0][1];\n  this.lastM[1] += path[0][2];\n  this.path.push(path[0]);\n\n  for (var i = 1, ii = path.length; i < ii; i++) {\n    if (path[i][0] === \"m\") {\n      this.lastM[0] += path[i][1];\n      this.lastM[1] += path[i][2];\n    }\n\n    this.path.push(path[i]);\n  }\n};\n/**\n * End a group of glyphs that will always be moved, scaled and highlighted together\n */\n\n\nRenderer.prototype.endGroup = function (klass) {\n  this.ingroup = false;\n  if (this.path.length === 0) return null;\n  var path = \"\";\n\n  for (var i = 0; i < this.path.length; i++) path += this.path[i].join(\" \");\n\n  var ret = this.paper.path({\n    path: path,\n    stroke: \"none\",\n    fill: \"#000000\",\n    'class': this.addClasses(klass)\n  });\n  this.path = [];\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * gets scaled\n * @param {number} x1 start x\n * @param {number} x2 end x\n * @param {number} pitch pitch the stave line is drawn at\n */\n\n\nRenderer.prototype.printStaveLine = function (x1, x2, pitch, klass) {\n  var extraClass = \"staff\";\n  if (klass !== undefined) extraClass += \" \" + klass;\n  var isIE =\n  /*@cc_on!@*/\n  false; //IE detector\n\n  var dy = 0.35;\n  var fill = \"#000000\";\n\n  if (isIE) {\n    dy = 1;\n    fill = \"#666666\";\n  }\n\n  var y = this.calcY(pitch);\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x2, y - dy, x2, y + dy, x1, y + dy);\n  var ret = this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses(extraClass)\n  });\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * gets scaled if not in a group\n * @param {number} x x coordinate of the stem\n * @param {number} dx stem width\n * @param {number} y1 y coordinate of the stem bottom\n * @param {number} y2 y coordinate of the stem top\n */\n\n\nRenderer.prototype.printStem = function (x, dx, y1, y2) {\n  if (dx < 0) {\n    // correct path \"handedness\" for intersection with other elements\n    var tmp = y2;\n    y2 = y1;\n    y1 = tmp;\n  }\n\n  var isIE =\n  /*@cc_on!@*/\n  false; //IE detector\n\n  var fill = \"#000000\";\n\n  if (isIE && dx < 1) {\n    dx = 1;\n    fill = \"#666666\";\n  }\n\n  if (~~x === x) x += 0.05; // raphael does weird rounding (for VML)\n\n  var pathArray = [[\"M\", x, y1], [\"L\", x, y2], [\"L\", x + dx, y2], [\"L\", x + dx, y1], [\"z\"]];\n\n  if (!isIE && this.ingroup) {\n    this.addPath(pathArray);\n  } else {\n    var path = \"\";\n\n    for (var i = 0; i < pathArray.length; i++) path += pathArray[i].join(\" \");\n\n    var ret = this.paper.pathToBack({\n      path: path,\n      stroke: \"none\",\n      fill: fill,\n      'class': this.addClasses('stem')\n    });\n    if (this.doRegression) this.addToRegression(ret);\n    return ret;\n  }\n};\n\nfunction kernSymbols(lastSymbol, thisSymbol, lastSymbolWidth) {\n  // This is just some adjustments to make it look better.\n  var width = lastSymbolWidth;\n  if (lastSymbol === 'f' && thisSymbol === 'f') width = width * 2 / 3;\n  if (lastSymbol === 'p' && thisSymbol === 'p') width = width * 5 / 6;\n  if (lastSymbol === 'f' && thisSymbol === 'z') width = width * 5 / 8;\n  return width;\n}\n/**\n * assumes this.y is set appropriately\n * if symbol is a multichar string without a . (as in scripts.staccato) 1 symbol per char is assumed\n * not scaled if not in printgroup\n */\n\n\nRenderer.prototype.printSymbol = function (x, offset, symbol, scalex, scaley, klass) {\n  var el;\n  var ycorr;\n  if (!symbol) return null;\n\n  if (symbol.length > 1 && symbol.indexOf(\".\") < 0) {\n    this.paper.openGroup();\n    var dx = 0;\n\n    for (var i = 0; i < symbol.length; i++) {\n      var s = symbol.charAt(i);\n      ycorr = glyphs.getYCorr(s);\n      el = glyphs.printSymbol(x + dx, this.calcY(offset + ycorr), s, this.paper, klass);\n\n      if (el) {\n        if (this.doRegression) this.addToRegression(el); //elemset.push(el);\n\n        if (i < symbol.length - 1) dx += kernSymbols(s, symbol.charAt(i + 1), glyphs.getSymbolWidth(s));\n      } else {\n        this.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n      }\n    }\n\n    return this.paper.closeGroup();\n  } else {\n    ycorr = glyphs.getYCorr(symbol);\n\n    if (this.ingroup) {\n      this.addPath(glyphs.getPathForSymbol(x, this.calcY(offset + ycorr), symbol, scalex, scaley));\n    } else {\n      el = glyphs.printSymbol(x, this.calcY(offset + ycorr), symbol, this.paper, klass);\n\n      if (el) {\n        if (this.doRegression) this.addToRegression(el);\n        return el;\n      } else this.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n    }\n\n    return null;\n  }\n};\n\nRenderer.prototype.scaleExistingElem = function (elem, scaleX, scaleY, x, y) {\n  this.paper.setAttributeOnElement(elem, {\n    style: \"transform:scale(\" + scaleX + \",\" + scaleY + \");transform-origin:\" + x + \"px \" + y + \"px;\"\n  });\n};\n\nRenderer.prototype.printPath = function (attrs) {\n  var ret = this.paper.path(attrs);\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n\nRenderer.prototype.drawBrace = function (xLeft, yTop, yBottom) {\n  //Tony\n  var yHeight = yBottom - yTop;\n  var xCurve = [7.5, -8, 21, 0, 18.5, -10.5, 7.5];\n  var yCurve = [0, yHeight / 5.5, yHeight / 3.14, yHeight / 2, yHeight / 2.93, yHeight / 4.88, 0];\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", xLeft + xCurve[0], yTop + yCurve[0], xLeft + xCurve[1], yTop + yCurve[1], xLeft + xCurve[2], yTop + yCurve[2], xLeft + xCurve[3], yTop + yCurve[3], xLeft + xCurve[4], yTop + yCurve[4], xLeft + xCurve[5], yTop + yCurve[5], xLeft + xCurve[6], yTop + yCurve[6]);\n  var ret1 = this.paper.path({\n    path: pathString,\n    stroke: \"#000000\",\n    fill: \"#000000\",\n    'class': this.addClasses('brace')\n  });\n  xCurve = [0, 17.5, -7.5, 6.6, -5, 20, 0];\n  yCurve = [yHeight / 2, yHeight / 1.46, yHeight / 1.22, yHeight, yHeight / 1.19, yHeight / 1.42, yHeight / 2];\n  pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", xLeft + xCurve[0], yTop + yCurve[0], xLeft + xCurve[1], yTop + yCurve[1], xLeft + xCurve[2], yTop + yCurve[2], xLeft + xCurve[3], yTop + yCurve[3], xLeft + xCurve[4], yTop + yCurve[4], xLeft + xCurve[5], yTop + yCurve[5], xLeft + xCurve[6], yTop + yCurve[6]);\n  var ret2 = this.paper.path({\n    path: pathString,\n    stroke: \"#000000\",\n    fill: \"#000000\",\n    'class': this.addClasses('brace')\n  });\n\n  if (this.doRegression) {\n    this.addToRegression(ret1);\n    this.addToRegression(ret2);\n  }\n\n  return ret1 + ret2;\n};\n\nRenderer.prototype.drawArc = function (x1, x2, pitch1, pitch2, above, klass, isTie) {\n  // If it is a tie vs. a slur, draw it shallower.\n  var spacing = isTie ? 1.2 : 1.5;\n  x1 = x1 + 6;\n  x2 = x2 + 4;\n  pitch1 = pitch1 + (above ? spacing : -spacing);\n  pitch2 = pitch2 + (above ? spacing : -spacing);\n  var y1 = this.calcY(pitch1);\n  var y2 = this.calcY(pitch2); //unit direction vector\n\n  var dx = x2 - x1;\n  var dy = y2 - y1;\n  var norm = Math.sqrt(dx * dx + dy * dy);\n  var ux = dx / norm;\n  var uy = dy / norm;\n  var flatten = norm / 3.5;\n  var maxFlatten = isTie ? 10 : 25; // If it is a tie vs. a slur, draw it shallower.\n\n  var curve = (above ? -1 : 1) * Math.min(maxFlatten, Math.max(4, flatten));\n  var controlx1 = x1 + flatten * ux - curve * uy;\n  var controly1 = y1 + flatten * uy + curve * ux;\n  var controlx2 = x2 - flatten * ux - curve * uy;\n  var controly2 = y2 - flatten * uy + curve * ux;\n  var thickness = 2;\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", x1, y1, controlx1, controly1, controlx2, controly2, x2, y2, controlx2 - thickness * uy, controly2 + thickness * ux, controlx1 - thickness * uy, controly1 + thickness * ux, x1, y1);\n  if (klass) klass += ' slur';else klass = 'slur';\n  var ret = this.paper.path({\n    path: pathString,\n    stroke: \"none\",\n    fill: \"#000000\",\n    'class': this.addClasses(klass)\n  });\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * Calculates the y for a given pitch value (relative to the stave the renderer is currently printing)\n * @param {number} ofs pitch value (bottom C on a G clef = 0, D=1, etc.)\n */\n\n\nRenderer.prototype.calcY = function (ofs) {\n  return this.y - ofs * spacing.STEP;\n};\n/**\n * Print @param {number} numLines. If there is 1 line it is the B line. Otherwise the bottom line is the E line.\n */\n\n\nRenderer.prototype.printStave = function (startx, endx, numLines) {\n  var klass = \"top-line\";\n  this.paper.openGroup({\n    prepend: true\n  }); // If there is one line, it is the B line. Otherwise, the bottom line is the E line.\n\n  if (numLines === 1) {\n    this.printStaveLine(startx, endx, 6, klass);\n    return;\n  }\n\n  for (var i = numLines - 1; i >= 0; i--) {\n    this.printStaveLine(startx, endx, (i + 1) * 2, klass);\n    klass = undefined;\n  }\n\n  this.paper.closeGroup();\n};\n/**\n *\n * @private\n */\n\n\nRenderer.prototype.addClasses = function (c, isNote) {\n  if (!this.shouldAddClasses) return \"\";\n  var ret = [];\n  if (c.length > 0) ret.push(c);\n  if (this.lineNumber !== null && this.lineNumber !== undefined) ret.push(\"l\" + this.lineNumber);\n  if (this.measureNumber !== null && this.measureNumber !== undefined) ret.push(\"m\" + this.measureNumber);\n  if (this.voiceNumber !== null && this.voiceNumber !== undefined) ret.push(\"v\" + this.voiceNumber);\n  if ((c.indexOf('note') >= 0 || c.indexOf('rest') >= 0 || c.indexOf('lyric') >= 0) && this.noteNumber !== null && this.noteNumber !== undefined) ret.push(\"n\" + this.noteNumber); // add a prefix to all classes that abcjs adds.\n\n  if (ret.length > 0) {\n    ret = ret.join(' '); // Some strings are compound classes - that is, specify more than one class in a string.\n\n    ret = ret.split(' ');\n\n    for (var i = 0; i < ret.length; i++) {\n      if (ret[i].indexOf('abcjs-') !== 0 && ret[i].length > 0) // if the prefix doesn't already exist and the class is not blank.\n        ret[i] = 'abcjs-' + ret[i];\n    }\n  }\n\n  return ret.join(' ');\n};\n\nRenderer.prototype.getFontAndAttr = function (type, klass) {\n  var font;\n\n  if (typeof type === 'string') {\n    font = this.abctune.formatting[type]; // Raphael deliberately changes the font units to pixels for some reason, so we need to change points to pixels here.\n\n    if (font) font = {\n      face: font.face,\n      size: font.size * 4 / 3,\n      decoration: font.decoration,\n      style: font.style,\n      weight: font.weight,\n      box: font.box\n    };else font = {\n      face: \"Arial\",\n      size: 12 * 4 / 3,\n      decoration: \"underline\",\n      style: \"normal\",\n      weight: \"normal\"\n    };\n  } else font = {\n    face: type.face,\n    size: type.size * 4 / 3,\n    decoration: type.decoration,\n    style: type.style,\n    weight: type.weight,\n    box: type.box\n  };\n\n  var attr = {\n    \"font-size\": font.size,\n    'font-style': font.style,\n    \"font-family\": font.face,\n    'font-weight': font.weight,\n    'text-decoration': font.decoration,\n    'class': this.addClasses(klass)\n  };\n  attr.font = \"\"; // There is a spurious font definition that is put on all text elements. This overwrites it.\n\n  return {\n    font: font,\n    attr: attr\n  };\n};\n\nRenderer.prototype.getTextSize = function (text, type, klass, el) {\n  var hash = this.getFontAndAttr(type, klass);\n  var size = this.paper.getTextSize(text, hash.attr, el);\n\n  if (hash.font.box) {\n    size.height += 8;\n    size.width += 8;\n  }\n\n  return size;\n};\n\nRenderer.prototype.renderText = function (x, y, text, type, klass, anchor, centerVertically) {\n  var hash = this.getFontAndAttr(type, klass);\n  if (anchor) hash.attr[\"text-anchor\"] = anchor;\n  hash.attr.x = x;\n  hash.attr.y = y + 7; // TODO-PER: Not sure why the text appears to be 7 pixels off.\n\n  if (!centerVertically) hash.attr.dy = \"0.5em\";\n\n  if (type === 'debugfont') {\n    console.log(\"Debug msg: \" + text);\n    hash.attr.stroke = \"#ff0000\";\n  }\n\n  text = text.replace(/\\n\\n/g, \"\\n \\n\");\n  text = text.replace(/^\\n/, \"\\xA0\\n\");\n\n  if (hash.font.box) {\n    hash.attr.x += 2;\n    hash.attr.y += 4;\n  }\n\n  var el = this.paper.text(text, hash.attr);\n\n  if (hash.font.box) {\n    var size = this.getTextSize(text, type, klass);\n    var padding = 2;\n    var margin = 2;\n    this.paper.rect({\n      x: x - padding,\n      y: y,\n      width: size.width + padding * 2,\n      height: size.height + padding * 2 - margin,\n      stroke: \"#888888\",\n      fill: \"transparent\"\n    }); //size.height += 8;\n  }\n\n  if (this.doRegression) this.addToRegression(el);\n  return el;\n};\n\nRenderer.prototype.moveY = function (em, numLines) {\n  if (numLines === undefined) numLines = 1;\n  this.y += em * numLines;\n};\n\nRenderer.prototype.skipSpaceY = function () {\n  this.y += this.space;\n}; // Call with 'kind' being the font type to use,\n// if marginBottom === null then don't increment the Y after printing, otherwise that is the extra number of em's to leave below the line.\n// and alignment being \"start\", \"middle\", or \"end\".\n\n\nRenderer.prototype.outputTextIf = function (x, str, kind, klass, marginTop, marginBottom, alignment) {\n  if (str) {\n    if (marginTop) this.moveY(marginTop);\n    var el = this.renderText(x, this.y, str, kind, klass, alignment);\n    var bb = this.getTextSize(str, kind, klass);\n    var width = isNaN(bb.width) ? 0 : bb.width;\n    var height = isNaN(bb.height) ? 0 : bb.height;\n    var hash = this.getFontAndAttr(kind, klass);\n\n    if (hash.font.box) {\n      width += 8;\n      height += 8;\n    }\n\n    if (marginBottom !== null) {\n      var numLines = str.split(\"\\n\").length;\n      if (!isNaN(bb.height)) this.moveY(height / numLines, numLines + marginBottom);\n    }\n\n    return [width, height];\n  }\n\n  return [0, 0];\n};\n\nRenderer.prototype.addInvisibleMarker = function (className) {\n  var dy = 0.35;\n  var fill = \"rgba(0,0,0,0)\";\n  var y = this.y;\n  y = Math.round(y);\n  var x1 = 0;\n  var x2 = 100;\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x1 + x2, y - dy, x2, y + dy, x1, y + dy);\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    \"fill-opacity\": 0,\n    'class': this.addClasses(className),\n    'data-vertical': y\n  });\n};\n\nRenderer.prototype.printSeparator = function (width) {\n  var fill = \"rgba(0,0,0,255)\";\n  var stroke = \"rgba(0,0,0,0)\";\n  var y = Math.round(this.y);\n  var staffWidth = this.controller.width;\n  var x1 = (staffWidth - width) / 2;\n  var x2 = x1 + width;\n  var pathString = 'M ' + x1 + ' ' + y + ' L ' + x2 + ' ' + y + ' L ' + x2 + ' ' + (y + 1) + ' L ' + x1 + ' ' + (y + 1) + ' L ' + x1 + ' ' + y + ' z';\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: stroke,\n    fill: fill,\n    'class': this.addClasses('defined-text')\n  });\n}; // For debugging, it is sometimes useful to know where you are vertically.\n\n\nRenderer.prototype.printHorizontalLine = function (width, vertical, comment) {\n  var dy = 0.35;\n  var fill = \"rgba(0,0,255,.4)\";\n  var y = this.y;\n  if (vertical) y = vertical;\n  y = Math.round(y);\n  this.paper.text(\"\" + Math.round(y), {\n    x: 10,\n    y: y,\n    \"text-anchor\": \"start\",\n    \"font-size\": \"18px\",\n    fill: fill,\n    stroke: fill\n  });\n  var x1 = 50;\n  var x2 = width;\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x1 + x2, y - dy, x2, y + dy, x1, y + dy);\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  });\n\n  for (var i = 1; i < width / 100; i++) {\n    pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", i * 100 - dy, y - 5, i * 100 - dy, y + 5, i * 100 + dy, y - 5, i * 100 + dy, y + 5);\n    this.paper.pathToBack({\n      path: pathString,\n      stroke: \"none\",\n      fill: fill,\n      'class': this.addClasses('staff')\n    });\n  }\n\n  if (comment) this.paper.text(comment, {\n    x: width + 70,\n    y: y,\n    \"text-anchor\": \"start\",\n    \"font-size\": \"18px\",\n    fill: fill,\n    stroke: fill\n  });\n};\n\nRenderer.prototype.printShadedBox = function (x, y, width, height, color, opacity, comment) {\n  var box = this.paper.rect({\n    x: x,\n    y: y,\n    width: width,\n    height: height,\n    fill: color,\n    stroke: color,\n    \"fill-opacity\": opacity,\n    \"stroke-opacity\": opacity\n  });\n  if (comment) this.paper.text(comment, {\n    x: 0,\n    y: y + 7,\n    \"text-anchor\": \"start\",\n    \"font-size\": \"14px\",\n    fill: \"rgba(0,0,255,.4)\",\n    stroke: \"rgba(0,0,255,.4)\"\n  });\n  return box;\n};\n\nRenderer.prototype.printVerticalLine = function (x, y1, y2) {\n  var dy = 0.35;\n  var fill = \"#00aaaa\";\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - dy, y1, x - dy, y2, x + dy, y1, x + dy, y2);\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  });\n  pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - 20, y1, x - 20, y1 + 3, x, y1, x, y1 + 3);\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  });\n  pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x + 20, y2, x + 20, y2 + 3, x, y2, x, y2 + 3);\n  this.paper.pathToBack({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  });\n};\n/**\n * @private\n */\n\n\nRenderer.prototype.addToRegression = function (el) {\n  var box;\n\n  try {\n    box = el.getBBox();\n  } catch (e) {\n    box = {\n      width: 0,\n      height: 0\n    };\n  } //var str = \"(\"+box.x+\",\"+box.y+\")[\"+box.width+\",\"+box.height+\"] \"\n\n\n  var str = el.type + ' ' + box.toString() + ' ';\n  var attrs = [];\n\n  for (var key in el.attrs) {\n    if (el.attrs.hasOwnProperty(key)) {\n      if (key === 'class') str = el.attrs[key] + \" \" + str;else attrs.push(key + \": \" + el.attrs[key]);\n    }\n  }\n\n  attrs.sort();\n  str += \"{ \" + attrs.join(\" \") + \" }\";\n  this.regressionLines.push(str);\n};\n\nmodule.exports = Renderer;","map":{"version":3,"sources":["/home/elad/Desktop/Repos/drums-trainer/frontend/node_modules/react-sheet-music/node_modules/abcjs/src/write/abc_renderer.js"],"names":["glyphs","require","spacing","sprintf","Svg","Renderer","paper","doRegression","shouldAddClasses","controller","space","SPACE","padding","regressionLines","reset","prototype","clear","y","abctune","lastM","ingroup","path","isPrint","initVerticalSpace","newTune","abcTune","setVerticalSpace","formatting","measureNumber","noteNumber","setPrintMode","media","setPadding","createElemSet","openGroup","closeElemSet","closeGroup","setPaperSize","maxwidth","scale","responsive","w","right","h","bottom","Math","max","push","text","metaText","title","setTitle","parentStyles","overflow","setResponsiveWidth","width","height","setSize","setScale","setParentStyles","setPaddingOverride","params","paddingOverride","top","paddingtop","paddingbottom","paddingright","left","paddingleft","setPaddingVariable","self","paddingKey","formattingKey","printDefault","screenDefault","undefined","adjustNonScaledItems","headerfont","size","footerfont","composer","graceBefore","graceInside","graceAfter","info","lineSkipFactor","music","paragraphSkipFactor","parts","slurHeight","staffSeparation","stemHeight","subtitle","systemStaffSeparation","vocal","words","staffsep","composerspace","partsspace","textspace","musicspace","titlespace","sysstaffsep","subtitlespace","topspace","vocalspace","wordsspace","topMargin","moveY","addMusicPadding","addStaffPadding","lastStaffGroup","thisStaffGroup","lastStaff","staffs","length","lastBottomLine","nextTopLine","naturalSeparation","separationInPixels","STEP","engraveTopText","header","headerTextHeight","getTextSize","outputTextIf","center","lines","rhythm","origin","rSpace","composerLine","author","partOrder","engraveExtraText","lineNumber","voiceNumber","unalignedWords","hash","getFontAndAttr","j","font","INDENT","largestY","offsetX","k","thisWord","type","el","renderText","extraText","book","source","discography","notes","transcription","history","footer","outputFreeText","vskip","attr","str","isCentered","i","alignment","x","outputSeparator","separator","lineLength","spaceAbove","printSeparator","spaceBelow","outputSubtitle","beginGroup","addPath","ii","endGroup","klass","join","ret","stroke","fill","addClasses","addToRegression","printStaveLine","x1","x2","pitch","extraClass","isIE","dy","calcY","pathString","pathToBack","printStem","dx","y1","y2","tmp","pathArray","kernSymbols","lastSymbol","thisSymbol","lastSymbolWidth","printSymbol","offset","symbol","scalex","scaley","ycorr","indexOf","s","charAt","getYCorr","getSymbolWidth","getPathForSymbol","scaleExistingElem","elem","scaleX","scaleY","setAttributeOnElement","style","printPath","attrs","drawBrace","xLeft","yTop","yBottom","yHeight","xCurve","yCurve","ret1","ret2","drawArc","pitch1","pitch2","above","isTie","norm","sqrt","ux","uy","flatten","maxFlatten","curve","min","controlx1","controly1","controlx2","controly2","thickness","ofs","printStave","startx","endx","numLines","prepend","c","isNote","split","face","decoration","weight","box","anchor","centerVertically","console","log","replace","margin","rect","em","skipSpaceY","kind","marginTop","marginBottom","bb","isNaN","addInvisibleMarker","className","round","staffWidth","printHorizontalLine","vertical","comment","printShadedBox","color","opacity","printVerticalLine","getBBox","e","toString","key","hasOwnProperty","sort","module","exports"],"mappings":"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","sourcesContent":["//    abc_renderer.js: API to render to SVG/Raphael/whatever rendering engine\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n/*global Math, console */\n\nvar glyphs = require('./abc_glyphs');\nvar spacing = require('./abc_spacing');\nvar sprintf = require('./sprintf');\nvar Svg = require('./svg');\n\n/**\n * Implements the API for rendering ABCJS Abstract Rendering Structure to a canvas/paper (e.g. SVG, Raphael, etc)\n * @param {Object} paper\n * @param {bool} doRegression\n */\nvar Renderer = function(paper, doRegression, shouldAddClasses) {\n  this.paper = new Svg(paper);\n  this.controller = null; //TODO-GD only used when drawing the ABCJS ARS to connect the controller with the elements for highlighting\n\n\tthis.space = 3*spacing.SPACE;\n  this.padding = {}; // renderer's padding is managed by the controller\n  this.doRegression = doRegression;\n  this.shouldAddClasses = shouldAddClasses;\n  if (this.doRegression)\n    this.regressionLines = [];\n\tthis.reset();\n};\n\nRenderer.prototype.reset = function() {\n\n\tthis.paper.clear();\n\tthis.y = 0;\n\tthis.abctune = null;\n\tthis.lastM = null;\n\tthis.ingroup = false;\n\tthis.path = null;\n\tthis.isPrint = false;\n\tthis.initVerticalSpace();\n\tif (this.doRegression)\n\t\tthis.regressionLines = [];\n\t// HACK-PER: There was a problem in Raphael where every path string that was sent to it was cached.\n\t// That was causing the browser's memory to steadily grow until the browser went slower and slower until\n\t// it crashed. The fix to that was a patch to Raphael, so it is only patched on the versions of this library that\n\t// bundle Raphael with it. Also, if Raphael gets an update, then that patch will be lost. On version 2.1.2 of Raphael,\n\t// the patch is on line 1542 and 1545 and it is:\n\t//             p[ps].sleep = 1;\n};\n\nRenderer.prototype.newTune = function(abcTune) {\n\tthis.abctune = abcTune; // TODO-PER: this is just to get the font info.\n\tthis.setVerticalSpace(abcTune.formatting);\n\tthis.measureNumber = null;\n\tthis.noteNumber = null;\n\tthis.setPrintMode(abcTune.media === 'print');\n\tthis.setPadding(abcTune);\n};\n\nRenderer.prototype.createElemSet = function() {\n\treturn this.paper.openGroup();\n};\n\nRenderer.prototype.closeElemSet = function() {\n\treturn this.paper.closeGroup();\n};\n\n/**\n * Set whether we are formatting this for the screen, or as a preview for creating a PDF version.\n * @param {bool} isPrint\n */\nRenderer.prototype.setPrintMode = function (isPrint) {\n\tthis.isPrint = isPrint;\n};\n\n/**\n * Set the size of the canvas.\n * @param {object} maxwidth\n * @param {object} scale\n */\nRenderer.prototype.setPaperSize = function (maxwidth, scale, responsive) {\n\tvar w = (maxwidth+this.padding.right)*scale;\n\tvar h = (this.y+this.padding.bottom)*scale;\n\tif (this.isPrint)\n\t\th = Math.max(h, 1056); // 11in x 72pt/in x 1.33px/pt\n\t// TODO-PER: We are letting the page get as long as it needs now, but eventually that should go to a second page.\n\tif (this.doRegression)\n\t\tthis.regressionLines.push(\"PAPER SIZE: (\"+w+\",\"+h+\")\");\n\n\t// for accessibility\n\tvar text = \"Sheet Music\";\n\tif (this.abctune && this.abctune.metaText && this.abctune.metaText.title)\n\t\ttext += \" for \\\"\" + this.abctune.metaText.title + '\"';\n\tthis.paper.setTitle(text);\n\n\tvar parentStyles = { overflow: \"hidden\" };\n\tif (responsive === 'resize') {\n\t\tthis.paper.setResponsiveWidth(w, h);\n\t} else {\n\t\tparentStyles.width = \"\";\n\t\tparentStyles.height = h + \"px\";\n\t\tif (scale < 1) {\n\t\t\tparentStyles.width = w + \"px\";\n\t\t\tthis.paper.setSize(w / scale, h / scale);\n\t\t} else\n\t\t\tthis.paper.setSize(w, h);\n\t}\n\tthis.paper.setScale(scale);\n\tthis.paper.setParentStyles(parentStyles);\n};\n\n/**\n * Set the padding\n * @param {object} params\n */\nRenderer.prototype.setPaddingOverride = function(params) {\n\tthis.paddingOverride = { top: params.paddingtop, bottom: params.paddingbottom,\n\t\tright: params.paddingright, left: params.paddingleft };\n};\n\n/**\n * Set the padding\n * @param {object} params\n */\nRenderer.prototype.setPadding = function(abctune) {\n\t// If the padding is set in the tune, then use that.\n\t// Otherwise, if the padding is set in the override, use that.\n\t// Otherwise, use the defaults (there are a different set of defaults for screen and print.)\n\tfunction setPaddingVariable(self, paddingKey, formattingKey, printDefault, screenDefault) {\n\t\tif (abctune.formatting[formattingKey] !== undefined)\n\t\t\tself.padding[paddingKey] = abctune.formatting[formattingKey];\n\t\telse if (self.paddingOverride[paddingKey] !== undefined)\n\t\t\tself.padding[paddingKey] = self.paddingOverride[paddingKey];\n\t\telse if (self.isPrint)\n\t\t\tself.padding[paddingKey] = printDefault;\n\t\telse\n\t\t\tself.padding[paddingKey] = screenDefault;\n\t}\n\t// 1cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 38px\n\t// 1.8cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 68px\n\tsetPaddingVariable(this, 'top', 'topmargin', 38, 15);\n\tsetPaddingVariable(this, 'bottom', 'botmargin', 38, 15);\n\tsetPaddingVariable(this, 'left', 'leftmargin', 68, 15);\n\tsetPaddingVariable(this, 'right', 'rightmargin', 68, 15);\n};\n\n/**\n * Some of the items on the page are not scaled, so adjust them in the opposite direction of scaling to cancel out the scaling.\n * @param {float} scale\n */\nRenderer.prototype.adjustNonScaledItems = function (scale) {\n\tthis.padding.top /= scale;\n\tthis.padding.bottom /= scale;\n\tthis.padding.left /= scale;\n\tthis.padding.right /= scale;\n\tthis.abctune.formatting.headerfont.size /= scale;\n\tthis.abctune.formatting.footerfont.size /= scale;\n};\n\n/**\n * Set the the values for all the configurable vertical space options.\n */\nRenderer.prototype.initVerticalSpace = function() {\n\t// conversion: 37.7953 = conversion factor for cm to px.\n\t// All of the following values are in px.\n\tthis.spacing = {\n\t\tcomposer: 7.56, // Set the vertical space above the composer.\n\t\tgraceBefore: 8.67, // Define the space before, inside and after the grace notes.\n\t\tgraceInside: 10.67,\n\t\tgraceAfter: 16,\n\t\tinfo: 0, // Set the vertical space above the infoline.\n\t\tlineSkipFactor: 1.1, // Set the factor for spacing between lines of text. (multiply this by the font size)\n\t\tmusic: 7.56, // Set the vertical space above the first staff.\n\t\tparagraphSkipFactor: 0.4, // Set the factor for spacing between text paragraphs. (multiply this by the font size)\n\t\tparts: 11.33, // Set the vertical space above a new part.\n\t\tslurHeight: 1.0, // Set the slur height factor.\n\t\tstaffSeparation: 61.33, // Do not put a staff system closer than <unit> from the previous system.\n\t\tstemHeight: 26.67+10, // Set the stem height.\n\t\tsubtitle: 3.78, // Set the vertical space above the subtitle.\n\t\tsystemStaffSeparation: 48, // Do not place the staves closer than <unit> inside a system. * This values applies to all staves when in the tune header. Otherwise, it applies to the next staff\n\t\ttext: 18.9, // Set the vertical space above the history.\n\t\ttitle: 7.56, // Set the vertical space above the title.\n\t\ttop: 30.24, //Set the vertical space above the tunes and on the top of the continuation pages.\n\t\tvocal: 30.67, // Set the vertical space above the lyrics under the staves.\n\t\twords: 0 // Set the vertical space above the lyrics at the end of the tune.\n\t};\n\t/*\n\tTODO-PER: Handle the x-coordinate spacing items, too.\nmaxshrink <float>Default: 0.65\nSet how much to compress horizontally when music line breaks\nare automatic.\n<float> must be between 0 (natural spacing)\nand 1 (max shrinking).\n\n// This next value is used to compute the natural spacing of\n// the notes. The base spacing of the crotchet is always\n// 40 pts. When the duration of a note type is twice the\n// duration of an other note type, its spacing is multiplied\n// by this factor.\n// The default value causes the note spacing to be multiplied\n// by 2 when its duration is multiplied by 4, i.e. the\n// space of the semibreve is 80 pts and the space of the\n// semiquaver is 20 pts.\n// Setting this value to 1 sets all note spacing to 40 pts.\nnoteSpacingFactor: 1.414, // Set the note spacing factor to <float> (range 1..2).\n\nscale <float> Default: 0.75 Set the page scale factor. Note that the header and footer are not scaled.\n\nstretchlast <float>Default: 0.8\nStretch the last music line of a tune when it exceeds\nthe <float> fraction of the page width.\n<float> range is 0.0 to 1.0.\n\t */\n};\n\nRenderer.prototype.setVerticalSpace = function(formatting) {\n\t// conversion from pts to px 4/3\n\tif (formatting.staffsep !== undefined)\n\t\tthis.spacing.staffSeparation = formatting.staffsep *4/3;\n\tif (formatting.composerspace !== undefined)\n\t\tthis.spacing.composer = formatting.composerspace *4/3;\n\tif (formatting.partsspace !== undefined)\n\t\tthis.spacing.parts = formatting.partsspace *4/3;\n\tif (formatting.textspace !== undefined)\n\t\tthis.spacing.text = formatting.textspace *4/3;\n\tif (formatting.musicspace !== undefined)\n\t\tthis.spacing.music = formatting.musicspace *4/3;\n\tif (formatting.titlespace !== undefined)\n\t\tthis.spacing.title = formatting.titlespace *4/3;\n\tif (formatting.sysstaffsep !== undefined)\n\t\tthis.spacing.systemStaffSeparation = formatting.sysstaffsep *4/3;\n\tif (formatting.subtitlespace !== undefined)\n\t\tthis.spacing.subtitle = formatting.subtitlespace *4/3;\n\tif (formatting.topspace !== undefined)\n\t\tthis.spacing.top = formatting.topspace *4/3;\n\tif (formatting.vocalspace !== undefined)\n\t\tthis.spacing.vocal = formatting.vocalspace *4/3;\n\tif (formatting.wordsspace !== undefined)\n\t\tthis.spacing.words = formatting.wordsspace *4/3;\n};\n\n/**\n * Leave space at the top of the paper\n * @param {object} abctune\n */\nRenderer.prototype.topMargin = function(abctune) {\n\t\tthis.moveY(this.padding.top);\n};\n\n/**\n * Leave space before printing the music\n */\nRenderer.prototype.addMusicPadding = function() {\n\t\tthis.moveY(this.spacing.music);\n};\n\n/**\n * Leave space before printing a staff system\n */\nRenderer.prototype.addStaffPadding = function(lastStaffGroup, thisStaffGroup) {\n\tvar lastStaff = lastStaffGroup.staffs[lastStaffGroup.staffs.length-1];\n\tvar lastBottomLine = -(lastStaff.bottom - 2); // The 2 is because the scale goes to 2 below the last line.\n\tvar nextTopLine = thisStaffGroup.staffs[0].top - 10; // Because 10 represents the top line.\n\tvar naturalSeparation = nextTopLine + lastBottomLine; // This is how far apart they'd be without extra spacing\n\tvar separationInPixels = naturalSeparation * spacing.STEP;\n\tif (separationInPixels < this.spacing.staffSeparation)\n\t\tthis.moveY(this.spacing.staffSeparation-separationInPixels);\n};\n\n/**\n * Text that goes above the score\n * @param {number} width\n * @param {object} abctune\n */\nRenderer.prototype.engraveTopText = function(width, abctune) {\n\tif (abctune.metaText.header && this.isPrint) {\n\t\t// Note: whether there is a header or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n\t\t// This text goes above the margin, so we'll temporarily move up.\n\t\tvar headerTextHeight = this.getTextSize(\"XXXX\", \"headerfont\", 'abcjs-header abcjs-meta-top').height;\n\t\tthis.y -=headerTextHeight;\n\t\tthis.outputTextIf(this.padding.left, abctune.metaText.header.left, 'headerfont', 'header meta-top', 0, null, 'start');\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.header.center, 'headerfont', 'header meta-top', 0, null, 'middle');\n\t\tthis.outputTextIf(this.padding.left + width, abctune.metaText.header.right, 'headerfont', 'header meta-top', 0, null, 'end');\n\t\tthis.y += headerTextHeight;\n\t}\n\tif (this.isPrint)\n\t\tthis.moveY(this.spacing.top);\n\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.title, 'titlefont', 'title meta-top', this.spacing.title, 0, 'middle');\n\tif (abctune.lines[0])\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.lines[0].subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n\n\tif (abctune.metaText.rhythm || abctune.metaText.origin || abctune.metaText.composer) {\n\t\tthis.moveY(this.spacing.composer);\n\t\tvar rSpace = this.outputTextIf(this.padding.left, abctune.metaText.rhythm, 'infofont', 'meta-top', 0, null, \"start\");\n\n\t\tvar composerLine = \"\";\n\t\tif (abctune.metaText.composer) composerLine += abctune.metaText.composer;\n\t\tif (abctune.metaText.origin) composerLine += ' (' + abctune.metaText.origin + ')';\n\t\tif (composerLine.length > 0) {\n\t\t\tvar space = this.outputTextIf(this.padding.left + width, composerLine, 'composerfont', 'meta-top', 0, null, \"end\");\n\t\t\tthis.moveY(space[1]);\n\t\t} else {\n\t\t\tthis.moveY(rSpace[1]);\n\t\t}\n\t\t// TODO-PER: The following is a hack to make the elements line up with abcm2ps. Don't know where the extra space is coming from.\n\t\tthis.moveY(-6);\n\t//} else if (this.isPrint) {\n\t//\t// abcm2ps adds this space whether there is anything to write or not.\n\t//\tthis.moveY(this.spacing.composer);\n\t//\tvar space2 = this.getTextSize(\"M\", 'composerfont', 'meta-top');\n\t//\tthis.moveY(space2.height);\n\t}\n\n\tthis.outputTextIf(this.padding.left + width, abctune.metaText.author, 'composerfont', 'meta-top', 0, 0, \"end\");\n\t//this.skipSpaceY();\n\n\tthis.outputTextIf(this.padding.left, abctune.metaText.partOrder, 'partsfont', 'meta-bottom', 0, 0, \"start\");\n};\n\n/**\n * Text that goes below the score\n * @param {number} width\n * @param {object} abctune\n */\nRenderer.prototype.engraveExtraText = function(width, abctune) {\n\tthis.lineNumber = null;\n\tthis.measureNumber = null;\n\tthis.noteNumber = null;\n\tthis.voiceNumber = null;\n\n\tif (abctune.metaText.unalignedWords) {\n\t\tvar hash = this.getFontAndAttr(\"wordsfont\", 'meta-bottom');\n\t\tvar space = this.getTextSize(\"i\", 'wordsfont', 'meta-bottom');\n\n\t\tif (abctune.metaText.unalignedWords.length > 0)\n\t\t\tthis.moveY(this.spacing.words, 1);\n\t\tfor (var j = 0; j < abctune.metaText.unalignedWords.length; j++) {\n\t\t\tif (abctune.metaText.unalignedWords[j] === '')\n\t\t\t\tthis.moveY(hash.font.size, 1);\n\t\t\telse if (typeof abctune.metaText.unalignedWords[j] === 'string') {\n\t\t\t\tthis.outputTextIf(this.padding.left + spacing.INDENT, abctune.metaText.unalignedWords[j], 'wordsfont', 'meta-bottom', 0, 0, \"start\");\n\t\t\t} else {\n\t\t\t\tvar largestY = 0;\n\t\t\t\tvar offsetX = 0;\n\t\t\t\tfor (var k = 0; k < abctune.metaText.unalignedWords[j].length; k++) {\n\t\t\t\t\tvar thisWord = abctune.metaText.unalignedWords[j][k];\n\t\t\t\t\tvar type = (thisWord.font) ? thisWord.font : \"wordsfont\";\n\t\t\t\t\tvar el = this.renderText(this.padding.left + spacing.INDENT + offsetX, this.y, thisWord.text, type, 'meta-bottom', false);\n\t\t\t\t\tvar size = this.getTextSize(thisWord.text, type, 'meta-bottom');\n\t\t\t\t\tlargestY = Math.max(largestY, size.height);\n\t\t\t\t\toffsetX += size.width;\n\t\t\t\t\t// If the phrase ends in a space, then that is not counted in the width, so we need to add that in ourselves.\n\t\t\t\t\tif (thisWord.text[thisWord.text.length-1] === ' ') {\n\t\t\t\t\t\toffsetX += space.width;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.moveY(largestY, 1);\n\t\t\t}\n\t\t}\n\t\tif (abctune.metaText.unalignedWords.length > 0)\n\t\t\tthis.moveY(hash.font.size, 2);\n\t}\n\n\tvar extraText = \"\";\n\tif (abctune.metaText.book) extraText += \"Book: \" + abctune.metaText.book + \"\\n\";\n\tif (abctune.metaText.source) extraText += \"Source: \" + abctune.metaText.source + \"\\n\";\n\tif (abctune.metaText.discography) extraText += \"Discography: \" + abctune.metaText.discography + \"\\n\";\n\tif (abctune.metaText.notes) extraText += \"Notes: \" + abctune.metaText.notes + \"\\n\";\n\tif (abctune.metaText.transcription) extraText += \"Transcription: \" + abctune.metaText.transcription + \"\\n\";\n\tif (abctune.metaText.history) extraText += \"History: \" + abctune.metaText.history + \"\\n\";\n\tif (abctune.metaText['abc-copyright']) extraText += \"Copyright: \" + abctune.metaText['abc-copyright'] + \"\\n\";\n\tif (abctune.metaText['abc-creator']) extraText += \"Creator: \" + abctune.metaText['abc-creator'] + \"\\n\";\n\tif (abctune.metaText['abc-edited-by']) extraText += \"Edited By: \" + abctune.metaText['abc-edited-by'] + \"\\n\";\n\tthis.outputTextIf(this.padding.left, extraText, 'historyfont', 'meta-bottom', this.spacing.info, 0, \"start\");\n\n\tif (abctune.metaText.footer && this.isPrint) {\n\t\t// Note: whether there is a footer or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n\t\tthis.outputTextIf(this.padding.left, abctune.metaText.footer.left, 'footerfont', 'header meta-bottom', 0, null, 'start');\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.footer.center, 'footerfont', 'header meta-bottom', 0, null, 'middle');\n\t\tthis.outputTextIf(this.padding.left + width, abctune.metaText.footer.right, 'footerfont', 'header meta-bottom', 0, null, 'end');\n\t}\n};\n\n/**\n * Output text defined with %%text.\n * @param {array or string} text\n */\nRenderer.prototype.outputFreeText = function (text, vskip) {\n\tif (vskip)\n\t\tthis.moveY(vskip);\n\tvar hash = this.getFontAndAttr('textfont', 'defined-text');\n\tif (text === \"\") {\t// we do want to print out blank lines if they have been specified.\n\t\tthis.moveY(hash.attr['font-size'] * 2); // move the distance of the line, plus the distance of the margin, which is also one line.\n\t} else if (typeof text === 'string') {\n\t\tthis.moveY(hash.attr['font-size']/2); // TODO-PER: move down some - the y location should be the top of the text, but we output text specifying the center line.\n\t\tthis.outputTextIf(this.padding.left, text, 'textfont', 'defined-text', 0, 0, \"start\");\n\t} else {\n\t\tvar str = \"\";\n\t\tvar isCentered = false; // The structure is wrong here: it requires an array to do centering, but it shouldn't have.\n\t\tfor (var i = 0; i < text.length; i++) {\n\t\t\tif (text[i].font)\n\t\t\t\tstr += \"FONT(\" + text[i].font + \")\";\n\t\t\tstr += text[i].text;\n\t\t\tif (text[i].center)\n\t\t\t\tisCentered = true;\n\t\t}\n\t\tvar alignment = isCentered ? 'middle' : 'start';\n\t\tvar x = isCentered ? this.controller.width / 2 : this.padding.left;\n\t\tthis.outputTextIf(x, str, 'textfont', 'defined-text', 0, 1, alignment);\n\t}\n};\n\nRenderer.prototype.outputSeparator = function (separator) {\n\tif (!separator.lineLength)\n\t\treturn;\n\tthis.moveY(separator.spaceAbove);\n\tthis.printSeparator(separator.lineLength);\n\tthis.moveY(separator.spaceBelow);\n};\n\n/**\n * Output an extra subtitle that is defined later in the tune.\n */\nRenderer.prototype.outputSubtitle = function (width, subtitle) {\n\tthis.outputTextIf(this.padding.left + width / 2, subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n};\n\n/**\n * Begin a group of glyphs that will always be moved, scaled and highlighted together\n */\nRenderer.prototype.beginGroup = function () {\n  this.path = [];\n  this.lastM = [0,0];\n  this.ingroup = true;\n};\n\n/**\n * Add a path to the current group\n * @param {Array} path\n * @private\n */\nRenderer.prototype.addPath = function (path) {\n  path = path || [];\n  if (path.length===0) return;\n  path[0][0]=\"m\";\n  path[0][1]-=this.lastM[0];\n  path[0][2]-=this.lastM[1];\n  this.lastM[0]+=path[0][1];\n  this.lastM[1]+=path[0][2];\n  this.path.push(path[0]);\n  for (var i=1,ii=path.length;i<ii;i++) {\n    if (path[i][0]===\"m\") {\n      this.lastM[0]+=path[i][1];\n      this.lastM[1]+=path[i][2];\n    }\n    this.path.push(path[i]);\n  }\n};\n\n/**\n * End a group of glyphs that will always be moved, scaled and highlighted together\n */\nRenderer.prototype.endGroup = function (klass) {\n  this.ingroup = false;\n  if (this.path.length===0) return null;\n  var path = \"\";\n\tfor (var i = 0; i < this.path.length; i++)\n\t\tpath += this.path[i].join(\" \");\n\tvar ret = this.paper.path({path: path, stroke:\"none\", fill:\"#000000\", 'class': this.addClasses(klass)});\n\tthis.path = [];\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n\n/**\n * gets scaled\n * @param {number} x1 start x\n * @param {number} x2 end x\n * @param {number} pitch pitch the stave line is drawn at\n */\nRenderer.prototype.printStaveLine = function (x1,x2, pitch, klass) {\n\tvar extraClass = \"staff\";\n\tif (klass !== undefined)\n\t\textraClass += \" \" + klass;\n  var isIE=/*@cc_on!@*/false;//IE detector\n  var dy = 0.35;\n  var fill = \"#000000\";\n  if (isIE) {\n    dy = 1;\n    fill = \"#666666\";\n  }\n  var y = this.calcY(pitch);\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x2, y-dy,\n     x2, y+dy, x1, y+dy);\n  var ret = this.paper.pathToBack({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses(extraClass)});\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n\n/**\n * gets scaled if not in a group\n * @param {number} x x coordinate of the stem\n * @param {number} dx stem width\n * @param {number} y1 y coordinate of the stem bottom\n * @param {number} y2 y coordinate of the stem top\n */\nRenderer.prototype.printStem = function (x, dx, y1, y2) {\n  if (dx<0) { // correct path \"handedness\" for intersection with other elements\n    var tmp = y2;\n    y2 = y1;\n    y1 = tmp;\n  }\n  var isIE=/*@cc_on!@*/false;//IE detector\n  var fill = \"#000000\";\n  if (isIE && dx<1) {\n    dx = 1;\n    fill = \"#666666\";\n  }\n  if (~~x === x) x+=0.05; // raphael does weird rounding (for VML)\n  var pathArray = [[\"M\",x,y1],[\"L\", x, y2],[\"L\", x+dx, y2],[\"L\",x+dx,y1],[\"z\"]];\n  if (!isIE && this.ingroup) {\n    this.addPath(pathArray);\n  } else {\n  \tvar path = \"\";\n  \tfor (var i = 0; i < pathArray.length; i++)\n  \t\tpath += pathArray[i].join(\" \");\n    var ret = this.paper.pathToBack({path:path, stroke:\"none\", fill:fill, 'class': this.addClasses('stem')});\n    if (this.doRegression) this.addToRegression(ret);\n\n    return ret;\n  }\n};\n\nfunction kernSymbols(lastSymbol, thisSymbol, lastSymbolWidth) {\n\t// This is just some adjustments to make it look better.\n\tvar width = lastSymbolWidth;\n\tif (lastSymbol === 'f' && thisSymbol === 'f')\n\t\twidth = width*2/3;\n\tif (lastSymbol === 'p' && thisSymbol === 'p')\n\t\twidth = width*5/6;\n\tif (lastSymbol === 'f' && thisSymbol === 'z')\n\t\twidth = width*5/8;\n\treturn width;\n}\n\n/**\n * assumes this.y is set appropriately\n * if symbol is a multichar string without a . (as in scripts.staccato) 1 symbol per char is assumed\n * not scaled if not in printgroup\n */\nRenderer.prototype.printSymbol = function (x, offset, symbol, scalex, scaley, klass) {\n\tvar el;\n\tvar ycorr;\n\tif (!symbol) return null;\n\tif (symbol.length > 1 && symbol.indexOf(\".\") < 0) {\n\t\tthis.paper.openGroup();\n\t\tvar dx = 0;\n\t\tfor (var i = 0; i < symbol.length; i++) {\n\t\t\tvar s = symbol.charAt(i);\n\t\t\tycorr = glyphs.getYCorr(s);\n\t\t\tel = glyphs.printSymbol(x + dx, this.calcY(offset + ycorr), s, this.paper, klass);\n\t\t\tif (el) {\n\t\t\t\tif (this.doRegression) this.addToRegression(el);\n\t\t\t\t//elemset.push(el);\n\t\t\t\tif (i < symbol.length - 1)\n\t\t\t\t\tdx += kernSymbols(s, symbol.charAt(i + 1), glyphs.getSymbolWidth(s));\n\t\t\t} else {\n\t\t\t\tthis.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n\t\t\t}\n\t\t}\n\t\treturn this.paper.closeGroup();\n\t} else {\n\t\tycorr = glyphs.getYCorr(symbol);\n\t\tif (this.ingroup) {\n\t\t\tthis.addPath(glyphs.getPathForSymbol(x, this.calcY(offset + ycorr), symbol, scalex, scaley));\n\t\t} else {\n\t\t\tel = glyphs.printSymbol(x, this.calcY(offset + ycorr), symbol, this.paper, klass);\n\t\t\tif (el) {\n\t\t\t\tif (this.doRegression) this.addToRegression(el);\n\t\t\t\treturn el;\n\t\t\t} else\n\t\t\t\tthis.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n\t\t}\n\t\treturn null;\n\t}\n};\n\nRenderer.prototype.scaleExistingElem = function (elem, scaleX, scaleY, x, y) {\n\tthis.paper.setAttributeOnElement(elem, { style: \"transform:scale(\"+scaleX+\",\"+scaleY + \");transform-origin:\" + x + \"px \" + y + \"px;\"});\n};\n\nRenderer.prototype.printPath = function (attrs) {\n  var ret = this.paper.path(attrs);\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n\nRenderer.prototype.drawBrace = function(xLeft, yTop, yBottom) {//Tony\n\tvar yHeight = yBottom - yTop;\n\n\tvar xCurve = [7.5, -8, 21, 0, 18.5, -10.5, 7.5];\n\tvar yCurve = [0, yHeight/5.5, yHeight/3.14, yHeight/2, yHeight/2.93, yHeight/4.88, 0];\n\n\tvar pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\",\n\t\txLeft+xCurve[0], yTop+yCurve[0],\n\t\txLeft+xCurve[1], yTop+yCurve[1],\n\t\txLeft+xCurve[2], yTop+yCurve[2],\n\t\txLeft+xCurve[3], yTop+yCurve[3],\n\t\txLeft+xCurve[4], yTop+yCurve[4],\n\t\txLeft+xCurve[5], yTop+yCurve[5],\n\t\txLeft+xCurve[6], yTop+yCurve[6]);\n\tvar ret1 = this.paper.path({path:pathString, stroke:\"#000000\", fill:\"#000000\", 'class': this.addClasses('brace')});\n\n\txCurve = [0, 17.5, -7.5, 6.6, -5, 20, 0];\n\tyCurve = [yHeight/2, yHeight/1.46, yHeight/1.22, yHeight, yHeight/1.19, yHeight/1.42, yHeight/2];\n\n\tpathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\",\n\t\txLeft+xCurve[ 0], yTop+yCurve[0],\n\t\txLeft+xCurve[1], yTop+yCurve[1],\n\t\txLeft+xCurve[2], yTop+yCurve[2],\n\t\txLeft+xCurve[3], yTop+yCurve[3],\n\t\txLeft+xCurve[4], yTop+yCurve[4],\n\t\txLeft+xCurve[5], yTop+yCurve[5],\n\t\txLeft+xCurve[6], yTop+yCurve[6]);\n\tvar ret2 = this.paper.path({path:pathString, stroke:\"#000000\", fill:\"#000000\", 'class': this.addClasses('brace')});\n\n\tif (this.doRegression){\n\t\tthis.addToRegression(ret1);\n\t\tthis.addToRegression(ret2);\n\t}\n\treturn ret1 + ret2;\n};\n\nRenderer.prototype.drawArc = function(x1, x2, pitch1, pitch2, above, klass, isTie) {\n\t// If it is a tie vs. a slur, draw it shallower.\n\tvar spacing = isTie ? 1.2 : 1.5;\n\n  x1 = x1 + 6;\n  x2 = x2 + 4;\n  pitch1 = pitch1 + ((above)?spacing:-spacing);\n  pitch2 = pitch2 + ((above)?spacing:-spacing);\n  var y1 = this.calcY(pitch1);\n  var y2 = this.calcY(pitch2);\n\n  //unit direction vector\n  var dx = x2-x1;\n  var dy = y2-y1;\n  var norm= Math.sqrt(dx*dx+dy*dy);\n  var ux = dx/norm;\n  var uy = dy/norm;\n\n  var flatten = norm/3.5;\n  var maxFlatten = isTie ? 10 : 25;  // If it is a tie vs. a slur, draw it shallower.\n  var curve = ((above)?-1:1)*Math.min(maxFlatten, Math.max(4, flatten));\n\n  var controlx1 = x1+flatten*ux-curve*uy;\n  var controly1 = y1+flatten*uy+curve*ux;\n  var controlx2 = x2-flatten*ux-curve*uy;\n  var controly2 = y2-flatten*uy+curve*ux;\n  var thickness = 2;\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", x1, y1,\n     controlx1, controly1, controlx2, controly2, x2, y2,\n     controlx2-thickness*uy, controly2+thickness*ux, controlx1-thickness*uy, controly1+thickness*ux, x1, y1);\n\tif (klass)\n\t\tklass += ' slur';\n\telse\n\t\tklass = 'slur';\n  var ret = this.paper.path({path:pathString, stroke:\"none\", fill:\"#000000\", 'class': this.addClasses(klass)});\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n/**\n * Calculates the y for a given pitch value (relative to the stave the renderer is currently printing)\n * @param {number} ofs pitch value (bottom C on a G clef = 0, D=1, etc.)\n */\nRenderer.prototype.calcY = function(ofs) {\n  return this.y - ofs*spacing.STEP;\n};\n\n/**\n * Print @param {number} numLines. If there is 1 line it is the B line. Otherwise the bottom line is the E line.\n */\nRenderer.prototype.printStave = function (startx, endx, numLines) {\n\tvar klass = \"top-line\";\n\tthis.paper.openGroup({ prepend: true });\n\t// If there is one line, it is the B line. Otherwise, the bottom line is the E line.\n\tif (numLines === 1) {\n\t\tthis.printStaveLine(startx,endx,6, klass);\n\t\treturn;\n\t}\n\tfor (var i = numLines-1; i >= 0; i--) {\n\t\tthis.printStaveLine(startx,endx,(i+1)*2, klass);\n\t\tklass = undefined;\n\t}\n\tthis.paper.closeGroup();\n};\n\n/**\n *\n * @private\n */\nRenderer.prototype.addClasses = function (c, isNote) {\n\tif (!this.shouldAddClasses)\n\t\treturn \"\";\n\tvar ret = [];\n\tif (c.length > 0) ret.push(c);\n\tif (this.lineNumber !== null && this.lineNumber !== undefined) ret.push(\"l\"+this.lineNumber);\n\tif (this.measureNumber !== null && this.measureNumber !== undefined) ret.push(\"m\"+this.measureNumber);\n\tif (this.voiceNumber !== null && this.voiceNumber !== undefined) ret.push(\"v\"+this.voiceNumber);\n\tif ((c.indexOf('note') >= 0 || c.indexOf('rest') >= 0 || c.indexOf('lyric') >= 0 ) && this.noteNumber !== null && this.noteNumber !== undefined) ret.push(\"n\"+this.noteNumber);\n\t// add a prefix to all classes that abcjs adds.\n\tif (ret.length > 0) {\n\t\tret = ret.join(' '); // Some strings are compound classes - that is, specify more than one class in a string.\n\t\tret = ret.split(' ');\n\t\tfor (var i = 0; i < ret.length; i++) {\n\t\t\tif (ret[i].indexOf('abcjs-') !== 0 && ret[i].length > 0) // if the prefix doesn't already exist and the class is not blank.\n\t\t\t\tret[i] = 'abcjs-' + ret[i];\n\t\t}\n\t}\n\treturn ret.join(' ');\n};\n\nRenderer.prototype.getFontAndAttr = function(type, klass) {\n\tvar font;\n\tif (typeof type === 'string') {\n\t\tfont = this.abctune.formatting[type];\n\t\t// Raphael deliberately changes the font units to pixels for some reason, so we need to change points to pixels here.\n\t\tif (font)\n\t\t\tfont = {face: font.face, size: font.size * 4 / 3, decoration: font.decoration, style: font.style, weight: font.weight, box: font.box};\n\t\telse\n\t\t\tfont = {face: \"Arial\", size: 12 * 4 / 3, decoration: \"underline\", style: \"normal\", weight: \"normal\"};\n\t} else\n\t\tfont = {face: type.face, size: type.size * 4 / 3, decoration: type.decoration, style: type.style, weight: type.weight, box: type.box};\n\n\tvar attr = {\"font-size\": font.size, 'font-style': font.style,\n\t\t\"font-family\": font.face, 'font-weight': font.weight, 'text-decoration': font.decoration,\n\t\t'class': this.addClasses(klass) };\n\tattr.font = \"\";\t// There is a spurious font definition that is put on all text elements. This overwrites it.\n\treturn { font: font, attr: attr };\n};\n\nRenderer.prototype.getTextSize = function(text, type, klass, el) {\n\tvar hash = this.getFontAndAttr(type, klass);\n\tvar size = this.paper.getTextSize(text, hash.attr, el);\n\tif (hash.font.box) {\n\t\tsize.height += 8;\n\t\tsize.width += 8;\n\t}\n\treturn size;\n};\n\nRenderer.prototype.renderText = function(x, y, text, type, klass, anchor, centerVertically) {\n\tvar hash = this.getFontAndAttr(type, klass);\n\tif (anchor)\n\t\thash.attr[\"text-anchor\"] = anchor;\n\thash.attr.x = x;\n\thash.attr.y = y + 7; // TODO-PER: Not sure why the text appears to be 7 pixels off.\n\tif (!centerVertically)\n\t\thash.attr.dy = \"0.5em\";\n\tif (type === 'debugfont') {\n\t\tconsole.log(\"Debug msg: \" + text);\n\t\thash.attr.stroke = \"#ff0000\";\n\t}\n\n\ttext = text.replace(/\\n\\n/g, \"\\n \\n\");\n\ttext = text.replace(/^\\n/, \"\\xA0\\n\");\n\n\tif (hash.font.box) {\n\t\thash.attr.x += 2;\n\t\thash.attr.y += 4;\n\t}\n\tvar el = this.paper.text(text, hash.attr);\n\n\tif (hash.font.box) {\n\t\tvar size = this.getTextSize(text, type, klass);\n\t\tvar padding = 2;\n\t\tvar margin = 2;\n\t\tthis.paper.rect({ x: x - padding, y: y, width: size.width + padding*2, height: size.height + padding*2 - margin,  stroke: \"#888888\", fill: \"transparent\"});\n\t\t//size.height += 8;\n\t}\n\tif (this.doRegression) this.addToRegression(el);\n\treturn el;\n};\n\nRenderer.prototype.moveY = function (em, numLines) {\n\tif (numLines === undefined) numLines = 1;\n\tthis.y += em*numLines;\n};\n\nRenderer.prototype.skipSpaceY = function () {\n\tthis.y += this.space;\n};\n\n// Call with 'kind' being the font type to use,\n// if marginBottom === null then don't increment the Y after printing, otherwise that is the extra number of em's to leave below the line.\n// and alignment being \"start\", \"middle\", or \"end\".\nRenderer.prototype.outputTextIf = function(x, str, kind, klass, marginTop, marginBottom, alignment) {\n\tif (str) {\n\t\tif (marginTop)\n\t\t\tthis.moveY(marginTop);\n\t\tvar el = this.renderText(x, this.y, str, kind, klass, alignment);\n\t\tvar bb = this.getTextSize(str, kind, klass);\n\t\tvar width = isNaN(bb.width) ? 0 : bb.width;\n\t\tvar height = isNaN(bb.height) ? 0 : bb.height;\n\t\tvar hash = this.getFontAndAttr(kind, klass);\n\t\tif (hash.font.box) {\n\t\t\twidth += 8;\n\t\t\theight += 8;\n\t\t}\n\t\tif (marginBottom !== null) {\n\t\t\tvar numLines = str.split(\"\\n\").length;\n\t\t\tif (!isNaN(bb.height))\n\t\t\t\tthis.moveY(height/numLines, (numLines + marginBottom));\n\t\t}\n\t\treturn [width, height];\n\t}\n\treturn [0,0];\n};\n\nRenderer.prototype.addInvisibleMarker = function (className) {\n\tvar dy = 0.35;\n\tvar fill = \"rgba(0,0,0,0)\";\n\tvar y = this.y;\n\ty = Math.round(y);\n\tvar x1 = 0;\n\tvar x2 = 100;\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x1+x2, y-dy,\n\t\tx2, y+dy, x1, y+dy);\n\tthis.paper.pathToBack({path:pathString, stroke:\"none\", fill:fill, \"fill-opacity\": 0, 'class': this.addClasses(className), 'data-vertical': y });\n};\n\nRenderer.prototype.printSeparator = function(width) {\n\tvar fill = \"rgba(0,0,0,255)\";\n\tvar stroke = \"rgba(0,0,0,0)\";\n\tvar y = Math.round(this.y);\n\tvar staffWidth = this.controller.width;\n\tvar x1 = (staffWidth - width)/2;\n\tvar x2 = x1 + width;\n\tvar pathString = 'M ' + x1 + ' ' + y +\n\t\t' L ' + x2 + ' ' + y +\n\t\t' L ' + x2 + ' ' + (y+1) +\n\t\t' L ' + x1 + ' ' + (y+1) +\n\t\t' L ' + x1 + ' ' + y + ' z';\n\tthis.paper.pathToBack({path:pathString, stroke:stroke, fill:fill, 'class': this.addClasses('defined-text')});\n};\n\n// For debugging, it is sometimes useful to know where you are vertically.\nRenderer.prototype.printHorizontalLine = function (width, vertical, comment) {\n\tvar dy = 0.35;\n\tvar fill = \"rgba(0,0,255,.4)\";\n\tvar y = this.y;\n\tif (vertical) y = vertical;\n\ty = Math.round(y);\n\tthis.paper.text(\"\"+Math.round(y), {x: 10, y: y, \"text-anchor\": \"start\", \"font-size\":\"18px\", fill: fill, stroke: fill });\n\tvar x1 = 50;\n\tvar x2 = width;\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x1+x2, y-dy,\n\t\tx2, y+dy, x1, y+dy);\n\tthis.paper.pathToBack({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses('staff')});\n\tfor (var i = 1; i < width/100; i++) {\n\t\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", i*100-dy, y-5, i*100-dy, y+5,\n\t\t\ti*100+dy, y-5, i*100+dy, y+5);\n\t\tthis.paper.pathToBack({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses('staff')});\n\t}\n\tif (comment)\n\t\tthis.paper.text(comment, {x: width+70, y: y, \"text-anchor\": \"start\", \"font-size\":\"18px\", fill: fill, stroke: fill });\n};\n\nRenderer.prototype.printShadedBox = function (x, y, width, height, color, opacity, comment) {\n\tvar box = this.paper.rect({ x: x, y: y, width: width, height: height, fill: color, stroke: color, \"fill-opacity\": opacity, \"stroke-opacity\": opacity });\n\tif (comment)\n\t\tthis.paper.text(comment, {x: 0, y: y+7, \"text-anchor\": \"start\", \"font-size\":\"14px\", fill: \"rgba(0,0,255,.4)\", stroke: \"rgba(0,0,255,.4)\" });\n\treturn box;\n};\n\nRenderer.prototype.printVerticalLine = function (x, y1, y2) {\n\tvar dy = 0.35;\n\tvar fill = \"#00aaaa\";\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - dy, y1, x - dy, y2,\n\t\t\tx + dy, y1, x + dy, y2);\n\tthis.paper.pathToBack({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')});\n\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - 20, y1, x - 20, y1+3,\n\t\tx, y1, x, y1+3);\n\tthis.paper.pathToBack({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')});\n\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x + 20, y2, x + 20, y2+3,\n\t\tx, y2, x, y2+3);\n\tthis.paper.pathToBack({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')});\n\n};\n\n/**\n * @private\n */\nRenderer.prototype.addToRegression = function (el) {\n\tvar box;\n\ttry {\n\t\tbox = el.getBBox();\n\t} catch(e) {\n\t\tbox = { width: 0, height: 0 };\n\t}\n\t//var str = \"(\"+box.x+\",\"+box.y+\")[\"+box.width+\",\"+box.height+\"] \"\n\tvar str = el.type + ' ' + box.toString() + ' ';\n\tvar attrs = [];\n\tfor (var key in el.attrs) {\n\t\tif (el.attrs.hasOwnProperty(key)) {\n\t\t\tif (key === 'class')\n\t\t\t\tstr = el.attrs[key] + \" \" + str;\n\t\t\telse\n\t\t\t\tattrs.push(key+\": \"+el.attrs[key]);\n\t\t}\n\t}\n\tattrs.sort();\n\tstr += \"{ \" +attrs.join(\" \") + \" }\";\n\tthis.regressionLines.push(str);\n};\n\nmodule.exports = Renderer;\n"]},"metadata":{},"sourceType":"script"}