{"ast":null,"code":"var CreateSynthControl = require('./create-synth-control');\n\nvar CreateSynth = require('./create-synth');\n\nvar TimingCallbacks = require('../api/abc_timing_callbacks');\n\nfunction SynthController() {\n  var self = this;\n  self.warp = 100;\n  self.cursorControl = null;\n  self.visualObj = null;\n  self.timer = null;\n  self.midiBuffer = null;\n  self.options = null;\n  self.currentTempo = null;\n  self.control = null;\n  self.isLooping = false;\n  self.isStarted = false;\n  self.isLoaded = false;\n\n  self.load = function (selector, cursorControl, visualOptions) {\n    if (!visualOptions) visualOptions = {};\n    self.control = new CreateSynthControl(selector, {\n      loopHandler: visualOptions.displayLoop ? self.toggleLoop : undefined,\n      restartHandler: visualOptions.displayRestart ? self.restart : undefined,\n      playPromiseHandler: visualOptions.displayPlay ? self.play : undefined,\n      progressHandler: visualOptions.displayProgress ? self.randomAccess : undefined,\n      warpHandler: visualOptions.displayWarp ? self.onWarp : undefined,\n      afterResume: self.init\n    });\n    self.cursorControl = cursorControl;\n  };\n\n  self.setTune = function (visualObj, userAction, audioParams) {\n    self.isLoaded = false;\n    self.visualObj = visualObj;\n    self.options = audioParams;\n\n    if (self.control) {\n      self.pause();\n      self.setProgress(0, 1);\n      self.control.resetAll();\n      self.restart();\n      self.isStarted = false;\n    }\n\n    self.isLooping = false;\n    if (userAction) return self.go();else {\n      return Promise.resolve({\n        status: \"no-audio-context\"\n      });\n    }\n  };\n\n  self.go = function () {\n    var millisecondsPerMeasure = self.visualObj.millisecondsPerMeasure() * 100 / self.warp;\n    self.currentTempo = Math.round(self.visualObj.getBeatsPerMeasure() / millisecondsPerMeasure * 60000);\n    if (self.control) self.control.setTempo(self.currentTempo);\n    self.percent = 0;\n    if (!self.midiBuffer) self.midiBuffer = new CreateSynth();\n    return self.midiBuffer.init({\n      visualObj: self.visualObj,\n      options: self.options,\n      millisecondsPerMeasure: millisecondsPerMeasure\n    }).then(function () {\n      return self.midiBuffer.prime();\n    }).then(function () {\n      var subdivisions = 16;\n      if (self.cursorControl && self.cursorControl.beatSubdivisions !== undefined && parseInt(self.cursorControl.beatSubdivisions, 10) >= 1 && parseInt(self.cursorControl.beatSubdivisions, 10) <= 64) subdivisions = parseInt(self.cursorControl.beatSubdivisions, 10); // Need to create the TimingCallbacks after priming the midi so that the midi data is available for the callbacks.\n\n      self.timer = new TimingCallbacks(self.visualObj, {\n        beatCallback: self.beatCallback,\n        eventCallback: self.eventCallback,\n        lineEndCallback: self.lineEndCallback,\n        qpm: self.currentTempo,\n        extraMeasuresAtBeginning: self.cursorControl ? self.cursorControl.extraMeasuresAtBeginning : undefined,\n        lineEndAnticipation: self.cursorControl ? self.cursorControl.lineEndAnticipation : undefined,\n        beatSubdivisions: subdivisions\n      });\n      if (self.cursorControl && self.cursorControl.onReady && typeof self.cursorControl.onReady === 'function') self.cursorControl.onReady(self);\n      self.isLoaded = true;\n      return Promise.resolve({\n        status: \"created\"\n      });\n    });\n  };\n\n  self.destroy = function () {\n    if (self.timer) {\n      self.timer.reset();\n      self.timer.stop();\n      self.timer = null;\n    }\n\n    if (self.midiBuffer) {\n      self.midiBuffer.stop();\n      self.midiBuffer = null;\n    }\n\n    self.setProgress(0, 1);\n    if (self.control) self.control.resetAll();\n  };\n\n  self.play = function () {\n    if (!self.isLoaded) {\n      return self.go().then(function () {\n        return self._play();\n      });\n    } else return self._play();\n  };\n\n  self._play = function () {\n    self.isStarted = !self.isStarted;\n\n    if (self.isStarted) {\n      if (self.cursorControl && self.cursorControl.onStart && typeof self.cursorControl.onStart === 'function') self.cursorControl.onStart();\n      self.midiBuffer.start();\n      self.timer.start();\n      if (self.control) self.control.pushPlay(true);\n    } else {\n      self.pause();\n    }\n\n    return Promise.resolve({\n      status: \"ok\"\n    });\n  };\n\n  self.pause = function () {\n    if (self.timer) {\n      self.timer.pause();\n      self.midiBuffer.pause();\n      if (self.control) self.control.pushPlay(false);\n    }\n  };\n\n  self.toggleLoop = function () {\n    self.isLooping = !self.isLooping;\n    if (self.control) self.control.pushLoop(self.isLooping);\n  };\n\n  self.restart = function () {\n    if (self.timer) {\n      self.timer.setProgress(0);\n      self.midiBuffer.seek(0);\n    }\n  };\n\n  self.randomAccess = function (ev) {\n    if (!self.isLoaded) {\n      return self.go().then(function () {\n        return self._randomAccess(ev);\n      });\n    } else return self._randomAccess(ev);\n  };\n\n  self._randomAccess = function (ev) {\n    var background = ev.target.classList.contains('abcjs-midi-progress-indicator') ? ev.target.parentNode : ev.target;\n    var percent = (ev.x - background.offsetLeft) / background.offsetWidth;\n    if (percent < 0) percent = 0;\n    if (percent > 100) percent = 100;\n    self.timer.setProgress(percent);\n    self.midiBuffer.seek(percent);\n  };\n\n  self.onWarp = function (ev) {\n    var newWarp = ev.target.value;\n\n    if (parseInt(newWarp, 10) > 0) {\n      self.warp = parseInt(newWarp, 10);\n      var wasPlaying = self.isStarted;\n      var startPercent = self.percent;\n      self.destroy();\n      self.isStarted = false;\n      self.go().then(function () {\n        self.setProgress(startPercent, self.midiBuffer.duration * 1000);\n\n        if (wasPlaying) {\n          self.play();\n        }\n\n        self.timer.setProgress(startPercent);\n        self.midiBuffer.seek(startPercent);\n      });\n    }\n  };\n\n  self.setProgress = function (percent, totalTime) {\n    self.percent = percent;\n    if (self.control) self.control.setProgress(percent, totalTime);\n  };\n\n  self.finished = function () {\n    self.timer.reset();\n\n    if (self.isLooping) {\n      self.timer.start();\n      self.midiBuffer.start();\n    } else {\n      self.timer.stop();\n\n      if (self.isStarted) {\n        if (self.control) self.control.pushPlay(false);\n        self.isStarted = false;\n        if (self.cursorControl && self.cursorControl.onFinished && typeof self.cursorControl.onFinished === 'function') self.cursorControl.onFinished();\n        self.setProgress(0, 1);\n      }\n    }\n  };\n\n  self.beatCallback = function (beatNumber, totalBeats, totalTime) {\n    var percent = beatNumber / totalBeats;\n    self.setProgress(percent, totalTime);\n    if (self.cursorControl && self.cursorControl.onBeat && typeof self.cursorControl.onBeat === 'function') self.cursorControl.onBeat(beatNumber, totalBeats, totalTime);\n  };\n\n  self.eventCallback = function (event) {\n    if (event) {\n      if (self.cursorControl && self.cursorControl.onEvent && typeof self.cursorControl.onEvent === 'function') self.cursorControl.onEvent(event);\n    } else {\n      self.finished();\n    }\n  };\n\n  self.lineEndCallback = function (data) {\n    if (self.cursorControl && self.cursorControl.onLineEnd && typeof self.cursorControl.onLineEnd === 'function') self.cursorControl.onLineEnd(data);\n  };\n\n  self.getUrl = function () {\n    return self.midiBuffer.download();\n  };\n\n  self.download = function (fileName) {\n    var url = self.getUrl();\n    var link = document.createElement('a');\n    document.body.appendChild(link);\n    link.setAttribute(\"style\", \"display: none;\");\n    link.href = url;\n    link.download = fileName ? fileName : 'output.wav';\n    link.click();\n    window.URL.revokeObjectURL(url);\n    document.body.removeChild(link);\n  };\n}\n\nmodule.exports = SynthController;","map":{"version":3,"sources":["/home/elad/Desktop/Repos/drums-trainer/frontend/node_modules/react-sheet-music/node_modules/abcjs/src/synth/synth-controller.js"],"names":["CreateSynthControl","require","CreateSynth","TimingCallbacks","SynthController","self","warp","cursorControl","visualObj","timer","midiBuffer","options","currentTempo","control","isLooping","isStarted","isLoaded","load","selector","visualOptions","loopHandler","displayLoop","toggleLoop","undefined","restartHandler","displayRestart","restart","playPromiseHandler","displayPlay","play","progressHandler","displayProgress","randomAccess","warpHandler","displayWarp","onWarp","afterResume","init","setTune","userAction","audioParams","pause","setProgress","resetAll","go","Promise","resolve","status","millisecondsPerMeasure","Math","round","getBeatsPerMeasure","setTempo","percent","then","prime","subdivisions","beatSubdivisions","parseInt","beatCallback","eventCallback","lineEndCallback","qpm","extraMeasuresAtBeginning","lineEndAnticipation","onReady","destroy","reset","stop","_play","onStart","start","pushPlay","pushLoop","seek","ev","_randomAccess","background","target","classList","contains","parentNode","x","offsetLeft","offsetWidth","newWarp","value","wasPlaying","startPercent","duration","totalTime","finished","onFinished","beatNumber","totalBeats","onBeat","event","onEvent","data","onLineEnd","getUrl","download","fileName","url","link","document","createElement","body","appendChild","setAttribute","href","click","window","URL","revokeObjectURL","removeChild","module","exports"],"mappings":"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","sourcesContent":["var CreateSynthControl = require('./create-synth-control');\nvar CreateSynth = require('./create-synth');\nvar TimingCallbacks = require('../api/abc_timing_callbacks');\n\nfunction SynthController() {\n\tvar self = this;\n\tself.warp = 100;\n\tself.cursorControl = null;\n\tself.visualObj = null;\n\tself.timer = null;\n\tself.midiBuffer = null;\n\tself.options = null;\n\tself.currentTempo = null;\n\tself.control = null;\n\tself.isLooping = false;\n\tself.isStarted = false;\n\tself.isLoaded = false;\n\n\tself.load = function (selector, cursorControl, visualOptions) {\n\t\tif (!visualOptions)\n\t\t\tvisualOptions = {};\n\t\tself.control = new CreateSynthControl(selector, {\n\t\t\tloopHandler: visualOptions.displayLoop ? self.toggleLoop : undefined,\n\t\t\trestartHandler: visualOptions.displayRestart ? self.restart : undefined,\n\t\t\tplayPromiseHandler: visualOptions.displayPlay ? self.play : undefined,\n\t\t\tprogressHandler: visualOptions.displayProgress ? self.randomAccess : undefined,\n\t\t\twarpHandler: visualOptions.displayWarp ? self.onWarp : undefined,\n\t\t\tafterResume: self.init\n\t\t});\n\t\tself.cursorControl = cursorControl;\n\t};\n\n\tself.setTune = function(visualObj, userAction, audioParams) {\n\t\tself.isLoaded = false;\n\t\tself.visualObj = visualObj;\n\t\tself.options = audioParams;\n\n\t\tif (self.control) {\n\t\t\tself.pause();\n\t\t\tself.setProgress(0, 1);\n\t\t\tself.control.resetAll();\n\t\t\tself.restart();\n\t\t\tself.isStarted = false;\n\t\t}\n\t\tself.isLooping = false;\n\n\t\tif (userAction)\n\t\t\treturn self.go();\n\t\telse {\n\t\t\treturn Promise.resolve({status: \"no-audio-context\"});\n\t\t}\n\t};\n\n\tself.go = function () {\n\t\tvar millisecondsPerMeasure = self.visualObj.millisecondsPerMeasure() * 100 / self.warp;\n\t\tself.currentTempo = Math.round(self.visualObj.getBeatsPerMeasure() / millisecondsPerMeasure * 60000);\n\t\tif (self.control)\n\t\t\tself.control.setTempo(self.currentTempo);\n\t\tself.percent = 0;\n\n\t\tif (!self.midiBuffer)\n\t\t\tself.midiBuffer = new CreateSynth();\n\t\treturn self.midiBuffer.init({\n\t\t\tvisualObj: self.visualObj,\n\t\t\toptions: self.options,\n\t\t\tmillisecondsPerMeasure: millisecondsPerMeasure\n\t\t}).then(function () {\n\t\t\treturn self.midiBuffer.prime();\n\t\t}).then(function () {\n\t\t\tvar subdivisions = 16;\n\t\t\tif (self.cursorControl &&\n\t\t\t\tself.cursorControl.beatSubdivisions !== undefined &&\n\t\t\t\tparseInt(self.cursorControl.beatSubdivisions, 10) >= 1 &&\n\t\t\t\tparseInt(self.cursorControl.beatSubdivisions, 10) <= 64)\n\t\t\t\tsubdivisions = parseInt(self.cursorControl.beatSubdivisions, 10);\n\n\t\t\t// Need to create the TimingCallbacks after priming the midi so that the midi data is available for the callbacks.\n\t\t\tself.timer = new TimingCallbacks(self.visualObj, {\n\t\t\t\tbeatCallback: self.beatCallback,\n\t\t\t\teventCallback: self.eventCallback,\n\t\t\t\tlineEndCallback: self.lineEndCallback,\n\t\t\t\tqpm: self.currentTempo,\n\n\t\t\t\textraMeasuresAtBeginning: self.cursorControl ? self.cursorControl.extraMeasuresAtBeginning : undefined,\n\t\t\t\tlineEndAnticipation: self.cursorControl ? self.cursorControl.lineEndAnticipation : undefined,\n\t\t\t\tbeatSubdivisions: subdivisions,\n\t\t\t});\n\t\t\tif (self.cursorControl && self.cursorControl.onReady && typeof self.cursorControl.onReady  === 'function')\n\t\t\t\tself.cursorControl.onReady(self);\n\t\t\tself.isLoaded = true;\n\t\t\treturn Promise.resolve({ status: \"created\" });\n\t\t});\n\t};\n\n\tself.destroy = function () {\n\t\tif (self.timer) {\n\t\t\tself.timer.reset();\n\t\t\tself.timer.stop();\n\t\t\tself.timer = null;\n\t\t}\n\t\tif (self.midiBuffer) {\n\t\t\tself.midiBuffer.stop();\n\t\t\tself.midiBuffer = null;\n\t\t}\n\t\tself.setProgress(0, 1);\n\t\tif (self.control)\n\t\t\tself.control.resetAll();\n\t};\n\n\tself.play = function () {\n\t\tif (!self.isLoaded) {\n\t\t\treturn self.go().then(function() {\n\t\t\t\treturn self._play();\n\t\t\t});\n\t\t} else\n\t\t\treturn self._play();\n\t};\n\n\tself._play = function () {\n\t\tself.isStarted = !self.isStarted;\n\t\tif (self.isStarted) {\n\t\t\tif (self.cursorControl && self.cursorControl.onStart && typeof self.cursorControl.onStart  === 'function')\n\t\t\t\tself.cursorControl.onStart();\n\t\t\tself.midiBuffer.start();\n\t\t\tself.timer.start();\n\t\t\tif (self.control)\n\t\t\t\tself.control.pushPlay(true);\n\t\t} else {\n\t\t\tself.pause();\n\t\t}\n\t\treturn Promise.resolve({ status: \"ok\" });\n\t};\n\n\tself.pause = function() {\n\t\tif (self.timer) {\n\t\t\tself.timer.pause();\n\t\t\tself.midiBuffer.pause();\n\t\t\tif (self.control)\n\t\t\t\tself.control.pushPlay(false);\n\t\t}\n\t};\n\n\tself.toggleLoop = function () {\n\t\tself.isLooping = !self.isLooping;\n\t\tif (self.control)\n\t\t\tself.control.pushLoop(self.isLooping);\n\t};\n\n\tself.restart = function () {\n\t\tif (self.timer) {\n\t\t\tself.timer.setProgress(0);\n\t\t\tself.midiBuffer.seek(0);\n\t\t}\n\t};\n\n\tself.randomAccess = function (ev) {\n\t\tif (!self.isLoaded) {\n\t\t\treturn self.go().then(function() {\n\t\t\t\treturn self._randomAccess(ev);\n\t\t\t});\n\t\t} else\n\t\t\treturn self._randomAccess(ev);\n\t};\n\n\tself._randomAccess = function (ev) {\n\t\tvar background = (ev.target.classList.contains('abcjs-midi-progress-indicator')) ? ev.target.parentNode : ev.target;\n\t\tvar percent = (ev.x - background.offsetLeft) / background.offsetWidth;\n\t\tif (percent < 0)\n\t\t\tpercent = 0;\n\t\tif (percent > 100)\n\t\t\tpercent = 100;\n\t\tself.timer.setProgress(percent);\n\t\tself.midiBuffer.seek(percent);\n\t};\n\n\tself.onWarp = function (ev) {\n\t\tvar newWarp = ev.target.value;\n\t\tif (parseInt(newWarp, 10) > 0) {\n\t\t\tself.warp = parseInt(newWarp, 10);\n\t\t\tvar wasPlaying = self.isStarted;\n\t\t\tvar startPercent = self.percent;\n\t\t\tself.destroy();\n\t\t\tself.isStarted = false;\n\t\t\tself.go().then(function () {\n\t\t\t\tself.setProgress(startPercent, self.midiBuffer.duration * 1000);\n\t\t\t\tif (wasPlaying) {\n\t\t\t\t\tself.play();\n\t\t\t\t}\n\t\t\t\tself.timer.setProgress(startPercent);\n\t\t\t\tself.midiBuffer.seek(startPercent);\n\t\t\t});\n\t\t}\n\t};\n\n\tself.setProgress = function (percent, totalTime) {\n\t\tself.percent = percent;\n\t\tif (self.control)\n\t\t\tself.control.setProgress(percent, totalTime);\n\t};\n\n\tself.finished = function () {\n\t\tself.timer.reset();\n\t\tif (self.isLooping) {\n\t\t\tself.timer.start();\n\t\t\tself.midiBuffer.start();\n\t\t} else {\n\t\t\tself.timer.stop();\n\t\t\tif (self.isStarted) {\n\t\t\t\tif (self.control)\n\t\t\t\t\tself.control.pushPlay(false);\n\t\t\t\tself.isStarted = false;\n\t\t\t\tif (self.cursorControl && self.cursorControl.onFinished && typeof self.cursorControl.onFinished  === 'function')\n\t\t\t\t\tself.cursorControl.onFinished();\n\t\t\t\tself.setProgress(0, 1);\n\t\t\t}\n\t\t}\n\t};\n\n\tself.beatCallback = function (beatNumber, totalBeats, totalTime) {\n\t\tvar percent = beatNumber / totalBeats;\n\t\tself.setProgress(percent, totalTime);\n\t\tif (self.cursorControl && self.cursorControl.onBeat && typeof self.cursorControl.onBeat  === 'function')\n\t\t\tself.cursorControl.onBeat(beatNumber, totalBeats, totalTime);\n\t};\n\n\tself.eventCallback = function (event) {\n\t\tif (event) {\n\t\t\tif (self.cursorControl && self.cursorControl.onEvent && typeof self.cursorControl.onEvent  === 'function')\n\t\t\t\tself.cursorControl.onEvent(event);\n\t\t} else {\n\t\t\tself.finished();\n\t\t}\n\t};\n\n\tself.lineEndCallback = function (data) {\n\t\tif (self.cursorControl && self.cursorControl.onLineEnd && typeof self.cursorControl.onLineEnd  === 'function')\n\t\t\tself.cursorControl.onLineEnd(data);\n\t};\n\n\tself.getUrl = function () {\n\t\treturn self.midiBuffer.download();\n\t};\n\n\tself.download = function(fileName) {\n\t\tvar url = self.getUrl();\n\t\tvar link = document.createElement('a');\n\t\tdocument.body.appendChild(link);\n\t\tlink.setAttribute(\"style\",\"display: none;\");\n\t\tlink.href = url;\n\t\tlink.download = fileName ? fileName : 'output.wav';\n\t\tlink.click();\n\t\twindow.URL.revokeObjectURL(url);\n\t\tdocument.body.removeChild(link);\n\t};\n}\n\nmodule.exports = SynthController;\n"]},"metadata":{},"sourceType":"script"}